<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wingman Command Center - Trading HQ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e6f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .dashboard-header {
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px 40px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1400px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { font-size: 2em; background: linear-gradient(45deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .status-badge { display: flex; align-items: center; gap: 10px; font-size: 0.9em; color: #10b981; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background: #10b981; box-shadow: 0 0 6px rgba(16, 185, 129, 0.8); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .grid.full-width { grid-template-columns: 1fr; }
        .grid.two-column { grid-template-columns: repeat(2, 1fr); }
        .card {
            background: rgba(26, 31, 58, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px; padding: 24px; backdrop-filter: blur(10px);
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.4), transparent); }
        .card:hover { border-color: rgba(99, 102, 241, 0.4); box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2); }
        .card-title { font-size: 1.1em; font-weight: 600; color: #e0e6f0; }
        .card-value { font-size: 2em; font-weight: 700; background: linear-gradient(45deg, #6366f1, #8b5cf6); -webkit-background-clip: text;
            background-clip: text; -webkit-text-fill-color: transparent; }
        .card-detail { font-size: 0.9em; color: #9ca3af; margin-top: 8px; }
        .metric-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(99, 102, 241, 0.1); align-items: center; }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: #9ca3af; font-size: 0.95em; }
        .metric-value { font-weight: 600; color: #e0e6f0; }
        .metric-value.positive { color: #10b981; }
        .metric-value.negative { color: #ef4444; }
        .signal-score-large { text-align: center; padding: 30px 0; }
        .signal-number { font-size: 3.5em; font-weight: 700; background: linear-gradient(45deg, #6366f1, #8b5cf6); -webkit-background-clip: text;
            background-clip: text; -webkit-text-fill-color: transparent; }
        .signal-tier { font-size: 1.3em; font-weight: 600; color: #9ca3af; margin-top: 10px; }
        .signal-tier.strong { color: #10b981; } .signal-tier.moderate { color: #f59e0b; }
        .signal-tier.weak, .signal-tier.avoid { color: #ef4444; }
        .trade-item { background: rgba(99, 102, 241, 0.08); border-left: 3px solid #6366f1; padding: 16px; border-radius: 8px; margin-bottom: 12px; }
        .trade-item.loss { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.08); }
        .trade-item.win { border-left-color: #10b981; background: rgba(16, 185, 129, 0.08); }
        .trade-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .trade-symbol { font-weight: 700; color: #e0e6f0; font-size: 1.05em; }
        .trade-pnl { font-weight: 700; color: #10b981; }
        .trade-pnl.loss { color: #ef4444; }
        .trade-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #9ca3af; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
        .btn { flex: 1; min-width: 120px; padding: 10px 16px; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background: linear-gradient(45deg, #6366f1, #8b5cf6); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: rgba(99, 102, 241, 0.15); color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.3); }
        .btn-secondary:hover { background: rgba(99, 102, 241, 0.25); }
        .command-reference { display: flex; flex-direction: column; gap: 14px; }
        details.command-group { background: rgba(99, 102, 241, 0.08); border: 1px solid rgba(99, 102, 241, 0.15); border-radius: 10px; padding: 14px 18px; }
        details.command-group[open] { border-color: rgba(99, 102, 241, 0.4); }
        details.command-group summary { cursor: pointer; font-weight: 600; color: #e0e6f0; outline: none; }
        details.command-group summary::-webkit-details-marker { display: none; }
        details.command-group summary::after { content: '▾'; float: right; transition: transform 0.2s ease; color: #9ca3af; }
        details.command-group[open] summary::after { transform: rotate(180deg); }
        .command-list { list-style: none; margin: 12px 0 0; padding: 0; display: flex; flex-direction: column; gap: 8px; }
        .command-list li { color: #9ca3af; font-size: 0.9em; line-height: 1.5; }
        .command-list code { background: rgba(99, 102, 241, 0.18); color: #e0e6f0; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; }
        .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
        .empty-state-icon { font-size: 3em; margin-bottom: 16px; opacity: 0.5; }
        /* Portfolio */
        .progress-wrap { background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3); border-radius: 10px; height: 12px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #84cc16); transition: width 0.5s ease; }
        .portfolio-section-heading { margin-top: 18px; font-weight: 600; color: #e0e6f0; display: flex; align-items: center; justify-content: space-between; }
        .positions-empty { margin-top: 10px; color: #9ca3af; font-size: 0.9em; }
        .holdings-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .holdings-table th, .holdings-table td { padding: 8px 10px; text-align: left; font-size: 0.9em; color: #e0e6f0; border-bottom: 1px solid rgba(99, 102, 241, 0.12); }
        .holdings-table th { font-weight: 600; color: #c7d2fe; background: rgba(99, 102, 241, 0.12); }
        .holdings-table tbody tr:nth-child(even) { background: rgba(99, 102, 241, 0.06); }
        .value-positive { color: #10b981; }
        .value-negative { color: #ef4444; }
        .wallet-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .wallet-table th, .wallet-table td { border-bottom: 1px solid rgba(99,102,241,0.15); padding: 10px 8px; text-align: left; font-size: 0.92em; }
        .wallet-table th { color: #9ca3af; font-weight: 600; }
        .addr { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color: #a5b4fc; }
        .inline-form { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .input, .select {
            background: rgba(255,255,255,0.04); color: #e5e7eb; border: 1px solid rgba(99,102,241,0.35);
            border-radius: 8px; padding: 8px 10px; font-size: 0.95em; outline: none; min-width: 120px;
        }
        .small { min-width: 90px; }
        .danger { background: rgba(239,68,68,0.15); color: #fecaca; border: 1px solid rgba(239,68,68,0.35); }
        .muted { color: #9ca3af; font-size: 0.9em; }

        /* Verification Indicator (green dot) */
        .verification-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 8px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .verification-indicator.status-ok { background: #10b981; box-shadow: 0 0 6px rgba(16, 185, 129, 0.8); }
        .verification-indicator.status-warning { background: #f59e0b; box-shadow: 0 0 6px rgba(245, 158, 11, 0.8); }
        .verification-indicator.status-error { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.8); animation: pulse 2s infinite; }
        .verification-indicator:hover { transform: scale(1.3); }
        .verification-tooltip { display: none; position: absolute; top: 25px; right: -50px; background: rgba(26, 31, 58, 0.95); border: 1px solid rgba(99, 102, 241, 0.3); padding: 10px 15px; border-radius: 8px; font-size: 0.85em; color: #e0e6f0; white-space: nowrap; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .verification-indicator:hover .verification-tooltip { display: block; }

        /* Signal Delta */
        .signal-delta { font-size: 1.1em; font-weight: 600; text-align: center; margin-top: 8px; }
        .signal-delta.positive { color: #10b981; }
        .signal-delta.negative { color: #ef4444; }
        .signal-delta.neutral { color: #9ca3af; }

        /* Signal Breakdown */
        .signal-breakdown { margin-top: 20px; }
        .breakdown-title { font-size: 0.95em; font-weight: 600; color: #9ca3af; margin-bottom: 12px; text-align: center; }
        .breakdown-grid { display: flex; flex-direction: column; gap: 12px; }
        .breakdown-item { display: flex; align-items: center; gap: 8px; }
        .breakdown-label { font-size: 0.85em; color: #9ca3af; min-width: 120px; }
        .breakdown-bar-container { flex: 1; background: rgba(99, 102, 241, 0.15); border-radius: 8px; height: 12px; overflow: hidden; }
        .breakdown-bar { height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); transition: width 0.5s ease; border-radius: 8px; }
        .breakdown-value { font-size: 0.85em; color: #e0e6f0; font-weight: 600; min-width: 40px; text-align: right; }

        @media (max-width: 768px) { .grid.two-column { grid-template-columns: 1fr; } h1 { font-size: 1.5em; } .signal-number { font-size: 2.5em; } }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-content">
            <h1>Wingman Command Center</h1>
            <div class="status-badge">
                <span class="status-dot"></span>
                <span>OPERATIONAL</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ROW 1: TRADING SIGNAL SCORE & ACCOUNT STATUS -->
        <div class="grid two-column">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        Trading Signal Score
                        <span class="verification-indicator status-ok" id="signal-indicator">
                            <span class="verification-tooltip" id="signal-tooltip">
                                Last updated: Loading...<br>
                                Data status: Checking...
                            </span>
                        </span>
                    </div>
                </div>
                <div class="signal-score-large">
                    <div class="signal-number" id="signal-score">--</div>
                    <div class="signal-tier" id="signal-tier">--</div>
                    <div class="signal-delta" id="signal-delta"></div>
                </div>
                <div class="signal-breakdown" id="signal-breakdown">
                    <div class="breakdown-title">Score Breakdown</div>
                    <div class="breakdown-grid" id="breakdown-grid">
                        <!-- Breakdown bars will be populated here -->
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Account Status</div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Balance</span>
                    <span class="metric-value" id="account-balance">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Available Cash</span>
                    <span class="metric-value" id="account-cash">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">YTD P/L</span>
                    <span class="metric-value positive" id="account-ytd">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Positions Open</span>
                    <span class="metric-value" id="account-positions">0</span>
                </div>
            </div>
        </div>

        <!-- ROW 2: TODAY'S P/L (FULL WIDTH) -->
        <div class="grid full-width">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Today's P/L</div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total</span>
                    <span class="metric-value" id="today-pnl">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Trades</span>
                    <span class="metric-value" id="today-trades">0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Wins / Losses</span>
                    <span class="metric-value" id="today-winloss">0 / 0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Win Rate</span>
                    <span class="metric-value" id="today-winrate">--</span>
                </div>
            </div>
        </div>

        <!-- ROW 3: LATEST TRADE -->
        <div class="grid full-width">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Latest Trade</div>
                </div>
                <div id="latest-trade-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div>No trades recorded yet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 4: RECENT TRADES -->
        <div class="grid full-width">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Recent Trade History</div>
                </div>
                <div id="recent-trades-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">📈</div>
                        <div>No recent trades</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 5: COMMAND REFERENCE -->
        <div class="grid full-width">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Wingman Command Reference</div>
                </div>
                <div class="command-reference">
                    <details class="command-group" open>
                        <summary>System Status &amp; Intelligence</summary>
                        <ul class="command-list">
                            <li><code>wingman, status</code> — Full system readout for account, positions, and signal.</li>
                            <li><code>wingman, signal</code> — Current market signal with tier and probability score.</li>
                            <li><code>wingman, rules</code> — Active trading rules with enforcement notes.</li>
                            <li><code>wingman, levels [TICKER]</code> — Support and resistance pulled from the live cache.</li>
                            <li><code>wingman, cache status</code> — Collector heartbeat, freshness, and tracked tickers.</li>
                            <li><code>wingman, account rules</code> — Position sizing limits, risk thresholds, and loss limits.</li>
                        </ul>
                    </details>
                    <details class="command-group">
                        <summary>Analysis &amp; Decision Engine</summary>
                        <ul class="command-list">
                            <li><code>wingman, analyze [TICKER]</code> — Full probability breakdown with entry, stop, and target.</li>
                            <li><code>wingman, quick analyze [TICKER]</code> — Fast verdict with BUY/WAIT/AVOID and probability.</li>
                            <li><code>wingman, compare NVDA TSLA AAPL</code> — Rank multiple tickers by setup strength.</li>
                            <li><code>wingman, analyze watchlist</code> — Analyze every tracked symbol in priority order.</li>
                        </ul>
                    </details>
                    <details class="command-group">
                        <summary>Trade Operations</summary>
                        <ul class="command-list">
                            <li><code>NVDA long 100 @ 189.50, stop 188, target 192</code> — Log an entry and trigger threat assessment.</li>
                            <li><code>Out at [PRICE]</code> — Close an open position and record realized P/L.</li>
                            <li><code>Stop loss hit [PRICE]</code> — Record a stop-out event for the current position.</li>
                            <li><code>Target hit [PRICE]</code> — Record a target fill and update logs.</li>
                            <li><code>Partial out [SIZE] at [PRICE]</code> — Take partial profits while leaving the rest open.</li>
                        </ul>
                    </details>
                    <details class="command-group">
                        <summary>Data Collection Control</summary>
                        <ul class="command-list">
                            <li><code>wingman recon</code> — Run all market data scrapers (YouTube, RSS, X/Twitter, Technical) - takes ~2 min.</li>
                            <li><code>wingmap prep</code> — Execute full research workflow: summaries, overviews, signals calculation - takes ~30-45 min.</li>
                            <li><code>wingman dash</code> — Update dashboard with research data: master plan sync, tabs update - takes ~20-25 min.</li>
                            <li><code>wingman, start collector</code> — Launch the background data daemon (5 minute cadence).</li>
                            <li><code>wingman, stop collector</code> — Stop the collector while keeping cache data intact.</li>
                            <li><code>wingman, restart collector</code> — Cycle the collector to refresh connections.</li>
                            <li><code>wingman, add ticker TSLA</code> — Add a custom symbol to the watchlist.</li>
                            <li><code>wingman, remove ticker TSLA</code> — Remove a custom symbol (core tickers locked).</li>
                            <li><code>wingman, show watchlist</code> — Display every ticker currently tracked.</li>
                        </ul>
                    </details>
                    <details class="command-group">
                        <summary>Workflows &amp; Reporting</summary>
                        <ul class="command-list">
                            <li><code>wingman, run research</code> — Full research workflow across tracked tickers.</li>
                            <li><code>wingman, eod wrap</code> — End-of-day summary, trade ledger, and journal updates.</li>
                            <li><code>wingman, review performance [PERIOD]</code> — Performance breakdown for day/week/month.</li>
                            <li><code>Note: [your text]</code> — Capture session notes inline with the live log.</li>
                        </ul>
                    </details>
                </div>
            </div>
        </div>

        <!-- ROW 6: PORTFOLIO (NEW) -->
        <div class="grid full-width">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Portfolio (Manual + Wallets)</div>
                    <div class="button-group" style="flex:0 0 auto; width:auto; gap:8px;">
                        <button class="btn btn-secondary" onclick="openSetTotals()">✏️ Totals</button>
                        <button class="btn btn-secondary" onclick="openAddWallet()">➕ Wallet</button>
                        <button class="btn btn-secondary" onclick="exportPortfolio()">⤴︎ Export</button>
                        <label class="btn btn-secondary" for="import-file" style="cursor:pointer;">⤵︎ Import</label>
                        <input id="import-file" type="file" accept="application/json" style="display:none" onchange="importPortfolio(this.files[0])">
                    </div>
                </div>

                <div class="grid two-column">
                    <!-- Summary -->
                    <div class="card" style="margin:0;">
                        <div class="card-header">
                            <div class="card-title">Summary</div>
                            <div class="card-value" id="portfolio-total">$0</div>
                        </div>
                        <div class="metric-row"><span class="metric-label">Cash</span><span class="metric-value" id="sum-cash">$0</span></div>
                        <div class="metric-row"><span class="metric-label">Stocks</span><span class="metric-value" id="sum-stocks">$0</span></div>
                        <div class="metric-row"><span class="metric-label">Crypto (wallets)</span><span class="metric-value" id="sum-crypto">$0</span></div>
                        <div class="metric-row"><span class="metric-label">Monthly Goal</span><span class="metric-value" id="sum-goal">$2,600</span></div>
                        <div class="metric-row">
                            <span class="metric-label">Goal Coverage</span>
                            <span class="metric-value" id="sum-coverage">0%</span>
                        </div>
                        <div class="progress-wrap" title="Goal coverage">
                            <div class="progress-bar" id="goal-bar"></div>
                        </div>
                        <div class="card-detail muted" id="portfolio-updated">Last updated: --</div>
                        <div class="card-detail muted" id="portfolio-source">Source: --</div>
                        <div class="portfolio-section-heading">Open Stock Positions</div>
                        <div id="stock-positions-empty" class="positions-empty">No open stock positions.</div>
                        <table class="holdings-table" id="stock-positions-table" style="display:none;">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Shares</th>
                                    <th>Avg Price</th>
                                    <th>Value</th>
                                    <th>P/L</th>
                                </tr>
                            </thead>
                            <tbody id="stock-positions-body"></tbody>
                        </table>
                    </div>

                    <!-- Wallets -->
                    <div class="card" style="margin:0;">
                        <div class="card-header">
                            <div class="card-title">Crypto Wallets</div>
                        </div>
                        <table class="wallet-table" id="wallet-table">
                            <thead>
                                <tr>
                                    <th>Label</th>
                                    <th>Network</th>
                                    <th>Address</th>
                                    <th style="text-align:right;">Value (USD)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="wallet-rows">
                                <tr><td colspan="5" class="muted">No wallets yet. Click “➕ Wallet”.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Hidden Forms -->
                <div id="forms-area" style="margin-top:8px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== Existing Dashboard Logic =====
        async function refreshDashboard() {
            try {
                const response = await fetch('./.session_state.json');
                const state = await response.json();

                // Update Trading Signal Score panel
                updateTradingSignalScore(state.market);

                // Update Account Status
                const balance = state.account?.balance || 0;
                const cash = state.account?.cash || 0;
                const ytdPl = state.account?.ytd_pl || 0;
                const positionsCount = Array.isArray(state.positions?.positions)
                    ? state.positions.positions.length
                    : (typeof state.positions?.open_count === 'number'
                        ? state.positions.open_count
                        : (Array.isArray(state.account?.positions) ? state.account.positions.length : 0));
                document.getElementById('account-balance').textContent = `$${balance.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                document.getElementById('account-cash').textContent = `$${cash.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                document.getElementById('account-ytd').textContent = `$${ytdPl.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                document.getElementById('account-positions').textContent = positionsCount;

                // Update Today's P/L
                const todayPnl = state.account?.today_pnl || 0;
                const todayPnlElement = document.getElementById('today-pnl');
                todayPnlElement.textContent = `$${Math.abs(todayPnl).toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                todayPnlElement.className = `metric-value ${todayPnl >= 0 ? 'positive' : 'negative'}`;
                const recentTrades = state.account?.recent_trades || [];
                document.getElementById('today-trades').textContent = recentTrades.length;

                // Update Latest Trade and Recent Trades
                if (state.journal_feed?.last_entry) { updateLatestTrade(state.journal_feed.last_entry); }
                updateRecentTrades(recentTrades);
            } catch (error) { console.error('Error refreshing dashboard:', error); }
        }

        function updateTradingSignalScore(market) {
            if (!market) return;

            const signalScore = market.signal_score || 0;
            const signalTier = market.signal_tier || 'UNKNOWN';
            const delta = market.delta || 0;
            const breakdown = market.breakdown || {};
            const lastUpdated = market.last_updated;

            // Update composite score
            document.getElementById('signal-score').textContent = signalScore.toFixed(1);
            document.getElementById('signal-tier').textContent = signalTier;
            document.getElementById('signal-tier').className = `signal-tier ${signalTier.toLowerCase().replace(/\s+/g, '-')}`;

            // Update delta
            const deltaEl = document.getElementById('signal-delta');
            if (delta !== 0) {
                const deltaText = delta > 0 ? `+${delta.toFixed(1)}` : delta.toFixed(1);
                deltaEl.textContent = deltaText;
                deltaEl.className = delta > 0 ? 'signal-delta positive' : delta < 0 ? 'signal-delta negative' : 'signal-delta neutral';
            } else {
                deltaEl.textContent = '';
            }

            // Update breakdown bars
            const components = [
                { key: 'trend', label: 'Trend', weight: 40 },
                { key: 'breadth', label: 'Breadth', weight: 25 },
                { key: 'volatility', label: 'Volatility', weight: 20 },
                { key: 'technical', label: 'Technical', weight: 10 },
                { key: 'seasonality', label: 'Seasonality', weight: 5 }
            ];

            const breakdownGrid = document.getElementById('breakdown-grid');
            breakdownGrid.innerHTML = '';

            components.forEach(component => {
                const value = breakdown[component.key] || 0;
                const percentage = component.weight ? Math.max(0, Math.min(100, (value / component.weight) * 100)) : 0;

                const item = document.createElement('div');
                item.className = 'breakdown-item';
                item.innerHTML = `
                    <span class="breakdown-label">${component.label} (${component.weight}%)</span>
                    <div class="breakdown-bar-container">
                        <div class="breakdown-bar" style="width: ${percentage}%"></div>
                    </div>
                    <span class="breakdown-value">${value.toFixed(1)}</span>
                `;
                breakdownGrid.appendChild(item);
            });

            // Update verification indicator
            updateDataFreshness(lastUpdated);
        }

        function updateDataFreshness(lastUpdated) {
            const indicator = document.getElementById('signal-indicator');
            const tooltip = document.getElementById('signal-tooltip');

            if (!lastUpdated || lastUpdated === 'unknown') {
                indicator.className = 'verification-indicator status-error';
                tooltip.innerHTML = 'Last updated: Unknown<br>Data status: NO DATA';
                return;
            }

            const updateTime = new Date(lastUpdated);
            const now = new Date();
            const hoursOld = (now - updateTime) / (1000 * 60 * 60);

            let status, statusText;
            if (hoursOld < 6) {
                status = 'status-ok';
                statusText = 'FRESH';
            } else if (hoursOld < 24) {
                status = 'status-warning';
                statusText = 'AGING';
            } else {
                status = 'status-error';
                statusText = 'STALE';
            }

            indicator.className = `verification-indicator ${status}`;

            const timeStr = updateTime.toLocaleString('en-US', {
                month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit', hour12: true
            });
            const hoursStr = hoursOld < 1 ? `${Math.round(hoursOld * 60)} min` : `${Math.round(hoursOld)} hours`;

            tooltip.innerHTML = `Last updated: ${timeStr}<br>Data is ${statusText} (${hoursStr} old)`;
        }
        function updateLatestTrade(entry) {
            const container = document.getElementById('latest-trade-container');
            if (!entry || !entry.symbol) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><div>No trades recorded yet</div></div>';
                return;
            }
            const pnl = entry.pnl || 0;
            const isProfitable = pnl >= 0;
            const html = `
                <div class="trade-item ${isProfitable ? 'win' : 'loss'}">
                    <div class="trade-header">
                        <span class="trade-symbol">${entry.symbol}</span>
                        <span class="trade-pnl ${isProfitable ? '' : 'loss'}">${isProfitable ? '+' : '-'}$${Math.abs(pnl).toLocaleString('en-US', {maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="trade-meta">
                        <span>Entry: $${entry.entry?.toLocaleString('en-US', {maximumFractionDigits: 2}) || '--'}</span>
                        <span>${entry.time || '--'}</span>
                    </div>
                    <div class="card-detail" style="margin-top: 10px;">
                        ${entry.raw_notes ? entry.raw_notes.substring(0, 150) + '...' : 'No notes'}
                    </div>
                    <div class="card-detail">Setup: ${entry.setup_type || '--'} | State: ${entry.emotional_state || '--'}</div>
                </div>`;
            container.innerHTML = html;
        }
        function updateRecentTrades(trades) {
            const container = document.getElementById('recent-trades-container');
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📈</div><div>No recent trades</div></div>';
                return;
            }
            let html = '';
            trades.forEach(trade => {
                const pnl = trade.pnl || 0;
                const isProfitable = pnl >= 0;
                html += `
                    <div class="trade-item ${isProfitable ? 'win' : 'loss'}">
                        <div class="trade-header">
                            <span class="trade-symbol">${trade.symbol}</span>
                            <span class="trade-pnl ${isProfitable ? '' : 'loss'}">${isProfitable ? '+' : '-'}$${Math.abs(pnl).toLocaleString('en-US', {maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="trade-meta">
                            <span>${trade.date || '--'}</span>
                            <span>${trade.setup_type || '--'}</span>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }
        // ===== Portfolio Logic (NEW) =====
        const DEFAULT_PORTFOLIO = {
            goal: 2600,    // $2,500 living + $100 Claude
            stocks: 0,
            cash: 0,
            wallets: [],
            updated_at: null,
            positions: [],
            crypto_total: 0,
            total_balance: 0,
            source: 'manual overrides'
        };

        const pickNumber = (...values) => {
            for (const value of values) {
                if (value === null || value === undefined) continue;
                const num = Number(value);
                if (!Number.isNaN(num) && Number.isFinite(num)) {
                    return num;
                }
            }
            return 0;
        };

        const normalizePosition = (raw, fallbackLabel = 'Position') => {
            if (!raw || typeof raw !== 'object') return null;
            const symbol = raw.symbol || raw.ticker || raw.asset || raw.label || fallbackLabel;
            const side = raw.direction || raw.side || raw.type || raw.position_type || '';
            const sharesValue = raw.shares ?? raw.quantity ?? raw.qty ?? raw.units ?? null;
            const basisValue = raw.avg_price ?? raw.average_price ?? raw.cost_basis ?? raw.entry ?? raw.price ?? null;
            const valueValue = raw.market_value ?? raw.amount ?? raw.value ?? raw.total_value ?? null;
            const unrealizedValue = raw.unrealized_pl ?? raw.unrealized ?? raw.pnl ?? raw.current_pl ?? null;
            return {
                symbol,
                side,
                shares: sharesValue !== null && sharesValue !== undefined && !Number.isNaN(Number(sharesValue)) ? Number(sharesValue) : null,
                basis: basisValue !== null && basisValue !== undefined && !Number.isNaN(Number(basisValue)) ? Number(basisValue) : null,
                value: valueValue !== null && valueValue !== undefined && !Number.isNaN(Number(valueValue)) ? Number(valueValue) : null,
                unrealized: unrealizedValue !== null && unrealizedValue !== undefined && !Number.isNaN(Number(unrealizedValue)) ? Number(unrealizedValue) : null,
                note: raw.note || raw.comment || ''
            };
        };

        async function safeFetchJson(path) {
            try {
                const response = await fetch(path, { cache: 'no-store' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.warn(`Could not load ${path}`, error);
                return null;
            }
        }

        async function loadPortfolio() {
            const [sessionState, accountState] = await Promise.all([
                safeFetchJson('./.session_state.json'),
                safeFetchJson('./account_state.json')
            ]);

            let manual = { ...DEFAULT_PORTFOLIO };

            if (sessionState?.portfolio) {
                const portfolio = sessionState.portfolio;
                manual.goal = Number(portfolio.monthly_goal) || manual.goal;
                manual.stocks = Number(portfolio.manual_totals?.stocks) || manual.stocks;
                manual.cash = Number(portfolio.manual_totals?.cash) || manual.cash;
                manual.wallets = Array.isArray(portfolio.crypto_wallets) ? portfolio.crypto_wallets : manual.wallets;
                manual.updated_at = portfolio.last_updated || manual.updated_at;
            }

            try {
                const stored = localStorage.getItem('portfolioState');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed && typeof parsed === 'object') {
                        manual.goal = Number(parsed.goal) || manual.goal;
                        manual.stocks = Number(parsed.stocks) || manual.stocks;
                        manual.cash = Number(parsed.cash) || manual.cash;
                        manual.wallets = Array.isArray(parsed.wallets) ? parsed.wallets : manual.wallets;
                        manual.updated_at = parsed.updated_at || manual.updated_at;
                    }
                }
            } catch (error) {
                console.warn('Unable to parse stored portfolioState.', error);
            }

            const wallets = Array.isArray(manual.wallets) ? manual.wallets : [];
            const cryptoTotal = wallets.reduce((acc, w) => acc + (Number(w.usd) || 0), 0);

            const cashAmount = pickNumber(
                accountState?.positions?.cash?.amount,
                accountState?.account?.cash_and_sweep,
                manual.cash
            );

            const stockAmount = pickNumber(
                accountState?.positions?.equities?.amount,
                manual.stocks
            );

            const totalBalance = pickNumber(
                accountState?.account?.total_balance,
                cashAmount + stockAmount + cryptoTotal
            );

            const positions = [];
            const sessionPositions = sessionState?.positions?.positions;
            if (Array.isArray(sessionPositions) && sessionPositions.length) {
                sessionPositions.forEach(pos => {
                    const normalized = normalizePosition(pos);
                    if (normalized) positions.push(normalized);
                });
            } else {
                const equities = accountState?.positions?.equities;
                if (equities && (equities.ticker || equities.amount || equities.shares)) {
                    const normalized = normalizePosition({
                        ...equities,
                        symbol: equities.ticker || equities.symbol || 'Equity'
                    }, 'Equity');
                    if (normalized) positions.push(normalized);
                }
                const hedges = accountState?.positions?.hedges?.positions;
                if (Array.isArray(hedges) && hedges.length) {
                    hedges.forEach(raw => {
                        const normalized = normalizePosition(raw, 'Hedge');
                        if (normalized) positions.push(normalized);
                    });
                }
            }

            const updatedAt = accountState?.last_updated || manual.updated_at || sessionState?.last_updated || null;
            const source = accountState ? 'account_state.json' : 'manual overrides';

            return {
                goal: manual.goal,
                stocks: stockAmount,
                cash: cashAmount,
                wallets,
                updated_at: updatedAt,
                positions,
                crypto_total: cryptoTotal,
                total_balance: totalBalance,
                source
            };
        }

        async function savePortfolio(state) {
            state.updated_at = new Date().toISOString();

            try {
                const response = await fetch('./.session_state.json');
                const sessionState = await response.json();

                sessionState.portfolio = {
                    monthly_goal: state.goal,
                    crypto_wallets: state.wallets,
                    manual_totals: {
                        stocks: state.stocks,
                        cash: state.cash
                    },
                    last_updated: state.updated_at
                };
                sessionState.last_updated = state.updated_at;

                localStorage.setItem('portfolioState', JSON.stringify({
                    goal: state.goal,
                    stocks: state.stocks,
                    cash: state.cash,
                    wallets: state.wallets,
                    updated_at: state.updated_at
                }));
                console.warn('Portfolio saved to localStorage. Server-side save not yet implemented.');
                console.log('Portfolio state to save:', sessionState.portfolio);

                renderPortfolio();
            } catch(e) {
                console.error('Error saving portfolio:', e);
                localStorage.setItem('portfolioState', JSON.stringify({
                    goal: state.goal,
                    stocks: state.stocks,
                    cash: state.cash,
                    wallets: state.wallets,
                    updated_at: state.updated_at
                }));
                renderPortfolio();
            }
        }
        
        async function renderPortfolio() {
            const s = await loadPortfolio();

            const fmtCurrency = (n) => `$${Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: 2 })}`;
            const fmtOptionalCurrency = (value) => (value === null || value === undefined || value === '' || Number.isNaN(Number(value))) ? '--' : fmtCurrency(Number(value));
            const fmtShares = (value) => (value === null || value === undefined || value === '' || Number.isNaN(Number(value))) ? '--' : Number(value).toLocaleString('en-US', { maximumFractionDigits: 2 });

            const cash = Number(s.cash) || 0;
            const stocks = Number(s.stocks) || 0;
            const crypto = typeof s.crypto_total === 'number' ? s.crypto_total : s.wallets.reduce((acc, w) => acc + (Number(w.usd) || 0), 0);
            const goal = Number(s.goal) || 0;
            const totalBalance = Number(s.total_balance) || (cash + stocks + crypto);
            const coverageRaw = goal > 0 ? (totalBalance / goal) * 100 : 0;
            const coverage = Math.max(0, Math.min(100, coverageRaw));

            document.getElementById('sum-cash').textContent = fmtCurrency(cash);
            document.getElementById('sum-stocks').textContent = fmtCurrency(stocks);
            document.getElementById('sum-crypto').textContent = fmtCurrency(crypto);
            document.getElementById('sum-goal').textContent = fmtCurrency(goal);
            document.getElementById('portfolio-total').textContent = fmtCurrency(totalBalance);
            document.getElementById('sum-coverage').textContent = goal > 0 ? `${coverage.toFixed(1)}%` : '--';
            document.getElementById('goal-bar').style.width = `${goal > 0 ? coverage : 0}%`;

            const updatedText = s.updated_at ? new Date(s.updated_at).toLocaleString() : '--';
            document.getElementById('portfolio-updated').textContent = `Last updated: ${updatedText}`;
            document.getElementById('portfolio-source').textContent = `Source: ${s.source || 'manual overrides'}`;

            const positionsTable = document.getElementById('stock-positions-table');
            const positionsBody = document.getElementById('stock-positions-body');
            const positionsEmpty = document.getElementById('stock-positions-empty');

            if (s.positions.length === 0) {
                positionsTable.style.display = 'none';
                positionsEmpty.style.display = 'block';
                positionsBody.innerHTML = '';
            } else {
                positionsEmpty.style.display = 'none';
                positionsTable.style.display = 'table';
                positionsBody.innerHTML = s.positions.map(pos => {
                    const plClass = (pos.unrealized === null || pos.unrealized === undefined || Number.isNaN(Number(pos.unrealized)))
                        ? ''
                        : (pos.unrealized >= 0 ? 'value-positive' : 'value-negative');
                    const plText = fmtOptionalCurrency(pos.unrealized);
                    return `
                        <tr>
                            <td>${escapeHtml(pos.symbol || '--')}</td>
                            <td>${escapeHtml(pos.side || '--')}</td>
                            <td>${fmtShares(pos.shares)}</td>
                            <td>${fmtOptionalCurrency(pos.basis)}</td>
                            <td>${fmtOptionalCurrency(pos.value)}</td>
                            <td class="${plClass}">${plText}</td>
                        </tr>
                    `;
                }).join('');
            }

            const tbody = document.getElementById('wallet-rows');
            if (!s.wallets.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="muted">No wallets yet. Click "? Wallet".</td></tr>`;
            } else {
                const short = (addr) => addr ? `${addr.slice(0, 6)}...${addr.slice(-6)}` : '';
                tbody.innerHTML = s.wallets.map((w, i) => `
                    <tr>
                        <td>${escapeHtml(w.label || '')}</td>
                        <td>${escapeHtml(w.network || '')}</td>
                        <td class="addr" title="${escapeHtml(w.address || '')}">${escapeHtml(short(w.address || ''))}</td>
                        <td style="text-align:right;">${fmtCurrency(w.usd || 0)}</td>
                        <td style="text-align:right;">
                            <button class="btn btn-secondary small" onclick="editWallet(${i})">Edit</button>
                            <button class="btn danger small" onclick="removeWallet(${i})">Remove</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

async function openSetTotals() {
            const s = await loadPortfolio();
            const el = document.getElementById('forms-area');
            el.innerHTML = `
                <div class="card" style="margin-top:8px;">
                    <div class="card-header"><div class="card-title">Set Totals</div></div>
                    <div class="inline-form">
                        <label class="muted">Stocks (USD)<br><input id="inp-stocks" class="input" type="number" min="0" step="0.01" value="${Number(s.stocks)||0}"></label>
                        <label class="muted">Cash (USD)<br><input id="inp-cash" class="input" type="number" min="0" step="0.01" value="${Number(s.cash)||0}"></label>
                        <label class="muted">Monthly Goal (USD)<br><input id="inp-goal" class="input" type="number" min="0" step="1" value="${Number(s.goal)||2600}"></label>
                        <div style="flex:1 0 100%; display:flex; gap:8px; margin-top:8px;">
                            <button class="btn btn-primary" onclick="saveTotals()">Save</button>
                            <button class="btn btn-secondary" onclick="closeForms()">Close</button>
                        </div>
                    </div>
                </div>`;
            window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 120, behavior: 'smooth' });
        }
        async function saveTotals() {
            const s = await loadPortfolio();
            s.stocks = Number(document.getElementById('inp-stocks').value || 0);
            s.cash = Number(document.getElementById('inp-cash').value || 0);
            s.goal = Number(document.getElementById('inp-goal').value || 0);
            savePortfolio(s);
            closeForms();
        }
        function openAddWallet() {
            const el = document.getElementById('forms-area');
            el.innerHTML = `
                <div class="card" style="margin-top:8px;">
                    <div class="card-header"><div class="card-title">Add Wallet</div></div>
                    <div class="inline-form">
                        <input id="w-label" class="input" placeholder="Label (e.g., BTC Main)">
                        <select id="w-network" class="select">
                            <option value="BTC">BTC</option>
                            <option value="ETH">ETH</option>
                            <option value="SOL">SOL</option>
                            <option value="DOGE">DOGE</option>
                            <option value="LTC">LTC</option>
                            <option value="Other">Other</option>
                        </select>
                        <input id="w-address" class="input" placeholder="Public Address">
                        <input id="w-usd" class="input" type="number" step="0.01" placeholder="Value (USD)">
                        <div style="flex:1 0 100%; display:flex; gap:8px; margin-top:8px;">
                            <button class="btn btn-primary" onclick="addWallet()">Add</button>
                            <button class="btn btn-secondary" onclick="closeForms()">Close</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('w-label').focus();
            window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 120, behavior: 'smooth' });
        }
        async function addWallet() {
            const label = document.getElementById('w-label').value.trim();
            const network = document.getElementById('w-network').value;
            const address = document.getElementById('w-address').value.trim();
            const usd = Number(document.getElementById('w-usd').value || 0);
            const s = await loadPortfolio();
            s.wallets.push({ label, network, address, usd });
            savePortfolio(s);
            closeForms();
        }
        async function editWallet(i) {
            const s = await loadPortfolio();
            const w = s.wallets[i];
            if (!w) return;
            const el = document.getElementById('forms-area');
            el.innerHTML = `
                <div class="card" style="margin-top:8px;">
                    <div class="card-header"><div class="card-title">Edit Wallet</div></div>
                    <div class="inline-form">
                        <input id="ew-label" class="input" value="${escapeAttr(w.label||'')}" placeholder="Label">
                        <select id="ew-network" class="select">
                            ${['BTC','ETH','SOL','DOGE','LTC','Other'].map(n=>`<option ${w.network===n?'selected':''} value="${n}">${n}</option>`).join('')}
                        </select>
                        <input id="ew-address" class="input" value="${escapeAttr(w.address||'')}" placeholder="Address">
                        <input id="ew-usd" class="input" type="number" step="0.01" value="${Number(w.usd)||0}" placeholder="Value (USD)">
                        <div style="flex:1 0 100%; display:flex; gap:8px; margin-top:8px;">
                            <button class="btn btn-primary" onclick="saveWallet(${i})">Save</button>
                            <button class="btn btn-secondary" onclick="closeForms()">Close</button>
                        </div>
                    </div>
                </div>`;
            window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 120, behavior: 'smooth' });
        }
        async function saveWallet(i) {
            const s = await loadPortfolio();
            const w = s.wallets[i];
            if (!w) return;
            w.label = document.getElementById('ew-label').value.trim();
            w.network = document.getElementById('ew-network').value;
            w.address = document.getElementById('ew-address').value.trim();
            w.usd = Number(document.getElementById('ew-usd').value || 0);
            savePortfolio(s);
            closeForms();
        }
        async function removeWallet(i) {
            const s = await loadPortfolio();
            s.wallets.splice(i,1);
            savePortfolio(s);
        }
        function closeForms() { document.getElementById('forms-area').innerHTML = ''; }
        async function exportPortfolio() {
            const s = await loadPortfolio();
            const blob = new Blob([JSON.stringify(s, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'portfolioState.json';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }
        async function importPortfolio(file) {
            if (!file) return;
            const text = await file.text();
            try {
                const parsed = JSON.parse(text);
                // Very light validation
                if (!parsed || typeof parsed !== 'object') throw new Error('Invalid JSON');
                savePortfolio({ ...DEFAULT_PORTFOLIO, ...parsed });
            } catch (e) {
                alert('Import failed: ' + e.message);
            }
        }
        function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
        function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

        document.addEventListener('DOMContentLoaded', () => {
            refreshDashboard();
            setInterval(refreshDashboard, 30000);
            renderPortfolio();
        });
    </script>
</body>
</html>
