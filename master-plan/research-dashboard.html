<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Research Dashboard - October 26, 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e6f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .dashboard-header {
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px 40px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 2em;
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .date-badge {
            display: inline-block !important;
            width: 10px !important;
            height: 10px !important;
            min-width: 10px !important;
            min-height: 10px !important;
            border-radius: 50% !important;
            transition: all 0.3s ease !important;
            padding: 0 !important;
            margin: 0 2px !important;
            border: none !important;
            background-clip: padding-box !important;
            vertical-align: middle !important;
            flex-shrink: 0 !important;
            background: #888888 !important;
        }

        .date-badge.status-ok {
            background: #10b981 !important;
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.6) !important;
        }

        .date-badge.status-warning {
            background: #f59e0b !important;
            box-shadow: 0 0 4px rgba(245, 158, 11, 0.6) !important;
        }

        .date-badge.status-error {
            background: #ef4444 !important;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.6) !important;
        }

        .verification-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .verification-indicator.status-ok {
            background: #10b981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.8);
        }

        .verification-indicator.status-error {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .verification-indicator:hover {
            transform: scale(1.3);
        }

        .verification-tooltip {
            display: none;
            position: absolute;
            top: 25px;
            right: -50px;
            background: rgba(26, 31, 58, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            color: #e0e6f0;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .verification-indicator:hover .verification-tooltip {
            display: block;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .error-banner {
            display: none;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fecaca;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .error-banner.active {
            display: block;
        }
        
        .sentiment-overview {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(99, 102, 241, 0.1);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.8s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sentiment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .sentiment-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 20px;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sentiment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.5);
        }
        
        .sentiment-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .sentiment-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #6366f1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sentiment-trend-arrow {
            font-size: 0.8em;
            font-weight: bold;
        }

        .sentiment-trend-up {
            color: #10b981; /* Green */
        }

        .sentiment-trend-down {
            color: #ef4444; /* Red */
        }

        .sentiment-trend-neutral {
            color: #9ca3af; /* Gray */
        }
        

        .portfolio-recommendation {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .recommendation-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e8f0;
        }

        .recommendation-signal {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
        }


        .actions-list {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            margin: 8px 0;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 8px;
            border-left: 3px solid #6366f1;
        }

        .action-icon {
            font-size: 1.2rem;
            min-width: 24px;
        }

        .action-text {
            flex: 1;
        }

        .action-main {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .action-detail {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .reasoning-box {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .reasoning-title {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 12px;
        }

        .reasoning-text {
            color: #cbd5e1;
            line-height: 1.6;
        }

        .risks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .risk-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            border-radius: 6px;
        }

        .risk-icon {
            color: #fca5a5;
            min-width: 20px;
        }

        /* NEW: Health Score and Delta Indicators */
        .health-score-container {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .health-score-title {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .health-score-value {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .health-score-gauge {
            width: 100%;
            height: 30px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .health-score-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #ef4444, #fbbf24, #10b981, #3b82f6);
        }

        .health-score-label {
            font-size: 0.85rem;
            color: #cbd5e1;
            font-weight: 600;
        }


        .delta-neutral {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        .delta-arrow {
            font-size: 1rem;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-left: 10px;
        }

        .confidence-high {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .confidence-medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .confidence-low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* NEW: Execution Helper */
        .execution-helper {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .execution-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .execution-trade {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .execution-trade-main {
            flex: 1;
        }

        .execution-trade-asset {
            font-weight: 700;
            color: #e2e8f0;
            font-size: 1.05rem;
        }

        .execution-trade-details {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        .execution-trade-quantity {
            font-weight: 600;
            color: #cbd5e1;
            font-size: 1.1rem;
            text-align: right;
        }

        .execution-trade-price {
            font-size: 0.8rem;
            color: #64748b;
            text-align: right;
        }

        .copy-trade-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-trade-btn:hover {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .copy-trade-btn:active {
            transform: translateY(0);
        }

        .copy-success {
            text-align: center;
            color: #10b981;
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .provider-insights {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .technicals-providers-signal-row {
            display: flex;
            gap: 25px;
            margin-bottom: 40px;
            flex-wrap: nowrap;
            align-items: flex-start;
            overflow-x: auto;
        }

        .technicals-providers-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
            flex: 1;
            min-width: 0;
        }

        .technicals-signal-score-section {
            flex: 1;
            min-width: 0;
        }
        
        .provider-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .provider-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .provider-card:hover::before {
            transform: scaleX(1);
        }
        
        .provider-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.2);
        }
        
        .provider-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #8b5cf6;
        }
        
        .key-insight {
            background: rgba(99, 102, 241, 0.05);
            border-left: 3px solid #6366f1;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* Unusual Activity Monitor - matches provider card aesthetic */
        .unusual-activity-monitor {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .unusual-activity-monitor::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ef4444, #f97316);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .unusual-activity-monitor:hover::before {
            transform: scaleX(1);
        }

        .unusual-activity-monitor:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .unusual-activity-header {
            font-size: 1.1em;
            font-weight: 600;
            margin: 0 0 20px 0;
            color: #fecaca;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .unusual-activity-ticker {
            color: #e0e6f0;
            font-weight: 600;
            margin: 0 6px;
        }

        .unusual-activity-separator {
            color: #9ca3af;
            margin: 0 6px;
        }

        .unusual-activity-alert {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .unusual-activity-alert:last-child {
            margin-bottom: 0;
        }

        .unusual-activity-alert:hover {
            background: rgba(239, 68, 68, 0.15);
            transform: translateX(4px);
        }

        .unusual-activity-alert-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .unusual-activity-badge {
            font-weight: 600;
            color: #fecaca;
            margin-right: 8px;
            font-size: 0.9em;
            padding: 2px 6px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 4px;
            min-width: 60px;
            text-align: center;
        }

        .unusual-activity-metric {
            color: #e0e6f0;
            font-weight: 500;
        }

        .unusual-activity-value {
            color: #e0e6f0;
            font-size: 0.9em;
            margin-top: 4px;
        }

        .unusual-activity-value strong {
            color: #fecaca;
        }

        .unusual-activity-signal {
            color: #9ca3af;
            font-size: 0.8em;
            margin-top: 6px;
            line-height: 1.4;
        }

        .unusual-activity-timestamp {
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 2px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.05);
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .risk-monitor {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            display: none; /* Hidden from daily planner, shown in Markets Intelligence tab */
        }
        
        .risk-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .risk-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .risk-items {
            display: grid;
            gap: 15px;
        }
        
        .risk-item {
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid #ef4444;
            padding: 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .risk-item:hover {
            background: rgba(239, 68, 68, 0.1);
            transform: translateX(5px);
        }
        
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            position: relative;
        }
        
        .tab:hover {
            color: #e0e6f0;
        }
        
        .tab.active {
            color: #6366f1;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 0;
            right: 0;
            height: 2px;
            background: #6366f1;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 30px;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }
        
        /* QUICK ACTIONS PANEL */
        .quick-actions-panel {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .quick-action-card {
            background: rgba(26, 31, 58, 0.8);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quick-action-card.urgency-high {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .quick-action-card.urgency-medium {
            border-left-color: #eab308;
            background: rgba(234, 179, 8, 0.05);
        }

        .quick-action-card.urgency-low {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .quick-action-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.2);
        }

        .action-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .action-icon {
            font-size: 1.5em;
        }

        .action-title {
            font-size: 0.9em;
            color: #9ca3af;
        }

        .action-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #e0e6f0;
            margin-bottom: 8px;
        }

        .action-description {
            font-size: 0.85em;
            color: #c9d1d9;
        }

        /* SENTIMENT TIMELINE */
        .sentiment-timeline {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .timeline-chart {
            width: 100%;
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }

        /* PROVIDER CONSENSUS HEATMAP */
        .consensus-heatmap {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(99, 102, 241, 0.1);
            display: none; /* Hidden from daily planner, shown in Markets Intelligence tab */
        }

        .consensus-items {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .consensus-item {
            background: rgba(10, 14, 39, 0.4);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .consensus-topic {
            font-weight: 700;
            font-size: 1em;
            color: #e0e6f0;
            line-height: 1.3;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            word-wrap: break-word;
        }

        .consensus-bar-container {
            flex: 1;
            height: 30px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .consensus-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #6366f1);
            border-radius: 15px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        .consensus-bar.divergence {
            background: linear-gradient(90deg, #ef4444, #f59e0b);
        }

        .consensus-percentage {
            flex: 0 0 60px;
            text-align: right;
            font-weight: bold;
            color: #6366f1;
        }

        .divergence-badge {
            flex: 0 0 auto;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }

        /* DAILY PLANNER TAB STYLES */
        .planner-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .priorities-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .priority-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .priority-item:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(5px);
        }

        .priority-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #6366f1;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .priority-checkbox.checked {
            background: #6366f1;
        }

        .priority-checkbox.checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        .priority-item.high { border-left: 3px solid #ef4444; }
        .priority-item.medium { border-left: 3px solid #eab308; }
        .priority-item.low { border-left: 3px solid #10b981; }

        .key-levels-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .level-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }

        .level-table th {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            color: #9ca3af;
            font-size: 0.85em;
        }

        .level-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }

        .level-asset {
            font-weight: bold;
            color: #6366f1;
        }

        .scheduled-events-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .event-time {
            color: #6366f1;
            font-weight: bold;
        }

        .event-impact {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .event-impact.high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .event-impact.medium {
            background: rgba(234, 179, 8, 0.2);
            color: #fde047;
        }

        .event-impact.low {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .event-ai-note {
            color: #9ca3af;
            font-size: 0.9em;
            margin-top: 6px;
            line-height: 1.3;
        }

        /* Signal Data Styling */
        .signal-data-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .signal-score-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .signal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .signal-composite-score {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .signal-tier {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .tier-extreme-buy {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
            border: 2px solid #22c55e;
        }

        .tier-strong-buy {
            background: rgba(16, 185, 129, 0.3);
            color: #34d399;
            border: 2px solid #10b981;
        }

        .tier-moderate-buy {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            border: 2px solid #3b82f6;
        }

        .tier-weak {
            background: rgba(234, 179, 8, 0.3);
            color: #fde047;
            border: 2px solid #eab308;
        }

        .tier-avoid {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            border: 2px solid #ef4444;
        }

        .signal-setup {
            background: rgba(139, 92, 246, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .signal-breakdown {
            margin-top: 20px;
        }

        .breakdown-title {
            color: #9ca3af;
            font-size: 0.9em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .breakdown-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .breakdown-item {
            display: grid;
            grid-template-columns: 140px 1fr 70px;
            align-items: center;
            gap: 12px;
        }

        .breakdown-label {
            color: #d1d5db;
            font-size: 0.9em;
        }

        .breakdown-bar-container {
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .breakdown-bar {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .breakdown-value {
            color: #6366f1;
            font-weight: bold;
            font-size: 0.9em;
            text-align: right;
        }

        .signal-recommendation {
            margin-top: 20px;
            padding: 15px;
            background: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #22c55e;
            border-radius: 8px;
            color: #4ade80;
            font-size: 0.95em;
            line-height: 1.6;
        }

        @media (max-width: 968px) {
            .planner-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .provider-insights {
                grid-template-columns: 1fr;
            }

            .chart-container {
                flex-direction: column;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
            }

            .consensus-item {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* ECONOMIC CALENDAR STYLES */
        .economic-calendar {
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        .calendar-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #e0e6f0;
        }

        .calendar-summary {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid #6366f1;
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: #c5cfe6;
            line-height: 1.6;
        }

        .calendar-section {
            margin-bottom: 24px;
        }

        .calendar-section-header {
            font-size: 1.1em;
            font-weight: bold;
            color: #a5b4fc;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .calendar-event {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(31, 41, 55, 0.6);
            border-radius: 8px;
            border-left: 3px solid;
            transition: all 0.2s ease;
        }

        .calendar-event:hover {
            background: rgba(31, 41, 55, 0.9);
            transform: translateX(4px);
        }

        .calendar-event.impact-HIGH {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .calendar-event.impact-MEDIUM {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }

        .event-time {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #9ca3af;
            min-width: 90px;
            font-size: 0.95em;
        }

        .event-name {
            flex: 1;
            color: #e0e6f0;
            font-weight: 500;
        }

        .event-impact {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .event-impact.HIGH {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid #ef4444;
        }

        .event-impact.MEDIUM {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid #f59e0b;
        }

        .key-date-card {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .key-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .key-date-date {
            font-weight: bold;
            color: #c4b5fd;
            font-size: 1.05em;
        }

        .key-date-events {
            color: #9ca3af;
            font-size: 0.9em;
            margin-bottom: 6px;
        }

        .key-date-note {
            color: #d8b4fe;
            font-style: italic;
            font-size: 0.95em;
        }

        /* AI INTERPRETATION STYLES */
        .ai-interpretation {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.94), rgba(30, 41, 82, 0.92));
            border-radius: 16px;
            border: 1px solid rgba(99, 102, 241, 0.35);
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
            --ai-accent: rgba(99, 102, 241, 0.45);
            --ai-accent-soft: rgba(99, 102, 241, 0.15);
            --ai-border: rgba(99, 102, 241, 0.35);
            --ai-text-primary: #e0e6f0;
            --ai-text-muted: #a5b4fc;
        }

        .ai-interpretation::before {
            content: '';
            position: absolute;
            inset: -40px -60px auto auto;
            width: 220px;
            height: 220px;
            background: radial-gradient(circle at center, var(--ai-accent) 0%, transparent 70%);
            opacity: 0.9;
            transform: rotate(12deg);
            pointer-events: none;
        }

        .ai-interpretation::after {
            content: '';
            position: absolute;
            inset: auto -80px -120px auto;
            width: 260px;
            height: 260px;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.25), transparent 70%);
            opacity: 0.3;
            pointer-events: none;
        }

        .ai-tone-bullish {
            --ai-accent: rgba(16, 185, 129, 0.55);
            --ai-accent-soft: rgba(16, 185, 129, 0.15);
            --ai-border: rgba(16, 185, 129, 0.45);
            --ai-text-muted: #6ee7b7;
        }

        .ai-tone-bearish {
            --ai-accent: rgba(239, 68, 68, 0.55);
            --ai-accent-soft: rgba(239, 68, 68, 0.12);
            --ai-border: rgba(239, 68, 68, 0.45);
            --ai-text-muted: #fca5a5;
        }

        .ai-tone-neutral {
            --ai-accent: rgba(148, 163, 184, 0.45);
            --ai-accent-soft: rgba(148, 163, 184, 0.15);
            --ai-border: rgba(148, 163, 184, 0.35);
            --ai-text-muted: #d1d5db;
        }

        .ai-tone-mixed,
        .ai-tone-cautiously-bullish {
            --ai-accent: rgba(234, 179, 8, 0.55);
            --ai-accent-soft: rgba(234, 179, 8, 0.12);
            --ai-border: rgba(234, 179, 8, 0.35);
            --ai-text-muted: #fde047;
        }

        .ai-header {
            position: relative;
            display: flex;
            align-items: center;
            gap: 18px;
            flex-wrap: wrap;
            margin-bottom: 18px;
            z-index: 1;
        }

        .ai-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: var(--ai-accent-soft);
            color: var(--ai-text-muted);
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.45);
        }

        .ai-header-text {
            flex: 1;
            min-width: 200px;
        }

        .ai-header-title {
            color: var(--ai-text-primary);
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .ai-updated {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--ai-text-muted);
            font-size: 0.85em;
            background: rgba(15, 23, 42, 0.4);
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 255, 0.2);
        }

        .ai-updated span:first-child {
            font-size: 0.95em;
        }

        .ai-updated-label {
            opacity: 0.7;
        }

        .ai-stats {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ai-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.8em;
            font-weight: 600;
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(148, 163, 255, 0.25);
            color: var(--ai-text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-chip span:first-child {
            font-size: 1em;
        }

        .sentiment-bullish { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .sentiment-bearish { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .sentiment-neutral { background: rgba(156, 163, 175, 0.2); color: #d1d5db; }
        .sentiment-mixed { background: rgba(234, 179, 8, 0.2); color: #fde047; }
        .sentiment-cautiously-bullish { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }

        .confidence-high { background: rgba(16, 185, 129, 0.18); color: #6ee7b7; }
        .confidence-medium { background: rgba(234, 179, 8, 0.18); color: #fde047; }
        .confidence-low { background: rgba(239, 68, 68, 0.18); color: #fca5a5; }

        .ai-body {
            position: relative;
            z-index: 1;
        }

        .ai-section {
            border-radius: 12px;
            padding: 18px;
            margin-top: 18px;
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(148, 163, 255, 0.25);
        }

        .ai-section:first-of-type {
            margin-top: 0;
        }

        .ai-section-title {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--ai-text-muted);
            margin-bottom: 10px;
        }

        .ai-section-title span:first-child {
            font-size: 1.1em;
        }

        .ai-section-body {
            color: var(--ai-text-primary);
            line-height: 1.7;
            font-size: 1.02em;
        }

        .ai-section-insight {
            background: rgba(250, 204, 21, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.25);
        }

        .ai-section-summary {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.25);
        }

        .ai-section-action {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.25);
        }

        /* RISK MONITOR CATEGORIES */
        .risk-category {
            margin-bottom: 30px;
        }

        .risk-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        .risk-category-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #e0e6f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-category-icon {
            font-size: 1.3em;
        }

        /* DIVERGENCE RISK CARDS */
        .divergence-risk-card {
            background: rgba(17, 24, 39, 0.6);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .divergence-risk-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .divergence-risk-card.critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .divergence-risk-card.high {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .divergence-risk-card.medium {
            border-left-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .divergence-risk-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .divergence-consensus-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .divergence-consensus-badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .divergence-consensus-badge.high {
            background: rgba(245, 158, 11, 0.2);
            color: #fde047;
        }

        .divergence-consensus-badge.medium {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        .divergence-risk-title {
            font-size: 1.05em;
            font-weight: 600;
            color: #e0e6f0;
            flex: 1;
        }

        .divergence-risk-description {
            color: #d1d5db;
            line-height: 1.6;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .divergence-risk-implication {
            background: rgba(16, 185, 129, 0.1);
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 3px solid #10b981;
        }

        .divergence-risk-implication-label {
            color: #10b981;
            font-weight: bold;
            font-size: 0.8em;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .divergence-risk-implication-text {
            color: #6ee7b7;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .provider-tier-badge {
            display: inline-block;
            font-size: 1.1em;
            margin-right: 6px;
        }

        .end-of-day-card {
            background: rgba(56, 189, 248, 0.08);
            border: 1px solid rgba(56, 189, 248, 0.35);
            padding: 18px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .end-of-day-card h2 { font-size: 1.2em; margin-bottom: 10px; }
        .end-of-day-card ul { padding-left: 18px; }
        .end-of-day-card li { margin: 4px 0; }

        .close-probability-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        /* Options Intelligence Styles */
        .options-intelligence-section {
            margin-top: 25px;
            padding: 20px;
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .options-key-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .options-metric-card {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .options-metric-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 5px;
        }

        .options-metric-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #c4b5fd;
        }

        .options-key-levels-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .options-key-levels-table th,
        .options-key-levels-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }

        .options-key-levels-table th {
            color: #9ca3af;
            font-size: 0.85em;
        }

        .options-key-levels-table td {
            color: #e0e6f0;
            font-weight: 500;
        }

        .options-key-levels-table tr:last-child td {
            border-bottom: none;
        }

        .options-volume-flow-card {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            padding: 15px;
        }

        .options-volume-flow-bar-container {
            display: flex;
            height: 30px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .options-volume-flow-calls {
            background: #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .options-volume-flow-puts {
            background: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        /* Trading Levels Dashboard Styles */
        .trading-levels-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .trading-levels-dashboard {
            flex: 1;
            min-width: 45%;
            margin-top: 0;
            padding: 20px;
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
        }

        .levels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            flex-wrap: wrap;
            gap: 10px;
        }

        .current-metrics {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        .current-metrics .metric strong {
            color: #8b5cf6;
            margin-left: 4px;
        }

        .options-quick-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-metric {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .quick-metric .metric-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 5px;
        }

        .quick-metric .metric-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #c4b5fd;
        }

        .levels-section {
            margin: 20px 0;
        }

        .levels-section-title {
            color: #8b5cf6;
            font-size: 0.95em;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .levels-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .level-card {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
        }

        .level-card:hover {
            background: rgba(139, 92, 246, 0.12);
            transform: translateX(2px);
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .level-importance {
            font-weight: 600;
            font-size: 0.9em;
        }

        .level-strike {
            font-size: 1.2em;
            font-weight: 700;
            color: #e0e6f0;
        }

        .level-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .level-context {
            color: #d1d5db;
            font-size: 0.85em;
            line-height: 1.4;
            font-style: italic;
        }

        .current-price-line {
            text-align: center;
            color: #8b5cf6;
            font-weight: 600;
            font-size: 1.05em;
            margin: 20px 0;
            padding: 12px 0;
            border-top: 2px solid rgba(139, 92, 246, 0.3);
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
            letter-spacing: 1px;
        }

        .market-context-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 8px;
        }

        .section-subtitle {
            color: #8b5cf6;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .context-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 6px;
        }

        .context-label {
            color: #9ca3af;
            font-size: 0.85em;
        }

        .context-value {
            color: #e0e6f0;
            font-weight: 600;
            font-size: 0.85em;
        }
    
/* Options Intelligence header (observer) */
.section-header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.section-title { margin: 0; }
.refresh-badge { background: rgba(99,102,241,0.15); border:1px solid rgba(99,102,241,0.35); padding:6px 10px; border-radius:10px; font-size:0.85em; color:#a5b4fc; }

/* ========================================================================
   MARKETS INTELLIGENCE VISUAL ENHANCEMENTS - ANIMATIONS
   ======================================================================== */

/* Fade in with upward motion */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Slide in from right */
@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Pulse glow effect */
@keyframes pulseGlow {
    0%, 100% {
        box-shadow: 0 0 10px currentColor;
        opacity: 1;
    }
    50% {
        box-shadow: 0 0 20px currentColor;
        opacity: 0.8;
    }
}

/* Fill segment (donut chart) */
@keyframes fillSegment {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Markets Intelligence dashboard styles */
.markets-intelligence-dashboard {
    animation: fadeIn 0.6s ease forwards;
    max-width: 1400px;
    margin: 0 auto;
    font-size: 0.9em; /* Reduce base font size by 10% */
}

.glass-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.glass-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

/* Responsive gauge sizing */
.gauge-card {
    min-width: 0; /* Allow shrinking */
}

.consensus-gauges {
    gap: 15px !important; /* Reduce gap between gauges */
}

/* Scale down visualizations for better fit */
@media (max-width: 1600px) {
    .markets-intelligence-dashboard {
        font-size: 0.85em;
    }
    .gauge-container svg {
        transform: scale(0.9);
    }
}

.section-header-enhanced:hover {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15)) !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .consensus-gauges {
        grid-template-columns: 1fr !important;
    }
    .price-levels-card,
    .allocation-card {
        margin-bottom: 20px;
    }
}

</style>

<!-- X Sentiment Trend Styles (injected) -->
<style>
/* X Sentiment Trend Cards */
.xtrends-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}
.xtrends-group {
  background: rgba(26,31,58,0.6);
  border: 1px solid rgba(99,102,241,0.15);
  border-radius: 14px;
  padding: 16px;
}
.xtrends-title {
  font-weight: 700;
  margin-bottom: 10px;
  color: #a5b4fc;
  display: flex;
  align-items: center;
  gap: 8px;
}
.trend-card {
  background: rgba(10,14,39,0.35);
  border: 1px solid rgba(99,102,241,0.15);
  border-radius: 10px;
  padding: 12px;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  transition: transform .15s ease;
}
.trend-card:hover { transform: translateY(-2px); }
.trend-word { font-weight: 700; color: #e0e6f0; }
.trend-sub { color: #9ca3af; font-size: .85em; }
.trend-badges { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

.trend-pill {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: .75em; font-weight: 700;
  border: 1px solid transparent;
}
.trend-pill.rising      { background: rgba(16,185,129,.15); color:#6ee7b7; border-color: rgba(16,185,129,.4); }
.trend-pill.surging     { background: rgba(34,197,94,.18);  color:#86efac; border-color: rgba(34,197,94,.5); }
.trend-pill.falling     { background: rgba(239,68,68,.15);  color:#fca5a5; border-color: rgba(239,68,68,.4); }
.trend-pill.collapsing  { background: rgba(220,38,38,.18);  color:#fecaca; border-color: rgba(220,38,38,.5); }
.trend-pill.stable      { background: rgba(156,163,175,.18);color:#e5e7eb; border-color: rgba(156,163,175,.35); }

.velocity-badge {
  background: rgba(99,102,241,.12);
  border: 1px solid rgba(99,102,241,.35);
  color: #c7d2fe;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: .75em; font-weight: 700;
  font-variant-numeric: tabular-nums;
}

.velocity-wrap { grid-column: 1 / -1; }
.velocity-label { font-size: .75em; color: #9ca3af; margin-top: 6px; }

.velocity-bar {
  position: relative;
  height: 10px;
  background: linear-gradient(90deg,
    rgba(239,68,68,.25) 0%,
    rgba(239,68,68,.25) 49%,
    rgba(148,163,184,.35) 50%,
    rgba(16,185,129,.25) 51%,
    rgba(16,185,129,.25) 100%);
  border: 1px solid rgba(99,102,241,.25);
  border-radius: 999px;
  overflow: hidden;
  margin-top: 6px;
}
.velocity-fill {
  position: absolute; top: 0; height: 100%;
  background: linear-gradient(90deg,#ef4444,#f59e0b,#10b981);
  transition: width .4s ease, left .4s ease;
}
.velocity-zero {
  position: absolute; top: -5px; left: 50%; width: 0; height: 20px;
  border-left: 1px dashed rgba(148,163,184,.5);
}

/* X Sentiment: compact list layout for Trending Words & Themes */
.xtrends-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 12px;
}
.trend-list-box {
  background: rgba(13,16,35,0.5);
  border: 1px solid rgba(99,102,241,0.15);
  border-radius: 12px;
  padding: 10px 0;
}
.trend-list-head {
  display: flex; align-items: center; gap: 8px;
  color: #c7d2fe; font-weight: 700; padding: 0 12px 6px 12px;
  border-bottom: 1px dashed rgba(148,163,184,0.25);
  margin-bottom: 6px;
}
.trend-row {
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
}
.trend-row:nth-child(odd) { background: rgba(99,102,241,0.03); }
.trend-left { display: flex; align-items: baseline; gap: 8px; }
.trend-rank { color:#94a3b8; font-weight: 700; width: 20px; text-align: right; }
.trend-name { font-weight: 700; color:#e5e7eb; }
.trend-meta { color:#9ca3af; font-size: .8em; }
.trend-right { display:flex; align-items: center; gap: 12px; }
.state-stack { display:flex; flex-direction: column; align-items: flex-end; line-height: 1; }
.state-small { font-size: .7em; color:#9ca3af; letter-spacing:.02em; }
.arrow {
  display:inline-block; width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent;
}
.arrow.up { border-bottom: 10px solid #10b981; }
.arrow.down { border-top: 10px solid #ef4444; }
.arrow.flat {
  width: 12px; height: 3px; background: #94a3b8; border-radius: 2px; border: none;
}
.badge-soft {
  padding: 3px 8px; border-radius: 999px; font-size:.75em; font-weight:700;
  background: rgba(99,102,241,0.12); color:#c7d2fe; border:1px solid rgba(99,102,241,0.35);
  font-variant-numeric: tabular-nums;
}
.subtle { color:#94a3b8; font-size:.8em; font-weight:600; margin-left:auto; }

/* version badge */
.xs-version-badge{
  position:fixed; right:10px; bottom:10px; z-index:9999;
  background:rgba(16,24,40,.85); color:#c7d2fe; border:1px solid rgba(99,102,241,.35);
  padding:6px 10px; border-radius:10px; font-size:.8em; font-weight:700;
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}
</style>

<!-- X Sentiment Trend Styles (v10 override) -->
<style>
.xtrends-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.xtrends-group{background:rgba(26,31,58,.6);border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:16px}
.xtrends-title{font-weight:700;margin-bottom:10px;color:#a5b4fc;display:flex;align-items:center;gap:8px}
.trend-card{background:rgba(10,14,39,.35);border:1px solid rgba(99,102,241,.15);border-radius:10px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:10px;transition:transform .15s ease}
.trend-card:hover{transform:translateY(-2px)}
.trend-word{font-weight:700;color:#e0e6f0}
.trend-sub{color:#9ca3af;font-size:.85em}
.trend-badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.trend-pill{padding:4px 10px;border-radius:999px;font-size:.75em;font-weight:700;border:1px solid transparent}
.trend-pill.rising{background:rgba(16,185,129,.15);color:#6ee7b7;border-color:rgba(16,185,129,.4)}
.trend-pill.surging{background:rgba(34,197,94,.18);color:#86efac;border-color:rgba(34,197,94,.5)}
.trend-pill.falling{background:rgba(239,68,68,.15);color:#fca5a5;border-color:rgba(239,68,68,.4)}
.trend-pill.collapsing{background:rgba(220,38,38,.18);color:#fecaca;border-color:rgba(220,38,38,.5)}
.trend-pill.stable{background:rgba(156,163,175,.18);color:#e5e7eb;border-color:rgba(156,163,175,.35)}
.velocity-badge{background:rgba(99,102,241,.12);border:1px solid rgba(99,102,241,.35);color:#c7d2fe;padding:4px 10px;border-radius:999px;font-size:.75em;font-weight:700;font-variant-numeric:tabular-nums}
.velocity-wrap{grid-column:1/-1}
.velocity-label{font-size:.75em;color:#9ca3af;margin-top:6px}
.velocity-bar{position:relative;height:10px;background:linear-gradient(90deg,rgba(239,68,68,.25)0%,rgba(239,68,68,.25)49%,rgba(148,163,184,.35)50%,rgba(16,185,129,.25)51%,rgba(16,185,129,.25)100%);border:1px solid rgba(99,102,241,.25);border-radius:999px;overflow:hidden;margin-top:6px}
.velocity-fill{position:absolute;top:0;height:100%;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);transition:width .4s ease,left .4s ease}
.velocity-zero{position:absolute;top:-5px;left:50%;width:0;height:20px;border-left:1px dashed rgba(148,163,184,.5)}
.xtrends-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
.trend-list-box{background:rgba(13,16,35,.5);border:1px solid rgba(99,102,241,.15);border-radius:12px;padding:10px 0}
.trend-list-head{display:flex;align-items:center;gap:8px;color:#c7d2fe;font-weight:700;padding:0 12px 6px 12px;border-bottom:1px dashed rgba(148,163,184,.25);margin-bottom:6px}
.trend-row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;padding:8px 12px}
.trend-row:nth-child(odd){background:rgba(99,102,241,.03)}
.trend-left{display:flex;align-items:baseline;gap:8px}
.trend-rank{color:#94a3b8;font-weight:700;width:22px;text-align:right}
.trend-name{font-weight:700;color:#e5e7eb}
.trend-meta{color:#9ca3af;font-size:.8em}
.trend-right{display:flex;align-items:center;gap:12px}
.state-stack{display:flex;flex-direction:column;align-items:flex-end;line-height:1}
.state-small{font-size:.7em;color:#9ca3af;letter-spacing:.02em}
.arrow{display:inline-block;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent}
.arrow.up{border-bottom:10px solid #10b981}
.arrow.down{border-top:10px solid #ef4444}
.arrow.flat{width:12px;height:3px;background:#94a3b8;border-radius:2px;border:none}
.badge-soft{padding:3px 8px;border-radius:999px;font-size:.75em;font-weight:700;background:rgba(99,102,241,.12);color:#c7d2fe;border:1px solid rgba(99,102,241,.35);font-variant-numeric:tabular-nums}
.subtle{color:#94a3b8;font-size:.8em;font-weight:600;margin-left:auto}
.xs-version-badge{position:fixed;right:10px;bottom:10px;z-index:9999;background:rgba(16,24,40,.85);color:#c7d2fe;border:1px solid rgba(99,102,241,.35);padding:6px 10px;border-radius:10px;font-size:.8em;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.35)}
</style>
</head>
<body data-plan="./master-plan.md">
    <div class="dashboard-header">
        <div class="header-content">
            <h1 id="dashboard-title"></h1>
            <div id="dashboard-date" style="display: flex; align-items: center; gap: 10px; font-size: 0.95em; color: #e0e6f0;">
                <span id="verification-status" class="verification-indicator status-ok">
                    <span class="verification-tooltip">All sections verified ✓</span>
                </span>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="dashboard-error" class="error-banner"></div>

        <!-- QUICK ACTIONS PANEL -->
        <div class="quick-actions-panel">
            <h2 class="section-title">⚡ Immediate Actions</h2>
            <div class="quick-actions-grid" id="quick-actions-grid"></div>
        </div>

        <!-- Market Sentiment Overview -->
        <div class="sentiment-overview">
            <h2 class="section-title">Market Sentiment Overview</h2>
            <div class="sentiment-grid" id="sentiment-grid"></div>
        </div>

        <!-- Key Metrics -->
        <h2 class="section-title">Key Market Metrics</h2>
        <div class="metrics-grid" id="metrics-grid"></div>

        <!-- Provider Insights Tabs -->
        <div class="tabs" id="provider-tabs"></div>
        <div id="provider-contents"></div>

        <!-- PROVIDER CONSENSUS HEATMAP -->
        <div class="consensus-heatmap">
            <h2 class="section-title">🎯 Analyst Consensus</h2>
            <div class="consensus-items" id="consensus-items"></div>
        </div>

        <!-- Risk & Divergence Monitor -->
        <div class="risk-monitor">
            <div class="risk-header">
                <div class="risk-indicator"></div>
                <h2 class="section-title">🚨 Risk & Divergence Monitor</h2>
            </div>
            <div class="risk-items" id="risk-items"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script>
        const SOURCE_FILE = document.body.dataset.plan || 'master-plan.md';

        async function initDashboard() {
            try {
                const cacheBuster = (SOURCE_FILE.includes('?') ? '&' : '?') + 't=' + Date.now();
                const response = await fetch(SOURCE_FILE + cacheBuster, { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error('Failed to load ' + SOURCE_FILE + ' (' + response.status + ')');
                }

                const text = await response.text();
                const frontMatterMatch = text.match(/^---\s*([\s\S]*?)\s*---/);
                if (!frontMatterMatch) {
                    throw new Error('Dashboard configuration missing front matter.');
                }

                const config = jsyaml.load(frontMatterMatch[1]);
                window.__PLAN_JSON__ = config;
                applyDashboardData(config.dashboard || {}, config);
            } catch (error) {
                console.error(error);
                showError(error.message);
            } finally {
                applyCardAnimations();
            }
        }

        // Calculate data freshness and return appropriate status class
        function getDataFreshness(timestamp) {
            if (!timestamp) {
                console.warn('No timestamp provided to getDataFreshness');
                return 'status-error';
            }

            try {
                const now = new Date();
                const updateTime = new Date(timestamp);

                if (isNaN(updateTime.getTime())) {
                    console.warn('Invalid timestamp format:', timestamp);
                    return 'status-error';
                }

                const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);

                // Debug log
                console.log(`Freshness check - Now: ${now.toISOString()}, Update: ${updateTime.toISOString()}, Hours: ${hoursSinceUpdate.toFixed(2)}`);

                // GREEN: Updated within last 12 hours
                if (hoursSinceUpdate < 12) {
                    console.log(`✓ Status OK (fresh): ${timestamp}`);
                    return 'status-ok';
                }

                // YELLOW: Updated 12-24 hours ago
                if (hoursSinceUpdate < 24) {
                    console.log(`⚠ Status Warning (aging): ${timestamp}`);
                    return 'status-warning';
                }

                // RED: Updated more than 24 hours ago
                console.log(`✕ Status Error (stale): ${timestamp}`);
                return 'status-error';
            } catch (error) {
                console.error('Error calculating data freshness:', error);
                return 'status-error';
            }
        }

        function checkVerificationStatus(plan) {
            /**
             * Verification Status Check
             * Scans all dashboard sections to see if any have stale data
             * Returns: 'status-ok' if all fresh, 'status-error' if any stale
             */
            if (!plan || !plan.dashboard) {
                return 'status-ok'; // No data to check
            }

            try {
                let hasStaleSection = false;
                let staleCount = 0;
                let freshCount = 0;
                const now = new Date();

                // List of key timestamp fields to check
                const timestampFields = [
                    { path: ['dashboard', 'sentimentCardsUpdated'], name: 'Sentiment Cards' },
                    { path: ['dashboard', 'metricsUpdated'], name: 'Market Metrics' },
                    { path: ['dashboard', 'quickActionsUpdated'], name: 'Quick Actions' },
                    { path: ['dashboard', 'sentimentHistoryUpdated'], name: 'Sentiment Timeline' },
                    { path: ['dashboard', 'riskItemsUpdated'], name: 'Risk Items' },
                    { path: ['dashboard', 'providerConsensusUpdated'], name: 'Provider Consensus' },
                ];

                // Check X Sentiment tab if it exists
                if (plan.dashboard.tabs && plan.dashboard.tabs.length > 2) {
                    const xSentimentTab = plan.dashboard.tabs[2];
                    if (xSentimentTab && xSentimentTab.aiInterpretation && xSentimentTab.aiInterpretation.updatedAt) {
                        timestampFields.push({
                            path: ['dashboard', 'tabs', 2, 'aiInterpretation', 'updatedAt'],
                            name: 'X Sentiment Tab'
                        });
                    }
                    // Check trending sections
                    if (xSentimentTab && xSentimentTab.crypto_trending && xSentimentTab.crypto_trending.updatedAt) {
                        timestampFields.push({
                            path: ['dashboard', 'tabs', 2, 'crypto_trending', 'updatedAt'],
                            name: 'Crypto Trending'
                        });
                    }
                    if (xSentimentTab && xSentimentTab.macro_trending && xSentimentTab.macro_trending.updatedAt) {
                        timestampFields.push({
                            path: ['dashboard', 'tabs', 2, 'macro_trending', 'updatedAt'],
                            name: 'Macro Trending'
                        });
                    }
                }

                // Check each timestamp
                for (const field of timestampFields) {
                    let value = plan;
                    for (const key of field.path) {
                        value = value[key];
                        if (value === undefined) break;
                    }

                    if (value && typeof value === 'string') {
                        try {
                            const updateTime = new Date(value);
                            if (!isNaN(updateTime.getTime())) {
                                const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);

                                // If any section is stale (>24 hours), mark as error
                                if (hoursSinceUpdate > 24) {
                                    hasStaleSection = true;
                                    staleCount++;
                                    console.warn(`STALE: ${field.name} (${hoursSinceUpdate.toFixed(1)}h old)`);
                                } else if (hoursSinceUpdate < 12) {
                                    freshCount++;
                                } else {
                                    console.log(`AGING: ${field.name} (${hoursSinceUpdate.toFixed(1)}h old)`);
                                }
                            }
                        } catch (e) {
                            console.warn(`Could not parse timestamp for ${field.name}:`, value);
                        }
                    }
                }

                // Update verification indicator
                const indicator = document.getElementById('verification-status');
                if (indicator) {
                    if (hasStaleSection) {
                        indicator.className = 'verification-indicator status-error';
                        const tooltip = indicator.querySelector('.verification-tooltip');
                        if (tooltip) {
                            tooltip.textContent = `⚠️ ${staleCount} stale section(s) - run verification check`;
                        }
                    } else {
                        indicator.className = 'verification-indicator status-ok';
                        const tooltip = indicator.querySelector('.verification-tooltip');
                        if (tooltip) {
                            tooltip.textContent = `✓ All sections verified (${freshCount} fresh)`;
                        }
                    }
                }

                console.log(`Verification Status: ${hasStaleSection ? 'ERROR (stale sections found)' : 'OK (all fresh)'}`);
                return hasStaleSection ? 'status-error' : 'status-ok';

            } catch (error) {
                console.error('Error checking verification status:', error);
                return 'status-ok';
            }
        }

        function applyDashboardData(dashboard, plan) {
            if (dashboard.pageTitle) {
                document.title = dashboard.pageTitle;
            }

            const titleEl = document.getElementById('dashboard-title');
            if (titleEl) {
                titleEl.textContent = dashboard.title || 'Investment Research Dashboard';
            }

            const dateEl = document.getElementById('dashboard-date');
            if (dateEl) {
                // Keep the date text and add a colored dot indicator
                dateEl.textContent = dashboard.dateBadge || '';

                // Create a small colored dot indicator next to the date
                const statusClass = getDataFreshness(dashboard.sentimentCardsUpdated);
                const dotEl = document.createElement('span');
                dotEl.className = `date-badge ${statusClass}`;
                dotEl.style.marginLeft = '8px';
                dateEl.appendChild(dotEl);
            }

            // Run verification check on all sections
            checkVerificationStatus(plan);

            renderSentimentCards(dashboard.sentimentCards || [], dashboard.sentimentCardsUpdated);
            renderMetrics(dashboard.metrics || [], dashboard.metricsUpdated);
            const planEndOfDay = plan && plan.endOfDay ? plan.endOfDay : dashboard.endOfDay;
            renderProviderTabs(dashboard.tabs || [], dashboard.dailyPlanner, planEndOfDay, dashboard);

            // Render integrated Risk & Divergence Monitor
            renderRiskAndDivergenceMonitor(dashboard.riskItems || [], dashboard.divergenceAlerts || [], dashboard.riskItemsUpdated);

            // New dashboard features
            if (dashboard.quickActions) renderQuickActions(dashboard.quickActions, dashboard.quickActionsUpdated);
            if (dashboard.sentimentHistory) renderSentimentTimeline(dashboard.sentimentHistory, dashboard.sentimentHistoryUpdated);
            if (dashboard.providerConsensus) renderProviderConsensus(dashboard.providerConsensus, dashboard.providerConsensusUpdated);
            // Clean up any garbled icons/text from source data or encoding
            sanitizeUIArtifacts();
        }

        // Fixes any garbled placeholder characters and normalizes key labels/icons
        function sanitizeUIArtifacts() {
            try {
                // NOTE: Don't overwrite quick-actions title - it's set with timestamp in renderQuickActions()

                const st = document.querySelector('.sentiment-timeline .section-title');
                if (st) st.textContent = '📈 Sentiment Timeline (Last 30 Days)';

                const ac = document.querySelector('.consensus-heatmap .section-title');
                if (ac) ac.textContent = 'Analyst Consensus';

                const rm = document.querySelector('.risk-monitor .section-title');
                if (rm) rm.textContent = '⚠️ Risk & Divergence Monitor';

                // AI interpretation badges and labels
                document.querySelectorAll('.ai-badge span:first-child').forEach(el => { el.textContent = '🤖'; });
                document.querySelectorAll('.ai-key-insight-label').forEach(el => { el.textContent = 'Key Insight'; });
                document.querySelectorAll('.ai-action .ai-action-icon').forEach(el => { el.textContent = '⚡'; });

                // Economic calendar headers and separators
                const cal = document.querySelector('.economic-calendar');
                if (cal) {
                    const calIcon = cal.querySelector('.calendar-header span');
                    if (calIcon) calIcon.textContent = '📅';
                    const headers = cal.querySelectorAll('.calendar-section-header');
                    if (headers[0]) headers[0].textContent = 'TODAY';
                    if (headers[1]) headers[1].textContent = 'THIS WEEK';
                    if (headers[2]) headers[2].textContent = 'NEXT WEEK';
                    if (headers[3]) headers[3].textContent = 'KEY DATES THIS MONTH';

                    cal.querySelectorAll('.key-date-events').forEach(el => {
                        el.textContent = el.textContent.replace(/�/g, '•');
                    });
                }

                // Risk monitor icons
                const riskIcons = ['🔥', '⚠️', 'ℹ️'];
                document.querySelectorAll('.risk-category .risk-category-icon').forEach((el, idx) => {
                    el.textContent = riskIcons[idx] || 'ℹ️';
                });

                // Divergence badges and labels
                document.querySelectorAll('.divergence-consensus-badge.critical').forEach(el => {
                    const pct = (el.textContent.match(/\d+%/) || [''])[0];
                    el.textContent = `🔥 ${pct}`.trim();
                });
                document.querySelectorAll('.divergence-consensus-badge.high').forEach(el => {
                    const pct = (el.textContent.match(/\d+%/) || [''])[0];
                    el.textContent = `⚠️ ${pct}`.trim();
                });
                document.querySelectorAll('.divergence-consensus-badge.medium').forEach(el => {
                    const pct = (el.textContent.match(/\d+%/) || [''])[0];
                    el.textContent = `ℹ️ ${pct}`.trim();
                });
                document.querySelectorAll('.divergence-risk-implication-label').forEach(el => {
                    el.textContent = 'Trading Implication';
                });
            } catch (e) {
                console.warn('sanitizeUIArtifacts failed:', e);
            }
        }

        function renderRiskAndDivergenceMonitor(riskItems, divergenceAlerts, updatedAt = null) {
            const container = document.getElementById('risk-items');
            if (!container) return;

            // Update section title with status indicator badge
            const sectionTitle = document.querySelector('.risk-monitor .section-title');
            if (sectionTitle && updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                sectionTitle.innerHTML = `🚨 Risk & Divergence Monitor <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            }

            container.innerHTML = '';

            // Categorize divergence alerts
            const criticalDivergences = divergenceAlerts.filter(d => d.tier === 'CRITICAL');
            const highDivergences = divergenceAlerts.filter(d => d.tier === 'HIGH');
            const mediumDivergences = divergenceAlerts.filter(d => d.tier === 'MEDIUM');

            // Render CRITICAL DIVERGENCES section
            if (criticalDivergences.length > 0) {
                const criticalSection = createRiskCategory('🚨', 'Critical Divergences (Consensus <50%)', 'critical');
                criticalDivergences.forEach(alert => {
                    criticalSection.appendChild(createDivergenceCard(alert, 'critical'));
                });
                container.appendChild(criticalSection);
            }

            // Render HIGH DIVERGENCES section
            if (highDivergences.length > 0) {
                const highSection = createRiskCategory('⚠️', 'High Divergences (Consensus 50-69%)', 'high');
                highDivergences.forEach(alert => {
                    highSection.appendChild(createDivergenceCard(alert, 'high'));
                });
                container.appendChild(highSection);
            }

            // Render MEDIUM DIVERGENCES section
            if (mediumDivergences.length > 0) {
                const mediumSection = createRiskCategory('ℹ️', 'Medium Divergences', 'medium');
                mediumDivergences.forEach(alert => {
                    mediumSection.appendChild(createDivergenceCard(alert, 'medium'));
                });
                container.appendChild(mediumSection);
            }

            // Render TECHNICAL & STRUCTURAL RISKS section
            if (riskItems.length > 0) {
                const techSection = createRiskCategory('📊', 'Technical & Structural Risks', 'technical');
                riskItems.forEach(item => {
                    const riskDiv = document.createElement('div');
                    riskDiv.className = 'risk-item';

                    const title = document.createElement('div');
                    title.className = 'risk-title';
                    title.textContent = item.title || '';

                    const desc = document.createElement('div');
                    desc.className = 'risk-description';
                    desc.textContent = item.description || '';

                    riskDiv.appendChild(title);
                    riskDiv.appendChild(desc);
                    techSection.appendChild(riskDiv);
                });
                container.appendChild(techSection);
            }
        }

        function createRiskCategory(icon, title, type) {
            const section = document.createElement('div');
            section.className = 'risk-category';

            const header = document.createElement('div');
            header.className = 'risk-category-header';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'risk-category-icon';
            iconSpan.textContent = icon;

            const titleSpan = document.createElement('span');
            titleSpan.className = 'risk-category-title';
            titleSpan.textContent = title;

            header.appendChild(iconSpan);
            header.appendChild(titleSpan);
            section.appendChild(header);

            return section;
        }

        function createDivergenceCard(alert, severity) {
            const card = document.createElement('div');
            card.className = `divergence-risk-card ${severity}`;

            const header = document.createElement('div');
            header.className = 'divergence-risk-header';

            const badge = document.createElement('span');
            badge.className = `divergence-consensus-badge ${severity}`;
            const icon = severity === 'critical' ? '🔴' : severity === 'high' ? '🟡' : '🟢';
            badge.textContent = `${icon} ${alert.agreement}%`;

            const title = document.createElement('span');
            title.className = 'divergence-risk-title';
            title.textContent = alert.topic;

            header.appendChild(badge);
            header.appendChild(title);

            const description = document.createElement('div');
            description.className = 'divergence-risk-description';
            description.textContent = alert.alert;

            const implication = document.createElement('div');
            implication.className = 'divergence-risk-implication';

            const implLabel = document.createElement('div');
            implLabel.className = 'divergence-risk-implication-label';
            implLabel.textContent = '💡 Trading Implication';

            const implText = document.createElement('div');
            implText.className = 'divergence-risk-implication-text';
            implText.textContent = alert.tradingImplication;

            implication.appendChild(implLabel);
            implication.appendChild(implText);

            card.appendChild(header);
            card.appendChild(description);
            card.appendChild(implication);

            return card;
        }

        function renderSentimentCards(cards, updatedAt) {
            const grid = document.getElementById('sentiment-grid');
            if (!grid) {
                return;
            }

            // Update section title with status indicator badge
            const sectionTitle = document.querySelector('.sentiment-overview .section-title');
            if (sectionTitle && updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                sectionTitle.innerHTML = `Market Sentiment Overview <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            }

            grid.innerHTML = '';

            if (!cards.length) {
                grid.innerHTML = '<p style="color: #9ca3af;">No sentiment data available.</p>';
                return;
            }

            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'sentiment-card';
                if (card.id) {
                    cardEl.dataset.topic = card.id;
                    cardEl.addEventListener('click', () => showDetail(card.id));
                }

                const labelEl = document.createElement('div');
                labelEl.className = 'sentiment-label';
                labelEl.textContent = card.label || '';

                const valueEl = document.createElement('div');
                valueEl.className = 'sentiment-value';
                valueEl.textContent = card.value || '';

                const detailEl = document.createElement('div');
                detailEl.style.color = card.detailColor || '#e0e6f0';
                detailEl.style.fontSize = '0.9em';
                detailEl.style.marginTop = '5px';
                detailEl.textContent = card.detail || '';

                cardEl.appendChild(labelEl);
                cardEl.appendChild(valueEl);
                cardEl.appendChild(detailEl);

                cardEl.addEventListener('mouseenter', () => {
                    cardEl.style.transform = 'translateY(-5px) scale(1.02)';
                });

                cardEl.addEventListener('mouseleave', () => {
                    cardEl.style.transform = 'translateY(0) scale(1)';
                });

                grid.appendChild(cardEl);
            });
        }






        function renderMetrics(metrics, updatedAt) {
            const grid = document.getElementById('metrics-grid');
            if (!grid) {
                return;
            }

            // Update section title with status indicator badge
            const sectionTitle = document.querySelector('.metrics-grid').previousElementSibling;
            if (sectionTitle && sectionTitle.classList.contains('section-title') && updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                sectionTitle.innerHTML = `Key Market Metrics <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            }

            grid.innerHTML = '';

            if (!metrics.length) {
                grid.innerHTML = '<p style="color: #9ca3af;">No metrics available.</p>';
                return;
            }

            // Group metrics by asset
            const grouped = {};
            const order = ['S&P 500', 'BTC', 'ETH', 'SPY', 'QQQ', 'Fed', 'Gold'];

            metrics.forEach(metric => {
                const label = metric.label || '';
                let assetKey = 'Other';

                if (label.includes('S&P 500')) assetKey = 'S&P 500';
                else if (label.includes('BTC')) assetKey = 'BTC';
                else if (label.includes('ETH')) assetKey = 'ETH';
                else if (label.includes('SPY')) assetKey = 'SPY';
                else if (label.includes('QQQ')) assetKey = 'QQQ';
                else if (label.includes('Fed')) assetKey = 'Fed';
                else if (label.includes('Gold')) assetKey = 'Gold';

                if (!grouped[assetKey]) grouped[assetKey] = [];
                grouped[assetKey].push(metric);
            });

            // Render grouped metrics
            order.forEach(assetKey => {
                if (!grouped[assetKey]) return;

                const card = document.createElement('div');
                card.className = 'metric-card';

                // Asset header
                const header = document.createElement('div');
                header.style.cssText = 'font-size: 0.9em; font-weight: 600; color: #818cf8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;';
                header.textContent = assetKey;
                card.appendChild(header);

                // Sort metrics: Resistance/Target first, then Current, then Support
                const sortedMetrics = grouped[assetKey].sort((a, b) => {
                    const labelA = a.label.toLowerCase();
                    const labelB = b.label.toLowerCase();

                    if (labelA.includes('target') || labelA.includes('resistance')) return -1;
                    if (labelB.includes('target') || labelB.includes('resistance')) return 1;
                    if (labelA.includes('current')) return -1;
                    if (labelB.includes('current')) return 1;
                    return 0;
                });

                // Metric items
                sortedMetrics.forEach((metric, idx) => {
                    const item = document.createElement('div');
                    item.style.cssText = idx > 0 ? 'margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(99, 102, 241, 0.2);' : '';

                    const itemLabel = document.createElement('div');
                    itemLabel.style.cssText = 'font-size: 0.75em; color: #9ca3af; margin-bottom: 4px;';
                    itemLabel.textContent = metric.label.replace(assetKey + ' ', '');

                    const itemValue = document.createElement('div');
                    itemValue.style.cssText = 'font-size: 1.1em; font-weight: 600; color: #e0e6f0;';
                    itemValue.textContent = metric.value || '';

                    item.appendChild(itemLabel);
                    item.appendChild(itemValue);
                    card.appendChild(item);
                });

                grid.appendChild(card);
            });

            // Render ungrouped metrics (Fed, Gold, etc.)
            if (grouped['Other']) {
                grouped['Other'].forEach(metric => {
                    const card = document.createElement('div');
                    card.className = 'metric-card';

                    const label = document.createElement('div');
                    label.className = 'metric-label';
                    label.textContent = metric.label || '';

                    const value = document.createElement('div');
                    value.style.cssText = 'font-size: 1.1em; font-weight: 600; color: #e0e6f0;';
                    value.textContent = metric.value || '';

                    card.appendChild(label);
                    card.appendChild(value);
                    grid.appendChild(card);
                });
            }
        }




        function createTab(id, label) {
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.tab = id;
            tab.textContent = label;
            tab.onclick = function() {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab and corresponding content
                this.classList.add('active');
                const content = document.getElementById(id + '-content');
                if (content) content.classList.add('active');
            };
            return tab;
        }

        function createTabContent(id) {
            const content = document.createElement('div');
            content.id = id + '-content';
            content.className = 'tab-content';
            return content;
        }

        function renderProviderTabs(tabs, dailyPlanner, endOfDay, dashboard) {
            const tabsContainer = document.getElementById('provider-tabs');
            const contentsContainer = document.getElementById('provider-contents');
            if (!tabsContainer || !contentsContainer) return;

            tabsContainer.innerHTML = '';
            contentsContainer.innerHTML = '';

            // Add Daily Planner Tab first
            const dailyPlannerTab = createTab('daily-planner', '📅 Daily Planner');
            tabsContainer.appendChild(dailyPlannerTab);
            const dailyPlannerContent = createTabContent('daily-planner');
            contentsContainer.appendChild(dailyPlannerContent);
            if (dailyPlanner) {
                dailyPlannerContent.appendChild(renderDailyPlanner(dailyPlanner, endOfDay, dashboard));
            }

            tabs.forEach((tab, index) => {
                const tabEl = createTab(tab.id, tab.label);
                tabsContainer.appendChild(tabEl);

                const contentEl = createTabContent(tab.id);
                contentsContainer.appendChild(contentEl);

                // Special tab rendering (these handle their own AI interpretation)
                if (tab.id === 'portfolio') {
                    // 1. ADD AI NARRATIVE BRIEFING FIRST (at top, like other tabs)
                    if (tab.aiInterpretation) {
                        contentEl.innerHTML += renderAIInterpretation(tab.aiInterpretation);
                    }

                    // 2. Portfolio tab - Two-column layout: Signal+Allocation (left) | Actions+Risks (right)
                    if (tab.portfolioRecommendation) {
                        const rec = tab.portfolioRecommendation;
                        const signalColor = rec.signalTier === 'WEAK' ? '#fca5a5' :
                                          rec.signalTier === 'AVOID' ? '#ef4444' :
                                          rec.signalTier === 'MODERATE' ? '#fbbf24' : '#10b981';
                        const portfolioStatusClass = rec.updatedAt ? getDataFreshness(rec.updatedAt) : 'status-error';

                        // Prepare allocation data
                        const allocationData = {
                            allocation: rec.allocation || { cash: 40, equities: 30, crypto: 20, hedges: 10 },
                            signalScore: rec.signalScore || 50,
                            signalTier: rec.signalTier || 'MODERATE'
                        };

                        // Create segments for donut (using actual allocation keys from YAML)
                        const segments = [
                            { label: 'Cash/Defensive', value: allocationData.allocation.cash || 40, color: '#10b981' },
                            { label: 'Equities', value: allocationData.allocation.equities || 30, color: '#3b82f6' },
                            { label: 'Crypto', value: allocationData.allocation.crypto || 20, color: '#8b5cf6' },
                            { label: 'Hedges', value: allocationData.allocation.hedges || 10, color: '#f59e0b' }
                        ];

                        // Build two-column layout
                        contentEl.innerHTML += `
                            <div style="display: grid; grid-template-columns: 35% 65%; gap: 20px; margin-top: 20px;">
                                <!-- LEFT COLUMN: Signal & Allocation -->
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <!-- Signal Card -->
                                    <div class="glass-card" style="background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); padding: 18px; border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2);">
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                                            <span style="color: #9ca3af; font-size: 0.85em;">SIGNAL SCORE</span>
                                            <span class="date-badge ${portfolioStatusClass}" style="margin: 0;"></span>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 2.2em; font-weight: bold; background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px;">${allocationData.signalScore}</div>
                                            <div style="background: rgba(${signalColor === '#fbbf24' ? '251, 191, 36' : '16, 185, 129'}, 0.15); color: ${signalColor}; padding: 6px 12px; border-radius: 6px; font-weight: 500; font-size: 0.9em; display: inline-block;">${allocationData.signalTier}</div>
                                        </div>
                                    </div>

                                    <!-- Allocation Card -->
                                    <div class="glass-card" style="background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); padding: 18px; border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2);">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                            <h3 style="color: #6366f1; margin: 0; font-size: 1em;">📊 ALLOCATION</h3>
                                            <span class="date-badge ${portfolioStatusClass}" style="margin: 0;"></span>
                                        </div>
                                        <div style="position: relative; width: 120px; height: 120px; margin: 0 auto 15px;">
                                            <svg width="120" height="120" viewBox="0 0 120 120" style="transform: rotate(-90deg);">
                                                ${renderDonutSegments(segments, 60, 60, 40, 20)}
                                            </svg>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                                            ${segments.map(seg => `
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <div style="width: 8px; height: 8px; background: ${seg.color}; border-radius: 2px;"></div>
                                                        <span style="color: #d1d5db;">${seg.label}</span>
                                                    </div>
                                                    <span style="color: #6366f1; font-weight: 600;">${seg.value}%</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT COLUMN: Actions & Risks -->
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <!-- Actions Card -->
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                            <h3 style="color: #6366f1; margin: 0; font-size: 1em;">⚡ RECOMMENDED ACTIONS</h3>
                                            <span class="date-badge ${portfolioStatusClass}" style="margin: 0;"></span>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 10px;">
                                            ${rec.actions.map((action, idx) => `
                                                <div class="glass-card" style="background: rgba(99, 102, 241, 0.08); backdrop-filter: blur(10px); padding: 14px; border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.2);">
                                                    <div style="display: flex; gap: 10px;">
                                                        <div style="color: #6366f1; font-weight: 700; min-width: 20px; font-size: 0.95em;">${idx + 1}.</div>
                                                        <div>
                                                            <div style="color: #e0e6f0; font-weight: 500; font-size: 0.95em; line-height: 1.4;">${action.action}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <!-- Risks Card -->
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                            <h3 style="color: #f87171; margin: 0; font-size: 1em;">⚠️ KEY RISKS</h3>
                                            <span class="date-badge ${portfolioStatusClass}" style="margin: 0;"></span>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            ${rec.keyRisks.map(risk => `
                                                <div style="display: flex; gap: 8px; font-size: 0.9em; color: #d1d5db; padding: 8px; border-left: 2px solid rgba(248, 113, 113, 0.4);">
                                                    <span style="color: #ef4444; flex-shrink: 0;">!</span>
                                                    <span style="line-height: 1.3;">${risk}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else if (tab.id === 'xsentiment') {
                    contentEl.innerHTML += renderXSentiment(tab);
                } else if (tab.id === 'markets') {
                    // Enhanced visual Markets Intelligence dashboard; replace content to avoid duplicate render cycles
                    // Pass allTabs so it can access X Sentiment data
                    contentEl.innerHTML = renderMarketsIntelligence(tab, tabs);
                } else if (tab.id === 'media') {
                    // Render Media & Catalysts custom layout
                    contentEl.innerHTML += renderMediaCatalysts(tab);
                } else {
                    // Standard tabs: Add AI interpretation first
                    if (tab.aiInterpretation) {
                        contentEl.innerHTML += renderAIInterpretation(tab.aiInterpretation);
                    }

                    // Special handling for technicals tab - PROVIDERS + SIGNAL SCORE SIDE-BY-SIDE
                    if (tab.id === 'technicals') {
                        // Create flex container for providers + signal score
                        const technicalsRow = document.createElement('div');
                        technicalsRow.className = 'technicals-providers-signal-row';

                        // Add providers in a grid section
                        if (tab.providers) {
                            const providersSection = document.createElement('div');
                            providersSection.className = 'technicals-providers-section provider-insights';

                            const providers = Array.isArray(tab.providers) ? tab.providers : [];
                            providers.forEach(provider => {
                                const providerCard = document.createElement('div');
                                providerCard.className = 'provider-card';

                                const providerNameContainer = document.createElement('div');
                                providerNameContainer.className = 'provider-name';
                                providerNameContainer.style.display = 'flex';
                                providerNameContainer.style.alignItems = 'center';
                                providerNameContainer.style.gap = '10px';

                                const nameText = document.createElement('span');
                                nameText.textContent = provider.name || '';
                                providerNameContainer.appendChild(nameText);

                                // Add green dot badge if updatedAt exists
                                if (provider.updatedAt) {
                                    const statusClass = getDataFreshness(provider.updatedAt);
                                    const badge = document.createElement('span');
                                    badge.className = `date-badge ${statusClass}`;
                                    badge.style.margin = '0';
                                    providerNameContainer.appendChild(badge);
                                }

                                providerCard.appendChild(providerNameContainer);

                                (provider.insights || []).forEach(insight => {
                                    const insightDiv = document.createElement('div');
                                    insightDiv.className = 'key-insight';
                                    insightDiv.textContent = insight;
                                    providerCard.appendChild(insightDiv);
                                });

                                providersSection.appendChild(providerCard);
                            });

                            // Add Unusual Activity Monitor to left column
                            const unusualActivityHTML = renderUnusualActivityMonitor(tab);
                            if (unusualActivityHTML) {
                                const activityContainer = document.createElement('div');
                                activityContainer.innerHTML = unusualActivityHTML;
                                providersSection.appendChild(activityContainer.firstElementChild);
                            }

                            technicalsRow.appendChild(providersSection);
                        }

                        // Add Trading Signal Score section
                        if (dailyPlanner && dailyPlanner.signalData) {
                            const signalScoreSection = document.createElement('div');
                            signalScoreSection.className = 'technicals-signal-score-section';

                            signalScoreSection.appendChild(
                                renderSignalData(dailyPlanner.signalData, {
                                    plannerData: dailyPlanner,
                                    dashboardData: dashboard,
                                    endOfDayData: dailyPlanner.endOfDay || {}
                                }, tab.tradingSignalScore?.updatedAt)
                            );

                            technicalsRow.appendChild(signalScoreSection);
                        }

                        contentEl.appendChild(technicalsRow);
                    } else if (tab.id === 'news_catalysts') {
                        // Special handling for news_catalysts tab - render catalyst sections FIRST, then Daily News Flow
                        if (tab.sections && Array.isArray(tab.sections)) {
                            // Separate catalyst sections from daily news flow
                            const catalystSections = tab.sections.filter(s => s.name !== '📰 Daily News Flow');
                            const newsFlowSection = tab.sections.find(s => s.name === '📰 Daily News Flow');

                            // Render catalyst sections first
                            catalystSections.forEach(section => {
                                let sectionHTML = '<div class="news-catalysts-section" style="margin-bottom: 30px;">';

                                // Section name header with timestamp badge (badge on LEFT)
                                if (section.name) {
                                    const statusClass = section.updatedAt ? getDataFreshness(section.updatedAt) : 'status-error';
                                    sectionHTML += `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #374151;">
                                        <span class="date-badge ${statusClass}" style="margin: 0; flex-shrink: 0;"></span>
                                        <h3 style="color: #6366f1; margin: 0;">${section.name}</h3>
                                    </div>`;
                                }

                                // Catalyst sections - render items as cards
                                if (section.items && Array.isArray(section.items)) {
                                    section.items.forEach(item => {
                                        const convictionColor = item.conviction === 'CRITICAL' ? '#ef4444' : item.conviction === 'HIGH' ? '#f59e0b' : '#6366f1';

                                        // Render tags if available
                                        let tagsHTML = '';
                                        if (item.tags && Array.isArray(item.tags) && item.tags.length > 0) {
                                            tagsHTML = '<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">';
                                            item.tags.forEach(tag => {
                                                const tagColor = getTagColor(tag);
                                                tagsHTML += `
                                                    <span style="background: ${tagColor}20; border: 1px solid ${tagColor}40; color: ${tagColor}; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500;">
                                                        ${tag}
                                                    </span>
                                                `;
                                            });
                                            tagsHTML += '</div>';
                                        }

                                        // Make source/link clickable if link exists
                                        let sourceLinkHTML = '';
                                        if (item.link && item.source) {
                                            const isInternalLink = item.link.startsWith('#');
                                            const linkTarget = isInternalLink ? '' : 'target="_blank" rel="noopener noreferrer"';
                                            sourceLinkHTML = `
                                                <a href="${item.link}" ${linkTarget} style="color: #6366f1; font-size: 0.85em; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s; cursor: pointer;">
                                                    <span>📍</span>
                                                    <span style="border-bottom: 1px solid transparent;">${item.source}</span>
                                                    <span style="font-size: 0.7em;">${isInternalLink ? '→' : '↗'}</span>
                                                </a>
                                            `;
                                        } else if (item.source) {
                                            sourceLinkHTML = `<div style="color: #6366f1; font-size: 0.85em;">📍 ${item.source}</div>`;
                                        }

                                        sectionHTML += `
                                            <div class="catalyst-card" style="background: #1f2937; border-left: 4px solid ${convictionColor}; padding: 15px; margin-bottom: 15px; border-radius: 4px; transition: transform 0.2s, box-shadow 0.2s;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                    <div style="font-weight: 600; color: #f3f4f6; font-size: 1.05em;">${item.title || ''}</div>
                                                    <div style="background: ${convictionColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75em; font-weight: 600; white-space: nowrap; margin-left: 10px;">${item.conviction || ''}</div>
                                                </div>
                                                ${item.date ? `<div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 8px;">📅 ${item.date}</div>` : ''}
                                                <div style="color: #d1d5db; line-height: 1.5; margin-bottom: 8px;">${highlightKeyTerms(item.blurb || '')}</div>
                                                ${sourceLinkHTML}
                                                ${tagsHTML}
                                            </div>
                                        `;
                                    });
                                }

                                sectionHTML += '</div>';
                                contentEl.innerHTML += sectionHTML;
                            });

                            // Render Daily News Flow section last
                            if (newsFlowSection) {
                                let newsHTML = '<div class="news-catalysts-section" style="margin-bottom: 30px;">';

                                // Section header with timestamp badge (badge on LEFT)
                                const newsStatusClass = newsFlowSection.rss_updated_at ? getDataFreshness(newsFlowSection.rss_updated_at) : 'status-error';
                                newsHTML += `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #374151;">
                                    <span class="date-badge ${newsStatusClass}" style="margin: 0; flex-shrink: 0;"></span>
                                    <h3 style="color: #6366f1; margin: 0;">${newsFlowSection.name}</h3>
                                </div>`;

                                if (newsFlowSection.rss_summary) {
                                    newsHTML += renderRSSSummary(newsFlowSection.rss_summary);
                                }

                                newsHTML += '</div>';
                                contentEl.innerHTML += newsHTML;
                            }
                        }
                    } else {
                        // Non-technicals, non-markets, non-news_catalysts tabs: render providers normally
                        if (tab.providers) {
                            let providersHTML = '<div class="provider-insights">';
                            const providers = Array.isArray(tab.providers) ? tab.providers : [];
                            providers.forEach(provider => {
                                providersHTML += `
                                    <div class="provider-card">
                                        <div class="provider-name">${provider.name || ''}</div>
                                        ${(provider.insights || []).map(insight => `<div class="key-insight">${insight}</div>`).join('')}
                                    </div>
                                `;
                            });
                            providersHTML += '</div>';
                            contentEl.innerHTML += providersHTML;
                        }
                    }

                    // Special handling for technicals tab - TRADING LEVELS
                    if (tab.id === 'technicals') {
                        // Render Trading Levels Dashboards side-by-side (SPY & QQQ)
                        let tradingLevelsHTML = '<div class="trading-levels-container">';

                        if (tab.optionsData && tab.optionsData.SPY) {
                            const spyTradingLevelsHTML = renderTradingLevelsDashboard(tab.optionsData.SPY, dashboard.metrics, 'SPY');
                            tradingLevelsHTML += spyTradingLevelsHTML;
                        }

                        if (tab.optionsData && tab.optionsData.QQQ) {
                            const qqqTradingLevelsHTML = renderTradingLevelsDashboard(tab.optionsData.QQQ, dashboard.metrics, 'QQQ');
                            tradingLevelsHTML += qqqTradingLevelsHTML;
                        }

                        tradingLevelsHTML += '</div>';
                        contentEl.innerHTML += tradingLevelsHTML;
                    }
                }
            });

            // Activate the first tab by default
            const firstTab = tabsContainer.querySelector('.tab');
            if (firstTab) {
                firstTab.classList.add('active');
                const firstContent = document.getElementById(firstTab.dataset.tab + '-content');
                if (firstContent) {
                    firstContent.classList.add('active');
                }
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabId + '-tab');
            });

            document.querySelectorAll('.tab').forEach(button => {
                button.classList.toggle('active', button.dataset.tabTarget === tabId);
            });
        }

        function showDetail(topic) {
            console.log('Showing details for:', topic);
        }

        function showError(message) {
            const banner = document.getElementById('dashboard-error');
            if (!banner) {
                return;
            }
            banner.textContent = message;
            banner.classList.add('active');
        }

        function renderQuickActions(quickActions, updatedAt) {
            const grid = document.getElementById('quick-actions-grid');
            if (!grid) return;

            // Update section title with status indicator badge
            const sectionTitle = document.querySelector('.quick-actions-panel .section-title');
            if (sectionTitle && updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                sectionTitle.innerHTML = `⚡ Immediate Actions <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            }

            grid.innerHTML = '';
            if (!quickActions.length) {
                grid.innerHTML = '<p style="color: #9ca3af;">No quick actions available.</p>';
                return;
            }

            quickActions.forEach(action => {
                const card = document.createElement('div');
                card.className = `quick-action-card urgency-${action.urgency || 'low'}`;

                const header = document.createElement('div');
                header.className = 'action-header';

                const icon = document.createElement('span');
                icon.className = 'action-icon';
                icon.textContent = action.icon || '📌';

                const type = document.createElement('span');
                type.className = 'action-type';
                type.textContent = (action.type || 'action').toUpperCase();

                header.appendChild(icon);
                header.appendChild(type);

                const title = document.createElement('h3');
                title.className = 'action-title';
                title.textContent = action.title || 'Action';

                const value = document.createElement('div');
                value.className = 'action-value';
                value.textContent = action.value || '';

                const description = document.createElement('p');
                description.className = 'action-description';
                description.textContent = action.description || '';

                card.appendChild(header);
                card.appendChild(title);
                card.appendChild(value);
                card.appendChild(description);

                grid.appendChild(card);
            });
        }

        function renderSentimentTimeline(sentimentHistory, updatedAt) {
            const canvas = document.getElementById('sentimentChart');
            if (!canvas) return;

            // Update section title with status indicator badge
            const sectionTitle = document.querySelector('.sentiment-timeline .section-title');
            if (sectionTitle && updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                sectionTitle.innerHTML = `📈 Sentiment Timeline (Last 30 Days) <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            }

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            if (!sentimentHistory || !sentimentHistory.length) {
                ctx.fillStyle = '#9ca3af';
                ctx.font = '14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No sentiment history available', width / 2, height / 2);
                return;
            }

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // Draw axes labels
            ctx.fillStyle = '#9ca3af';
            ctx.font = '12px Inter, sans-serif';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                const value = 100 - (i * 25);
                ctx.fillText(value.toString(), padding - 10, y + 4);
            }

            // Calculate points
            const points = sentimentHistory.map((item, index) => {
                const x = padding + (width - 2 * padding) * index / (sentimentHistory.length - 1);
                const y = padding + (height - 2 * padding) * (1 - item.score / 100);
                return { x, y, ...item };
            });

            // Draw gradient fill
            const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(points[0].x, height - padding);
            points.forEach(point => ctx.lineTo(point.x, point.y));
            ctx.lineTo(points[points.length - 1].x, height - padding);
            ctx.closePath();
            ctx.fill();

            // Draw line
            ctx.strokeStyle = '#6366f1';
            ctx.lineWidth = 3;
            ctx.beginPath();
            points.forEach((point, index) => {
                if (index === 0) ctx.moveTo(point.x, point.y);
                else ctx.lineTo(point.x, point.y);
            });
            ctx.stroke();

            // Draw points
            points.forEach(point => {
                ctx.fillStyle = '#1e1b4b';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 6, 0, 2 * Math.PI);
                ctx.fill();

                ctx.strokeStyle = '#6366f1';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Draw date labels
            ctx.fillStyle = '#9ca3af';
            ctx.font = '11px Inter, sans-serif';
            ctx.textAlign = 'center';
            points.forEach((point, index) => {
                if (index % Math.ceil(points.length / 5) === 0 || index === points.length - 1) {
                    const date = new Date(point.date);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    ctx.fillText(label, point.x, height - padding + 20);
                }
            });
        }

        function renderProviderConsensus(providerConsensus, updatedAt = null) {
            const container = document.getElementById('consensus-items');
            if (!container) return;

            // Update section title with status indicator badge
            const sectionTitle = document.querySelector('.consensus-heatmap .section-title');
            if (sectionTitle && updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                sectionTitle.innerHTML = `🎯 Analyst Consensus <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            }

            container.innerHTML = '';

            // Handle new themes structure from providerConsensus.themes
            const themes = providerConsensus?.themes || providerConsensus;

            if (!themes || (Array.isArray(themes) && !themes.length)) {
                container.innerHTML = '<p style="color: #9ca3af;">No consensus data available.</p>';
                return;
            }

            const themeArray = Array.isArray(themes) ? themes : [];

            themeArray.forEach((item, idx) => {
                const consensusItem = document.createElement('div');
                consensusItem.className = 'consensus-item';
                consensusItem.style.animation = `fadeInUp ${0.4 + idx * 0.1}s ease forwards`;
                consensusItem.style.opacity = '0';

                // Left side container - badge above topic (vertical stack)
                const leftSide = document.createElement('div');
                leftSide.style.display = 'flex';
                leftSide.style.flexDirection = 'column';
                leftSide.style.gap = '6px';
                leftSide.style.flex = '0 0 280px';

                // Sentiment badge - tiny, subtle pill above topic
                const sentiment = item.sentiment || 'NEUTRAL';
                const sentimentColor = sentiment.includes('BULLISH') ? '#10b981' :
                                      sentiment.includes('BEARISH') ? '#ef4444' : '#f59e0b';

                const sentimentBadge = document.createElement('span');
                sentimentBadge.style.background = `${sentimentColor}10`;
                sentimentBadge.style.color = sentimentColor;
                sentimentBadge.style.padding = '2px 6px';
                sentimentBadge.style.borderRadius = '3px';
                sentimentBadge.style.fontSize = '0.65em';
                sentimentBadge.style.fontWeight = '500';
                sentimentBadge.style.textTransform = 'uppercase';
                sentimentBadge.style.letterSpacing = '0.05em';
                sentimentBadge.style.width = 'fit-content';
                sentimentBadge.style.opacity = '0.75';
                sentimentBadge.textContent = sentiment.replace('_', ' ');

                const topic = document.createElement('div');
                topic.className = 'consensus-topic';
                topic.textContent = item.theme || item.topic || 'Topic';

                leftSide.appendChild(sentimentBadge);
                leftSide.appendChild(topic);

                const description = document.createElement('div');
                description.className = 'consensus-providers';
                description.style.color = '#d1d5db';
                description.style.lineHeight = '1.6';
                description.style.flex = '1';
                description.textContent = item.description || '';

                consensusItem.appendChild(leftSide);
                consensusItem.appendChild(description);

                container.appendChild(consensusItem);
            });
        }

        function getVelocityPresentation(velocity) {
            const raw = velocity ?? '';
            let display = typeof raw === 'number' ? raw.toString() : String(raw).trim();
            if (!display) {
                display = 'N/A';
            }

            let numeric = 0;
            if (typeof raw === 'number') {
                numeric = raw;
            } else {
                const match = display.match(/-?\d+(\.\d+)?/);
                if (match) {
                    numeric = parseFloat(match[0]);
                    if (display.trim().startsWith('-') && !match[0].startsWith('-')) {
                        numeric = -numeric;
                    }
                }
            }

            const color = numeric > 0 ? '#10b981' : (numeric < 0 ? '#ef4444' : '#9ca3af');
            const arrow = numeric > 0 ? '▲' : (numeric < 0 ? '▼' : '▶');

            return {
                color,
                arrow,
                value: display || 'N/A'
            };
        }

        function getSignalPresentation(signal) {
            if (!signal) {
                return null;
            }

            const value = signal.toString();
            const normalized = value.toUpperCase();
            let color = '#6b7280';
            let emoji = '➡️';

            if (normalized.includes('HOT')) {
                color = '#ef4444';
                emoji = '🔥';
            } else if (
                normalized.includes('RISING') ||
                normalized.includes('BULL') ||
                normalized.includes('UPTREND') ||
                normalized.includes('UP-TREND') ||
                normalized.includes('UP TREND') ||
                normalized.includes('UPWARD')
            ) {
                color = '#10b981';
                emoji = '📈';
            } else if (
                normalized.includes('COOL') ||
                normalized.includes('BEAR') ||
                normalized.includes('DOWN') ||
                normalized.includes('DOWNTREND') ||
                normalized.includes('DOWN-TREND') ||
                normalized.includes('DOWN TREND') ||
                normalized.includes('DOWNWARD')
            ) {
                color = '#ef4444';
                emoji = '📉';
            }

            return {
                color,
                emoji,
                label: value
            };
        }

        function getBriefText(text, limit = 120) {
            if (!text) {
                return '';
            }

            const clean = text.toString().trim();
            if (!clean) {
                return '';
            }

            if (clean.length <= limit) {
                return clean;
            }

            const sentenceEnd = clean.indexOf('. ');
            if (sentenceEnd !== -1 && sentenceEnd + 1 <= limit) {
                return clean.slice(0, sentenceEnd + 1).trim();
            }

            return clean.slice(0, limit).trim() + '...';
        }

        function buildNarrativeDetail(narrative, velocityMeta, signalMeta) {
            if (!narrative) {
                return '';
            }

            const parts = [];

            if (typeof narrative.mentions !== 'undefined') {
                parts.push(`Mentions (24h): ${narrative.mentions}`);
            }

            if (velocityMeta?.value) {
                parts.push(`Velocity: ${velocityMeta.value}`);
            } else if (narrative.velocity) {
                parts.push(`Velocity: ${narrative.velocity}`);
            }

            if (narrative.trend) {
                parts.push(`Trend: ${narrative.trend}`);
            }

            if (signalMeta?.label) {
                parts.push(`Signal: ${signalMeta.emoji} ${signalMeta.label}`);
            } else if (typeof narrative.signal === 'string') {
                parts.push(`Signal: ${narrative.signal}`);
            }

            if (narrative.focus) {
                parts.push(`Focus: ${narrative.focus}`);
            } else if (narrative.theme) {
                parts.push(`Theme: ${narrative.theme}`);
            }

            if (parts.length === 0) {
                return '';
            }

            return parts.join(' · ');
        }

        function getSentimentTier(score) {
            if (!score || score === 'N/A') {
                return { label: 'Unknown', color: '#6b7280' };
            }

            const numScore = typeof score === 'number' ? score : parseFloat(score);

            if (isNaN(numScore)) {
                return { label: 'Unknown', color: '#6b7280' };
            }

            if (numScore >= 90) return { label: 'Extreme Greed', color: '#ef4444' };
            if (numScore >= 75) return { label: 'Greed', color: '#f59e0b' };
            if (numScore >= 65) return { label: 'Bullish', color: '#10b981' };
            if (numScore >= 55) return { label: 'Neutral-Bullish', color: '#3b82f6' };
            if (numScore >= 45) return { label: 'Neutral', color: '#8b5cf6' };
            if (numScore >= 35) return { label: 'Neutral-Bearish', color: '#6366f1' };
            if (numScore >= 25) return { label: 'Bearish', color: '#f59e0b' };
            if (numScore >= 10) return { label: 'Fear', color: '#ef4444' };
            return { label: 'Extreme Fear', color: '#dc2626' };
        }

        function renderXSentiment(tab) {
            let html = '';

            // AI Interpretation at top
            if (tab.aiInterpretation) {
                html += renderAIInterpretation(tab.aiInterpretation);
            }

            // Add status indicator for X Sentiment section title
            const xSentimentStatusClass = tab.aiInterpretation ? getDataFreshness(tab.aiInterpretation.updatedAt) : 'status-error';
            const xSentimentIndicator = `<span class="date-badge ${xSentimentStatusClass}" style="margin-left: 10px; display: inline-block;"></span>`;

            // Section title with status indicator
            html += `
                <div style="display: flex; align-items: center; margin: 20px 0; padding-bottom: 10px; border-bottom: 1px solid rgba(99, 102, 241, 0.2);">
                    <h3 style="margin: 0; color: #e0e6f0; font-size: 1.1em;">X/Twitter Sentiment Analysis</h3>
                    ${xSentimentIndicator}
                </div>
            `;

            // Sentiment Score Widget
            html += `
                <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center;">
                        <div>
                            <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 8px;">X/Twitter Sentiment</div>
                            <div style="font-size: 3em; font-weight: bold; background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px;">
                                ${tab.sentimentScore || 'N/A'}<span style="font-size: 0.35em; color: #9ca3af; font-weight: 500;">/100</span>
                                ${(() => {
                                    if (tab.sentimentTrend === 'up') return '<span class="sentiment-trend-arrow sentiment-trend-up">▲</span>';
                                    if (tab.sentimentTrend === 'down') return '<span class="sentiment-trend-arrow sentiment-trend-down">▼</span>';
                                    if (tab.sentimentTrend === 'neutral') return '<span class="sentiment-trend-arrow sentiment-trend-neutral">▶</span>';
                                    return '';
                                })()}
                            </div>
                            <div style="color: #10b981; font-size: 0.85em; font-weight: 600; margin-top: 5px;">${tab.sentimentTier || ''}</div>
                        </div>
                        <div>
                            <div style="color: #d1d5db; font-size: 0.85em; margin-bottom: 8px;">Contrarian Signal</div>
                            <div style="font-size: 1.15em; font-weight: 600; color: #f59e0b; line-height: 1.3; margin-bottom: 6px;">${tab.contrarian_signal || 'N/A'}</div>
                            <div style="color: #9ca3af; font-size: 0.75em; line-height: 1.4;">Fear <25 = +5pts | Euphoria >90 = -5pts</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 8px;">Hype Cycle Position</div>
                            <div style="font-size: 1.15em; font-weight: 600; color: #8b5cf6; line-height: 1.3; margin-bottom: 6px;">${tab.hype_cycle?.position || 'N/A'}</div>
                            <div style="color: #9ca3af; font-size: 0.75em; line-height: 1.4;">Emoji: ${tab.hype_cycle?.emoji_density || 'N/A'} | Caps: ${tab.hype_cycle?.caps_lock_usage || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;

            // Sentiment Breakdown Bar Chart
            if (tab.sentiment_breakdown) {
                const breakdown = tab.sentiment_breakdown;
                html += `
                    <div style="background: rgba(26, 31, 58, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; color: #e0e6f0;">Sentiment Breakdown</h3>
                        <div style="display: flex; height: 40px; border-radius: 8px; overflow: hidden; margin-bottom: 10px;">
                            <div style="background: #10b981; width: ${breakdown.extreme_bullish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.extreme_bullish > 5 ? breakdown.extreme_bullish + '%' : ''}</div>
                            <div style="background: #34d399; width: ${breakdown.bullish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.bullish > 5 ? breakdown.bullish + '%' : ''}</div>
                            <div style="background: #6b7280; width: ${breakdown.neutral}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.neutral > 5 ? breakdown.neutral + '%' : ''}</div>
                            <div style="background: #f59e0b; width: ${breakdown.bearish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.bearish > 5 ? breakdown.bearish + '%' : ''}</div>
                            <div style="background: #ef4444; width: ${breakdown.extreme_bearish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.extreme_bearish > 5 ? breakdown.extreme_bearish + '%' : ''}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #9ca3af;">
                            <span>🟢 Extreme Bullish (${breakdown.extreme_bullish}%)</span>
                            <span>🟢 Bullish (${breakdown.bullish}%)</span>
                            <span>⚪ Neutral (${breakdown.neutral}%)</span>
                            <span>🟠 Bearish (${breakdown.bearish}%)</span>
                            <span>🔴 Extreme Bearish (${breakdown.extreme_bearish}%)</span>
                        </div>
                    </div>
                `;
            }

            // Crypto & Macro Sentiment Scores (side by side)
            if (tab.cryptoSentiment || tab.macroSentiment) {
                const cryptoTier = getSentimentTier(tab.cryptoSentiment);
                const macroTier = getSentimentTier(tab.macroSentiment);

                html += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="color: #8b5cf6; font-weight: 600; font-size: 1.1em; margin-bottom: 10px;">📈 Crypto Sentiment</div>
                            <div style="font-size: 2.5em; font-weight: bold; background: linear-gradient(135deg, #8b5cf6, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${tab.cryptoSentiment || 'N/A'}<span style="font-size: 0.4em; color: #9ca3af;">/100</span></div>
                            <div style="color: ${cryptoTier.color}; font-size: 0.9em; margin-top: 5px;">${cryptoTier.label.toUpperCase()}</div>
                        </div>
                        <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="color: #6366f1; font-weight: 600; font-size: 1.1em; margin-bottom: 10px;">📊 Macro Sentiment</div>
                            <div style="font-size: 2.5em; font-weight: bold; background: linear-gradient(135deg, #6366f1, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${tab.macroSentiment || 'N/A'}<span style="font-size: 0.4em; color: #9ca3af;">/100</span></div>
                            <div style="color: ${macroTier.color}; font-size: 0.9em; margin-top: 5px;">${macroTier.label.toUpperCase()}</div>
                        </div>
                    </div>
                `;
            }

            // Crypto & Macro Trending Tickers (side-by-side grid)
            if ((tab.crypto_trending && tab.crypto_trending.top_tickers && tab.crypto_trending.top_tickers.length > 0) ||
                (tab.macro_trending && tab.macro_trending.top_tickers && tab.macro_trending.top_tickers.length > 0)) {
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">';
            }

            // Crypto Trending Tickers
            if (tab.crypto_trending && tab.crypto_trending.top_tickers && tab.crypto_trending.top_tickers.length > 0) {
                html += '<div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 20px;">';
                const cryptoTrendingStatusClass = tab.crypto_trending.updatedAt ? getDataFreshness(tab.crypto_trending.updatedAt) : 'status-error';
                html += `<div style="display: flex; align-items: center; margin-bottom: 15px;"><h3 style="margin: 0; color: #8b5cf6;">🔥 Crypto Trending Tickers (Mention Velocity)</h3><span class="date-badge ${cryptoTrendingStatusClass}" style="margin-left: 10px;"></span></div>`;
                html += '<div style="display: grid; gap: 12px;">';

                tab.crypto_trending.top_tickers.forEach(ticker => {
                    const velocityColor = ticker.velocity.startsWith('+') ? '#10b981' : (ticker.velocity.startsWith('-') ? '#ef4444' : '#8b5cf6');
                    html += `
                        <div style="background: rgba(31, 41, 55, 0.6); border-left: 3px solid ${velocityColor}; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 80px 100px 1fr; gap: 15px; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.3em; color: #e0e6f0;">${ticker.ticker}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${ticker.mentions} mentions</div>
                            </div>
                            <div style="color: ${velocityColor}; font-weight: 600; font-size: 1.2em; text-align: center;">${ticker.velocity}</div>
                            <div style="color: #d1d5db; font-size: 0.9em; font-style: italic;">${ticker.signal}</div>
                        </div>
                    `;
                });

                html += '</div>'; // Close top_tickers grid

                // Crypto Emerging Tickers
                if (tab.crypto_trending.emerging_tickers && tab.crypto_trending.emerging_tickers.length) {
                    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(139, 92, 246, 0.2);">';
                    html += '<div style="color: #8b5cf6; font-weight: 600; margin-bottom: 12px;">🌟 Emerging Tickers (Alpha Opportunities)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.crypto_trending.emerging_tickers.forEach(ticker => {
                        html += `
                            <div style="background: rgba(234, 179, 8, 0.1); border-left: 3px solid #eab308; padding: 12px; border-radius: 6px;">
                                <div style="font-weight: 600; color: #fde047; margin-bottom: 4px;">${ticker.ticker} <span style="color: #9ca3af; font-size: 0.85em;">(${ticker.mentions} mentions)</span></div>
                                <div style="color: #d1d5db; font-size: 0.9em; font-style: italic;">${ticker.signal}</div>
                            </div>
                        `;
                    });
                    html += '</div></div>'; // Close grid + wrapper
                }

                // Crypto Key Levels Table
                if (tab.crypto_trending.key_levels && tab.crypto_trending.key_levels.length > 0) {
                    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(139, 92, 246, 0.2);">';
                    html += '<div style="color: #8b5cf6; font-weight: 600; margin-bottom: 12px;">🎯 Crypto Key Levels (Crowdsourced)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.crypto_trending.key_levels.forEach(level => {
                        const typeColor = level.type === 'Support' ? '#10b981' : '#ef4444';
                        html += `
                            <div style="display: grid; grid-template-columns: 60px 150px 100px 1fr; gap: 12px; padding: 10px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; align-items: center;">
                                <div style="font-weight: 600; color: #8b5cf6;">${level.asset}</div>
                                <div style="font-family: 'Courier New', monospace; color: #e0e6f0; font-weight: 600;">${level.level}</div>
                                <div style="color: ${typeColor}; font-weight: 600; font-size: 0.9em;">${level.type}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${level.consensus}</div>
                            </div>
                        `;
                    });
                    html += '</div></div>'; // Close grid + wrapper
                }

                // Crypto Event Risk Section
                if (tab.crypto_trending.event_risk && tab.crypto_trending.event_risk.length) {
                    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(139, 92, 246, 0.2);">';
                    html += '<div style="color: #8b5cf6; font-weight: 600; margin-bottom: 12px;">⚠️ Event Risk (High Velocity)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.crypto_trending.event_risk.forEach(event => {
                        const velocityColor = event.velocity === 'CRITICAL' ? '#ef4444' : (event.velocity === 'EXTREME' ? '#f59e0b' : '#10b981');
                        html += `
                            <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid ${velocityColor}; padding: 12px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <div style="font-weight: 600; color: #fca5a5;">${event.event}</div>
                                    <div style="color: ${velocityColor}; font-weight: 600; font-size: 0.85em;">${event.velocity}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                                    <div style="color: #9ca3af; font-size: 0.85em;">${event.date}</div>
                                    <div style="color: #d1d5db; font-size: 0.85em; flex: 1; text-align: right;">${event.impact}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>'; // Close grid + wrapper
                }

                html += '</div>';
            }

            // Macro Trending Tickers
            if (tab.macro_trending && tab.macro_trending.top_tickers && tab.macro_trending.top_tickers.length > 0) {
                html += '<div style="background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px; padding: 20px;">';
                const macroTrendingStatusClass = tab.macro_trending.updatedAt ? getDataFreshness(tab.macro_trending.updatedAt) : 'status-error';
                html += `<div style="display: flex; align-items: center; margin-bottom: 15px;"><h3 style="margin: 0; color: #6366f1;">📊 Macro Trending Tickers (Mention Velocity)</h3><span class="date-badge ${macroTrendingStatusClass}" style="margin-left: 10px;"></span></div>`;
                html += '<div style="display: grid; gap: 12px;">';

                tab.macro_trending.top_tickers.forEach(ticker => {
                    const velocityColor = ticker.velocity.startsWith('+') ? '#10b981' : '#ef4444';
                    html += `
                        <div style="background: rgba(31, 41, 55, 0.6); border-left: 3px solid ${velocityColor}; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 80px 100px 1fr; gap: 15px; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.3em; color: #e0e6f0;">${ticker.ticker}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${ticker.mentions} mentions</div>
                            </div>
                            <div style="color: ${velocityColor}; font-weight: 600; font-size: 1.2em; text-align: center;">${ticker.velocity}</div>
                            <div style="color: #d1d5db; font-size: 0.9em; font-style: italic;">${ticker.signal}</div>
                        </div>
                    `;
                });

                html += '</div>'; // Close top_tickers grid

                // Emerging Tickers
                if (tab.macro_trending.emerging_tickers && tab.macro_trending.emerging_tickers.length) {
                    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.2);">';
                    html += '<div style="color: #6366f1; font-weight: 600; margin-bottom: 12px;">🌟 Emerging Tickers (Alpha Opportunities)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.macro_trending.emerging_tickers.forEach(ticker => {
                        html += `
                            <div style="background: rgba(234, 179, 8, 0.1); border-left: 3px solid #eab308; padding: 12px; border-radius: 6px;">
                                <div style="font-weight: 600; color: #fde047; margin-bottom: 4px;">${ticker.ticker} <span style="color: #9ca3af; font-size: 0.85em;">(${ticker.mentions} mentions)</span></div>
                                <div style="color: #d1d5db; font-size: 0.9em; font-style: italic;">${ticker.signal}</div>
                            </div>
                        `;
                    });
                    html += '</div></div>'; // Close grid + wrapper
                }

                // Macro Key Levels Table
                if (tab.macro_trending.key_levels && tab.macro_trending.key_levels.length > 0) {
                    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.2);">';
                    html += '<div style="color: #6366f1; font-weight: 600; margin-bottom: 12px;">🎯 Macro Key Levels (Crowdsourced)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.macro_trending.key_levels.forEach(level => {
                        const typeColor = level.type === 'Support' ? '#10b981' : (level.type === 'Resistance' ? '#ef4444' : '#f59e0b');
                        html += `
                            <div style="display: grid; grid-template-columns: 60px 150px 100px 1fr; gap: 12px; padding: 10px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; align-items: center;">
                                <div style="font-weight: 600; color: #6366f1;">${level.asset}</div>
                                <div style="font-family: 'Courier New', monospace; color: #e0e6f0; font-weight: 600;">${level.level}</div>
                                <div style="color: ${typeColor}; font-weight: 600; font-size: 0.9em;">${level.type}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${level.consensus}</div>
                            </div>
                        `;
                    });
                    html += '</div></div>'; // Close grid + wrapper
                }

                // Event Risk Section
                if (tab.macro_trending.event_risk && tab.macro_trending.event_risk.length) {
                    html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.2);">';
                    html += '<div style="color: #6366f1; font-weight: 600; margin-bottom: 12px;">⚠️ Event Risk (High Velocity)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.macro_trending.event_risk.forEach(event => {
                        html += `
                            <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 12px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <div style="font-weight: 600; color: #fca5a5;">${event.event}</div>
                                    <div style="color: #10b981; font-weight: 600;">${event.velocity}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="color: #9ca3af; font-size: 0.85em;">${event.date}</div>
                                    <div style="color: #9ca3af; font-size: 0.85em; font-style: italic;">${event.impact}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>'; // Close grid + wrapper
                }

                html += '</div>';
            }

            // Close the 2-column grid wrapper for Crypto & Macro sections
            if ((tab.crypto_trending && tab.crypto_trending.top_tickers && tab.crypto_trending.top_tickers.length > 0) ||
                (tab.macro_trending && tab.macro_trending.top_tickers && tab.macro_trending.top_tickers.length > 0)) {
                html += '</div>'; // End 2-column grid
            }



            // Analytics Widgets Section + Provider Insights (3-column grid combined)
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 25px; margin-bottom: 25px;">';

            // Widget 1: Contrarian Play Detector
                if (tab.contrarian_detector) {
                    const cd = tab.contrarian_detector;
                    const actionColors = {
                        'FADE': '#ef4444',
                        'BUY': '#10b981',
                        'SELL': '#ef4444',
                        'WAIT': '#f59e0b',
                        'FOLLOW': '#3b82f6'
                    };
                    const actionColor = cd.action_color || actionColors[cd.action] || '#6b7280';
                    const opportunityStatus = cd.opportunity_status || 'NOT YET';
                    const opportunityColor = opportunityStatus === 'ACTIVE' ? '#10b981' : (opportunityStatus === 'EXTREME' ? '#ef4444' : '#f59e0b');
                    const contrarianStatusClass = cd.updatedAt ? getDataFreshness(cd.updatedAt) : 'status-error';

                    html += `
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="color: #8b5cf6; font-weight: 600; font-size: 1.1em;">🎲 Contrarian Detector</div>
                                    <span class="date-badge ${contrarianStatusClass}" style="margin: 0;"></span>
                                </div>
                                <div style="background: ${actionColor}; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; font-weight: 600;">${cd.action}</div>
                            </div>

                            <div style="background: rgba(31, 41, 55, 0.4); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="color: #9ca3af; font-size: 0.8em; margin-bottom: 6px;">Current Setup</div>
                                <div style="color: #e0e6f0; font-size: 0.9em; line-height: 1.4;">${cd.current_setup}</div>
                            </div>

                            <div style="background: ${opportunityColor === '#10b981' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)'}; border: 1px solid ${opportunityColor}; padding: 14px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="color: #d1d5db; font-weight: 600; font-size: 0.9em;">Opportunity Status</div>
                                    <div style="color: ${opportunityColor}; font-weight: 700; font-size: 1.1em;">${opportunityStatus}</div>
                                </div>
                                <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 4px;">Threshold Needed: <span style="color: #e0e6f0;">${cd.threshold_needed}</span></div>
                                <div style="color: #9ca3af; font-size: 0.85em;">Distance: <span style="color: #e0e6f0;">${cd.distance_to_threshold} points</span></div>
                            </div>

                            <div style="background: rgba(99, 102, 241, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="color: #818cf8; font-weight: 600; font-size: 0.85em; margin-bottom: 6px;">📊 Historical Win Rate</div>
                                <div style="color: #d1d5db; font-size: 0.85em; line-height: 1.4;">${cd.historical_win_rate}</div>
                            </div>

                            <div style="background: rgba(31, 41, 55, 0.4); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="color: #9ca3af; font-size: 0.8em; margin-bottom: 4px;">Confidence Level</div>
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    ${(() => {
                                        const confidence = cd.confidence || 'medium';
                                        const bars = confidence === 'high' ? 3 : (confidence === 'medium' ? 2 : 1);
                                        let barHtml = '';
                                        for (let i = 0; i < 3; i++) {
                                            const barColor = i < bars ? (bars === 3 ? '#10b981' : (bars === 2 ? '#f59e0b' : '#ef4444')) : '#374151';
                                            barHtml += `<div style="flex: 1; height: 12px; background: ${barColor}; border-radius: 2px;"></div>`;
                                        }
                                        return barHtml;
                                    })()}
                                    <span style="color: #e0e6f0; font-weight: 600; margin-left: 8px; text-transform: uppercase; font-size: 0.85em;">${cd.confidence || 'medium'}</span>
                                </div>
                            </div>

                            ${cd.next_check ? `
                                <div style="background: rgba(31, 41, 55, 0.2); padding: 10px; border-radius: 6px; border-left: 3px solid #8b5cf6;">
                                    <div style="color: #9ca3af; font-size: 0.75em; font-style: italic;">${cd.next_check}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

            // Widget 3: X/Twitter Analysis (Provider Insights - integrated into same grid)
            const providers = Array.isArray(tab.providers) ? tab.providers : [];
            providers.forEach(provider => {
                html += `
                    <div class="provider-card">
                        <div class="provider-name">${provider.name || ''}</div>
                        ${(provider.insights || []).map(insight => `<div class="key-insight">${insight}</div>`).join('')}
                    </div>
                `;
            });

            html += '</div>'; // End combined analytics widgets + provider insights grid

            return html;
        }

        function renderMediaCatalysts(tab) {
            let html = '';

            // AI Interpretation at top
            if (tab.aiInterpretation) {
                html += renderAIInterpretation(tab.aiInterpretation);
            }

            // Render each category
            if (tab.categories && tab.categories.length) {
                tab.categories.forEach(category => {
                    html += `<div style="background: rgba(26, 31, 58, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 25px;">`;
                    html += `<h3 style="margin-bottom: 15px; color: #e0e6f0;">${category.name}</h3>`;
                    html += '<div style="display: grid; gap: 12px;">';

                    if (category.items && category.items.length) {
                        category.items.forEach(item => {
                            // Conviction color mapping
                            const convictionColors = {
                                'HIGH': { bg: 'rgba(16, 185, 129, 0.1)', border: '#10b981', text: '#10b981' },
                                'MEDIUM-HIGH': { bg: 'rgba(34, 197, 94, 0.1)', border: '#22c55e', text: '#22c55e' },
                                'MEDIUM': { bg: 'rgba(245, 158, 11, 0.1)', border: '#f59e0b', text: '#f59e0b' },
                                'LOW': { bg: 'rgba(107, 114, 128, 0.1)', border: '#6b7280', text: '#9ca3af' }
                            };
                            const colors = convictionColors[item.conviction] || convictionColors['MEDIUM'];

                            html += `
                                <div style="background: ${colors.bg}; border-left: 4px solid ${colors.border}; padding: 16px; border-radius: 8px; transition: all 0.2s ease;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #e0e6f0; font-size: 1.1em; margin-bottom: 6px;">${item.title}</div>
                                            <div style="color: #9ca3af; font-size: 0.85em;">${item.date} • ${item.source}</div>
                                        </div>
                                        <div style="background: ${colors.bg}; border: 1px solid ${colors.border}; color: ${colors.text}; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85em; white-space: nowrap; margin-left: 12px;">
                                            ${item.conviction}
                                        </div>
                                    </div>
                                    <div style="color: #d1d5db; line-height: 1.6; margin-bottom: 12px;">
                                        ${item.blurb}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            ${(item.tags || []).map(tag => `<span style="background: rgba(99, 102, 241, 0.2); color: #818cf8; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">${tag}</span>`).join('')}
                                        </div>
                                        ${item.link && item.link.startsWith('http') ? `
                                            <a href="${item.link}" target="_blank" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 6px 16px; border-radius: 6px; text-decoration: none; font-size: 0.85em; font-weight: 600; transition: all 0.2s ease; display: inline-block;">
                                                View Source →
                                            </a>
                                        ` : item.link ? `
                                            <button onclick="showTab('${item.link.replace('#', '').replace('-tab', '')}')" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 6px 16px; border-radius: 6px; border: none; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                                                Go to Tab →
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += '</div></div>';
                });
            }

            return html;
        }

        function applyCardAnimations() {
            const cards = document.querySelectorAll('.provider-card, .metric-card');
            if (!cards.length) {
                return;
            }

            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            });

            cards.forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                observer.observe(card);
            });
        }

        // Daily Planner Functions
        function isAfterMarketClose() {
            const now = new Date();
            // Convert to EST/EDT - accounting for DST
            const estTimeString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            const estTime = new Date(estTimeString);
            const hours = estTime.getHours();
            const minutes = estTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market closes at 4:00 PM EST (16:00 = 960 minutes)
            return timeInMinutes >= 960;
        }

        function getCurrentMarketSession() {
            const now = new Date();
            // Convert to EST/EDT - accounting for DST
            const estTimeString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            const estTime = new Date(estTimeString);
            const hours = estTime.getHours();
            const minutes = estTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market sessions in EST
            if (timeInMinutes >= 4 * 60 && timeInMinutes < 9 * 60 + 30) {
                return 'preMarket';
            } else if (timeInMinutes >= 9 * 60 + 30 && timeInMinutes < 11 * 60) {
                return 'open';
            } else if (timeInMinutes >= 11 * 60 && timeInMinutes < 13 * 60) {
                return 'midday';
            } else if (timeInMinutes >= 15 * 60 && timeInMinutes < 16 * 60) {
                return 'powerHour';
            } else if (timeInMinutes >= 16 * 60 && timeInMinutes < 20 * 60) {
                return 'afterHours';
            } else {
                return 'afterHours'; // Default to after hours
            }
        }

        function getSessionQuality(sessionKey) {
            // Define trading quality for each session
            const sessionQualities = {
                'preMarket': 'good',      // Good for planning, setting orders (yellow)
                'open': 'optimal',        // Best liquidity, volatility (green)
                'midday': 'poor',         // Lunch lull, low volume (red)
                'powerHour': 'optimal',   // High volume, big moves (green)
                'afterHours': 'poor'      // Low liquidity, wide spreads (red)
            };
            return sessionQualities[sessionKey] || 'neutral';
        }

        function renderDailyPlanner(plannerData, endOfDayData, dashboardData) {
            if (!plannerData) {
                return '<p style="color: #9ca3af;">No daily planner data available.</p>';
            }

            const container = document.createElement('div');

            // AI Interpretation (if available)
            if (plannerData.aiInterpretation) {
                const aiInterpDiv = document.createElement('div');
                aiInterpDiv.innerHTML = renderAIInterpretation(plannerData.aiInterpretation);
                container.appendChild(aiInterpDiv);
            }

            // Planner Grid - 2 column layout for balanced sizing
            const plannerContainer = document.createElement('div');
            plannerContainer.className = 'planner-container';
            plannerContainer.style.display = 'grid';
            plannerContainer.style.gridTemplateColumns = '1fr 1fr';
            plannerContainer.style.gap = '20px';
            plannerContainer.style.alignItems = 'start';

            // Left column: Key Levels + Today's Priorities (stacked)
            const leftColumn = document.createElement('div');
            leftColumn.style.display = 'flex';
            leftColumn.style.flexDirection = 'column';
            leftColumn.style.gap = '20px';

            // Key Levels Section (top left)
            leftColumn.appendChild(renderKeyLevels(plannerData.keyLevels, plannerData.keyLevelsUpdated));

            // Priorities Section (bottom left)
            leftColumn.appendChild(renderPriorityItems(plannerData.priorities, plannerData.prioritiesUpdated));

            plannerContainer.appendChild(leftColumn);

            // Right column: Economic Calendar Section (compact mode for Daily Planner)
            if (plannerData.economicCalendar) {
                plannerContainer.appendChild(renderEconomicCalendar(plannerData.economicCalendar, true, plannerData.economicCalendarUpdated));
            }


            // End of Day Recap Section (always show if data exists)
            if (endOfDayData) {
                plannerContainer.appendChild(renderEndOfDayRecap(endOfDayData));
            }

            container.appendChild(plannerContainer);
            return container;
        }

        function renderPriorityItems(priorities, updatedAt) {
            const section = document.createElement('div');
            section.className = 'priorities-section';

            const title = document.createElement('h3');
            title.className = 'section-title';
            if (updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                title.innerHTML = `Today's Priorities <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            } else {
                title.textContent = 'Today\'s Priorities';
            }
            section.appendChild(title);

            if (!priorities || (Array.isArray(priorities) && priorities.length === 0)) {
                section.innerHTML += '<p style="color: #9ca3af;">No priorities set.</p>';
                return section;
            }

            // Handle new format: simple string array
            if (Array.isArray(priorities) && typeof priorities[0] === 'string') {
                const priorityList = document.createElement('div');
                priorityList.className = 'priority-list';

                priorities.forEach((priorityText, index) => {
                    const priorityItem = document.createElement('div');
                    priorityItem.className = 'priority-item high';
                    priorityItem.style.display = 'flex';
                    priorityItem.style.alignItems = 'center';
                    priorityItem.style.padding = '12px 15px';
                    priorityItem.style.background = 'rgba(99, 102, 241, 0.08)';
                    priorityItem.style.borderLeft = '3px solid #6366f1';
                    priorityItem.style.borderRadius = '6px';
                    priorityItem.style.marginBottom = '10px';
                    priorityItem.style.transition = 'all 0.2s ease';

                    const checkbox = document.createElement('div');
                    checkbox.className = 'priority-checkbox';
                    checkbox.style.width = '18px';
                    checkbox.style.height = '18px';
                    checkbox.style.border = '2px solid rgba(99, 102, 241, 0.4)';
                    checkbox.style.borderRadius = '4px';
                    checkbox.style.marginRight = '12px';
                    checkbox.style.flexShrink = '0';
                    checkbox.style.cursor = 'pointer';

                    const taskText = document.createElement('span');
                    taskText.textContent = priorityText;
                    taskText.style.flex = '1';
                    taskText.style.color = '#e0e6f0';
                    taskText.style.fontSize = '0.95em';

                    priorityItem.appendChild(checkbox);
                    priorityItem.appendChild(taskText);
                    priorityList.appendChild(priorityItem);
                });

                section.appendChild(priorityList);
                return section;
            }

            // Handle old format: nested object with priority levels
            ['high', 'medium', 'low'].forEach(priority => {
                const items = priorities[priority] || [];
                if (items.length > 0) {
                    const priorityList = document.createElement('div');
                    priorityList.className = 'priority-list';

                    items.forEach((item, index) => {
                        const priorityItem = document.createElement('div');
                        priorityItem.className = `priority-item ${priority}`;

                        const checkbox = document.createElement('div');
                        checkbox.className = `priority-checkbox ${item.completed ? 'checked' : ''}`;
                        checkbox.dataset.priority = priority;
                        checkbox.dataset.index = index;
                        checkbox.onclick = (e) => toggleTask(e.target);

                        const taskText = document.createElement('span');
                        taskText.textContent = item.task || '';
                        taskText.style.flex = '1';
                        if (item.completed) {
                            taskText.style.textDecoration = 'line-through';
                            taskText.style.opacity = '0.6';
                        }

                        priorityItem.appendChild(checkbox);
                        priorityItem.appendChild(taskText);
                        priorityList.appendChild(priorityItem);
                    });

                    section.appendChild(priorityList);
                }
            });

            return section;
        }

        function renderKeyLevels(keyLevels, updatedAt) {
            const section = document.createElement('div');
            section.className = 'key-levels-section';

            const title = document.createElement('h3');
            title.className = 'section-title';
            if (updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                title.innerHTML = `Key Levels <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            } else {
                title.textContent = 'Key Levels';
            }
            section.appendChild(title);

            if (!keyLevels || !keyLevels.length) {
                section.innerHTML += '<p style="color: #9ca3af;">No key levels set.</p>';
                return section;
            }

            // Handle new format: descriptive strings like "SPY: $660.00 - watch 200-DMA support"
            if (Array.isArray(keyLevels) && typeof keyLevels[0] === 'string') {
                const table = document.createElement('table');
                table.className = 'level-table';
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Asset', 'Entry/Support', 'Stop/Breakdown', 'Target/Resistance'].forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    th.style.padding = '10px';
                    th.style.textAlign = 'left';
                    th.style.borderBottom = '2px solid rgba(99, 102, 241, 0.3)';
                    th.style.color = '#9ca3af';
                    th.style.fontSize = '0.85em';
                    th.style.fontWeight = '600';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                keyLevels.forEach(levelStr => {
                    // Parse string like "SPY: $660.00 - watch 200-DMA support"
                    const colonIndex = levelStr.indexOf(':');
                    const asset = colonIndex > 0 ? levelStr.substring(0, colonIndex).trim() : levelStr;
                    const remainder = colonIndex > 0 ? levelStr.substring(colonIndex + 1).trim() : '';

                    // Extract price/level
                    const priceMatch = remainder.match(/\$?([\d,]+\.?\d*)/);
                    const price = priceMatch ? '$' + priceMatch[1] : '';

                    // Get description (everything after the price)
                    const description = priceMatch ? remainder.substring(remainder.indexOf(priceMatch[0]) + priceMatch[0].length).replace(/^[\s\-]+/, '').trim() : remainder;

                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(99, 102, 241, 0.1)';

                    const assetCell = document.createElement('td');
                    assetCell.style.padding = '12px 10px';
                    assetCell.style.fontWeight = '600';
                    assetCell.style.color = '#6366f1';
                    assetCell.textContent = asset;
                    row.appendChild(assetCell);

                    const levelCell = document.createElement('td');
                    levelCell.style.padding = '12px 10px';
                    levelCell.style.color = '#10b981';
                    levelCell.style.fontWeight = '600';
                    levelCell.textContent = price;
                    row.appendChild(levelCell);

                    const descCell = document.createElement('td');
                    descCell.style.padding = '12px 10px';
                    descCell.style.color = '#9ca3af';
                    descCell.style.fontSize = '0.9em';
                    descCell.colSpan = 2;
                    descCell.textContent = description || '-';
                    row.appendChild(descCell);

                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                section.appendChild(table);
                return section;
            }

            // Handle old format: structured objects with asset/entry/stop/target
            const table = document.createElement('table');
            table.className = 'level-table';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Asset', 'Entry/Support', 'Stop/Breakdown', 'Target/Resistance'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            keyLevels.forEach(level => {
                const row = document.createElement('tr');

                const assetCell = document.createElement('td');
                assetCell.className = 'level-asset';
                assetCell.textContent = level.asset || '';
                row.appendChild(assetCell);

                const entryCell = document.createElement('td');
                entryCell.textContent = level.entry || level.support || '';
                row.appendChild(entryCell);

                const stopCell = document.createElement('td');
                stopCell.textContent = level.stop || level.breakdown || '';
                row.appendChild(stopCell);

                const targetCell = document.createElement('td');
                targetCell.textContent = level.target || level.resistance || '';
                row.appendChild(targetCell);

                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            section.appendChild(table);

            return section;
        }


        function renderSignalData(signalData, context = {}, updatedAt = null) {
            const { plannerData = {}, dashboardData = {}, endOfDayData = {} } = context || {};

            const toNumber = (value) => {
                const num = Number(value);
                return Number.isFinite(num) ? num : null;
            };

            const formatScore = (score) => {
                if (!Number.isFinite(score)) {
                    return 'N/A';
                }
                const rounded = Math.round(score * 10) / 10;
                return Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1);
            };

            const extractTrendScores = () => {
                const rawScores = endOfDayData?.trendAnalysis?.signalScoreTrend?.scores;
                if (!Array.isArray(rawScores)) {
                    return [];
                }
                return rawScores
                    .map((value) => toNumber(value))
                    .filter((value) => value !== null);
            };

            const trendScores = extractTrendScores();
            const latestTrendScore = trendScores.length ? trendScores[trendScores.length - 1] : null;
            const priorTrendScore = trendScores.length > 1 ? trendScores[trendScores.length - 2] : null;

            const metricScore = (() => {
                const metrics = dashboardData?.metrics;
                if (!Array.isArray(metrics)) {
                    return null;
                }
                const compositeMetric = metrics.find((item) => item && /composite/i.test(item.label || ''));
                if (!compositeMetric) {
                    return null;
                }
                const match = (compositeMetric.value || '').toString().match(/-?[0-9]+([.][0-9]+)?/);
                return match ? toNumber(match[0]) : null;
            })();

            const sentimentScore = (() => {
                const history = dashboardData?.sentimentHistory;
                if (!Array.isArray(history) || !history.length) {
                    return null;
                }
                return toNumber(history[history.length - 1]?.score);
            })();

            const compositeScoreCandidates = [
                latestTrendScore,
                toNumber(signalData?.composite),
                metricScore,
                sentimentScore
            ];

            const compositeScore = compositeScoreCandidates.find((value) => Number.isFinite(value)) ?? null;

            const section = document.createElement('div');
            section.className = 'signal-data-section';

            const title = document.createElement('h3');
            title.className = 'section-title';
            if (updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                title.innerHTML = `Trading Signal Score <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>`;
            } else {
                title.textContent = 'Trading Signal Score';
            }
            section.appendChild(title);

            const scoreCard = document.createElement('div');
            scoreCard.className = 'signal-score-card';

            const scoreHeader = document.createElement('div');
            scoreHeader.className = 'signal-header';

            const scoreContainer = document.createElement('div');
            scoreContainer.style.display = 'flex';
            scoreContainer.style.alignItems = 'center';
            scoreContainer.style.gap = '10px';

            const scoreBadge = document.createElement('div');
            scoreBadge.className = 'signal-composite-score';
            scoreBadge.textContent = formatScore(compositeScore);
            scoreContainer.appendChild(scoreBadge);

            const deltaValue = (() => {
                const directDelta = toNumber(signalData?.delta);
                if (directDelta !== null) {
                    return directDelta;
                }
                if (Number.isFinite(latestTrendScore) && Number.isFinite(priorTrendScore)) {
                    return latestTrendScore - priorTrendScore;
                }
                return null;
            })();

            if (Number.isFinite(deltaValue)) {
                const roundedDelta = Math.round(deltaValue * 10) / 10;
                const deltaSpan = document.createElement('span');
                deltaSpan.style.fontSize = '1.1em';
                deltaSpan.style.fontWeight = '600';

                let deltaText;
                if (roundedDelta > 0) {
                    const formatted = Number.isInteger(roundedDelta) ? String(roundedDelta) : roundedDelta.toFixed(1);
                    deltaText = '+' + formatted;
                    deltaSpan.style.color = '#10b981';
                    deltaSpan.title = 'Improved versus prior score';
                } else if (roundedDelta < 0) {
                    const formatted = Number.isInteger(roundedDelta) ? String(roundedDelta) : roundedDelta.toFixed(1);
                    deltaText = formatted;
                    deltaSpan.style.color = '#ef4444';
                    deltaSpan.title = 'Declined versus prior score';
                } else {
                    deltaText = '0';
                    deltaSpan.style.color = '#9ca3af';
                    deltaSpan.title = 'No change versus prior score';
                }

                deltaSpan.textContent = deltaText;
                scoreContainer.appendChild(deltaSpan);
            }

            scoreHeader.appendChild(scoreContainer);

            const determineTier = (score) => {
                if (!Number.isFinite(score)) return null;
                if (score >= 85) return 'EXTREME BUY';
                if (score >= 70) return 'STRONG BUY';
                if (score >= 55) return 'MODERATE BUY';
                if (score >= 40) return 'WEAK';
                if (score >= 20) return 'AVOID';
                return 'EXTREME AVOID';
            };

            const tierLabel =
                determineTier(compositeScore) ||
                (signalData?.tier ? String(signalData.tier).toUpperCase() : 'UNKNOWN');

            const tierBadge = document.createElement('div');
            const tierClass = tierLabel.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            tierBadge.className = 'signal-tier tier-' + tierClass;
            tierBadge.textContent = tierLabel;
            scoreHeader.appendChild(tierBadge);

            scoreCard.appendChild(scoreHeader);

            const setupText = signalData?.setup || plannerData?.setup;
            if (setupText) {
                const setupBadge = document.createElement('div');
                setupBadge.className = 'signal-setup';
                setupBadge.textContent = 'Setup: ' + setupText;
                scoreCard.appendChild(setupBadge);
            }

            const breakdownSource =
                signalData?.breakdown ||
                plannerData?.breakdown ||
                dashboardData?.breakdown;

            if (breakdownSource) {
                const breakdownDiv = document.createElement('div');
                breakdownDiv.className = 'signal-breakdown';

                const breakdownTitle = document.createElement('div');
                breakdownTitle.className = 'breakdown-title';
                breakdownTitle.textContent = 'Score Breakdown';
                breakdownDiv.appendChild(breakdownTitle);

                const breakdownGrid = document.createElement('div');
                breakdownGrid.className = 'breakdown-grid';

                const components = [
                    { key: 'trend', label: 'Trend (40%)', weight: 40 },
                    { key: 'breadth', label: 'Breadth (25%)', weight: 25 },
                    { key: 'volatility', label: 'Volatility (20%)', weight: 20 },
                    { key: 'technical', label: 'Technical (10%)', weight: 10 },
                    { key: 'seasonality', label: 'Seasonality (5%)', weight: 5 }
                ];

                components.forEach((component) => {
                    const rawValue = toNumber(breakdownSource[component.key]);
                    const value = Number.isFinite(rawValue) ? rawValue : 0;
                    const maxScore = component.weight;
                    const percentage = maxScore
                        ? Math.max(0, Math.min(100, (value / maxScore) * 100))
                        : 0;

                    const item = document.createElement('div');
                    item.className = 'breakdown-item';

                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'breakdown-label';
                    labelDiv.style.display = 'flex';
                    labelDiv.style.alignItems = 'center';
                    labelDiv.style.gap = '6px';

                    const trendDirection =
                        signalData?.trends?.[component.key] ||
                        plannerData?.trends?.[component.key];
                    if (trendDirection) {
                        const trendSpan = document.createElement('span');
                        trendSpan.style.fontSize = '0.85em';
                        trendSpan.style.fontWeight = '600';
                        if (trendDirection === 'up') {
                            trendSpan.textContent = 'Up';
                            trendSpan.style.color = '#10b981';
                            trendSpan.title = 'Improving';
                        } else if (trendDirection === 'down') {
                            trendSpan.textContent = 'Down';
                            trendSpan.style.color = '#ef4444';
                            trendSpan.title = 'Declining';
                        } else {
                            trendSpan.textContent = 'Flat';
                            trendSpan.style.color = '#9ca3af';
                            trendSpan.title = 'Flat';
                        }
                        labelDiv.appendChild(trendSpan);
                    }

                    const labelText = document.createElement('span');
                    labelText.textContent = component.label;
                    labelDiv.appendChild(labelText);

                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'breakdown-value';
                    const valueDisplay = Number.isInteger(value) ? String(value) : value.toFixed(1);
                    valueDiv.textContent = valueDisplay + '/' + maxScore;

                    const barContainer = document.createElement('div');
                    barContainer.className = 'breakdown-bar-container';

                    const bar = document.createElement('div');
                    bar.className = 'breakdown-bar';
                    bar.style.width = percentage + '%';

                    barContainer.appendChild(bar);

                    item.appendChild(labelDiv);
                    item.appendChild(barContainer);
                    item.appendChild(valueDiv);
                    breakdownGrid.appendChild(item);
                });

                breakdownDiv.appendChild(breakdownGrid);
                scoreCard.appendChild(breakdownDiv);
            }

            const recommendationText =
                signalData?.recommendation ||
                plannerData?.recommendation ||
                dashboardData?.recommendation;

            const checklistSource = (() => {
                if (Array.isArray(signalData?.actionChecklist) && signalData.actionChecklist.length) {
                    return signalData.actionChecklist;
                }
                if (Array.isArray(plannerData?.actionChecklist) && plannerData.actionChecklist.length) {
                    return plannerData.actionChecklist;
                }
                if (Array.isArray(dashboardData?.riskControls) && dashboardData.riskControls.length) {
                    return dashboardData.riskControls.map((entry) =>
                        typeof entry === 'string'
                            ? { text: entry, priority: 'monitor' }
                            : entry
                    );
                }
                return [];
            })();

            if (recommendationText || checklistSource.length) {
                const recommendationSection = document.createElement('div');
                recommendationSection.style.marginTop = '15px';
                recommendationSection.style.padding = '12px';
                recommendationSection.style.background = 'rgba(16, 185, 129, 0.1)';
                recommendationSection.style.border = '1px solid rgba(16, 185, 129, 0.2)';
                recommendationSection.style.borderRadius = '8px';
                recommendationSection.style.borderLeft = '4px solid #10b981';

                if (recommendationText) {
                    const recommendation = document.createElement('div');
                    recommendation.style.color = '#10b981';
                    recommendation.style.fontWeight = '600';
                    recommendation.style.marginBottom = '10px';
                    recommendation.textContent = recommendationText;
                    recommendationSection.appendChild(recommendation);
                }

                if (checklistSource.length) {
                    const checklistContainer = document.createElement('div');
                    checklistContainer.style.marginTop = '10px';

                    checklistSource
                        .map((entry) =>
                            typeof entry === 'string' ? { text: entry } : entry || {}
                        )
                        .filter((entry) => entry.text)
                        .forEach((item) => {
                            const checkItem = document.createElement('div');
                            checkItem.style.display = 'flex';
                            checkItem.style.alignItems = 'flex-start';
                            checkItem.style.gap = '8px';
                            checkItem.style.padding = '6px 0';
                            checkItem.style.fontSize = '0.9em';
                            checkItem.style.lineHeight = '1.5';

                            const statusIcon = document.createElement('span');
                            statusIcon.style.fontFamily = 'monospace';
                            statusIcon.style.minWidth = '28px';

                            if (item.completed) {
                                statusIcon.textContent = '[x]';
                                statusIcon.style.color = '#10b981';
                            } else if (item.inProgress) {
                                statusIcon.textContent = '[~]';
                                statusIcon.style.color = '#f59e0b';
                            } else {
                                statusIcon.textContent = '[ ]';
                                statusIcon.style.color = '#9ca3af';
                            }

                            const textWrapper = document.createElement('div');
                            textWrapper.style.flex = '1';
                            textWrapper.style.color = item.completed ? '#9ca3af' : '#e0e6f0';

                            if (item.priority) {
                                const priorityLabel = document.createElement('span');
                                priorityLabel.style.fontWeight = '600';
                                priorityLabel.style.marginRight = '6px';

                                if (item.priority === 'critical') {
                                    priorityLabel.style.color = '#ef4444';
                                } else if (item.priority === 'monitor') {
                                    priorityLabel.style.color = '#f59e0b';
                                } else {
                                    priorityLabel.style.color = '#10b981';
                                }

                                priorityLabel.textContent = String(item.priority).toUpperCase();
                                textWrapper.appendChild(priorityLabel);
                            }

                            const textSpan = document.createElement('span');
                            textSpan.textContent = item.text;
                            if (item.completed) {
                                textSpan.style.textDecoration = 'line-through';
                            }
                            textWrapper.appendChild(textSpan);

                            if (item.target) {
                                const targetSpan = document.createElement('span');
                                targetSpan.style.color = '#6366f1';
                                targetSpan.style.fontWeight = '600';
                                targetSpan.style.marginLeft = '8px';
                                targetSpan.textContent = '(' + item.target + ')';
                                textWrapper.appendChild(targetSpan);
                            }

                            checkItem.appendChild(statusIcon);
                            checkItem.appendChild(textWrapper);
                            checklistContainer.appendChild(checkItem);
                        });

                    recommendationSection.appendChild(checklistContainer);
                }

                scoreCard.appendChild(recommendationSection);
            }

            section.appendChild(scoreCard);
            return section;
        }

        function formatCurrencyValue(value) {
            if (value === null || value === undefined || value === '') {
                return 'N/A';
            }
            if (typeof value === 'number' && !Number.isNaN(value)) {
                const hasFraction = Math.abs(value % 1) > 0;
                return '$' + value.toLocaleString(undefined, {
                    minimumFractionDigits: hasFraction ? 2 : 0,
                    maximumFractionDigits: hasFraction ? 2 : 0
                });
            }
            const str = String(value).trim();
            if (!str) return 'N/A';
            if (str.startsWith('$')) return str;
            const numeric = Number(str.replace(/[^0-9.-]/g, ''));
            if (!Number.isNaN(numeric) && str.match(/^\d/)) {
                const hasFraction = Math.abs(numeric % 1) > 0;
                return '$' + numeric.toLocaleString(undefined, {
                    minimumFractionDigits: hasFraction ? 2 : 0,
                    maximumFractionDigits: hasFraction ? 2 : 0
                });
            }
            return '$' + str.replace(/^\$/, '');
        }

        function formatPlainValue(value) {
            if (value === null || value === undefined || value === '') {
                return 'N/A';
            }
            if (typeof value === 'number' && !Number.isNaN(value)) {
                return value.toLocaleString();
            }
            return String(value);
        }

        function sanitizePercentValue(value) {
            if (!value && value !== 0) return { display: '0%', numeric: 0 };
            const str = String(value).trim();
            const numeric = Number(str.replace(/[^0-9.-]/g, ''));
            const bounded = Number.isNaN(numeric) ? 0 : Math.max(0, Math.min(100, numeric));
            const hasPercent = str.includes('%');
            return {
                display: hasPercent ? str : `${bounded}%`,
                numeric: bounded
            };
        }

        function detectActivitySentiment(unusualActivity) {
            // Analyze all alerts across tickers to determine overall sentiment
            const allAlerts = [...(unusualActivity.SPY || []), ...(unusualActivity.QQQ || [])];

            let bullishCount = 0;
            let bearishCount = 0;

            allAlerts.forEach(alert => {
                const signal = (alert.signal || '').toLowerCase();

                // Bullish indicators
                if (signal.includes('accumul') || signal.includes('bullish') ||
                    signal.includes('buying') || signal.includes('support') ||
                    signal.includes('strength')) {
                    bullishCount++;
                }

                // Bearish indicators
                if (signal.includes('defensive') || signal.includes('distribution') ||
                    signal.includes('selling') || signal.includes('bearish') ||
                    signal.includes('breakdown') || signal.includes('risk')) {
                    bearishCount++;
                }
            });

            // Return emoji based on sentiment
            if (bullishCount > bearishCount) {
                return { emoji: '🚀', label: 'Bullish Activity' };
            } else if (bearishCount > bullishCount) {
                return { emoji: '📉', label: 'Bearish Activity' };
            } else {
                return { emoji: '⚠️', label: 'Unusual Activity' };
            }
        }

        function renderUnusualActivityMonitor(tab) {
            const unusualActivity = tab.unusualActivity;
            if (!unusualActivity || (!unusualActivity.SPY && !unusualActivity.QQQ)) {
                return '';
            }

            let alertsHTML = '';
            let hasAlerts = false;

            // Consolidate all alerts from all tickers into single list with inline ticker symbol
            ['SPY', 'QQQ'].forEach(ticker => {
                const alerts = unusualActivity[ticker] || [];
                if (alerts.length === 0) return;
                hasAlerts = true;

                alerts.forEach(alert => {
                    const statusEmoji = alert.status === 'SPIKE' ? '🔴' : '🟠';
                    const statusLabel = alert.status === 'SPIKE' ? 'SPIKE' : 'ALERT';
                    const changeStr = alert.change ? `(${alert.change})` : '';
                    const prevStr = alert.previous ? `from ${alert.previous}` : '';

                    alertsHTML += `
                        <div class="unusual-activity-alert">
                            <div class="unusual-activity-alert-header">
                                <span class="unusual-activity-badge">${statusEmoji} ${statusLabel}</span>
                                <span class="unusual-activity-ticker">${ticker}</span>
                                <span class="unusual-activity-separator">-</span>
                                <span class="unusual-activity-metric">${alert.metric}</span>
                            </div>
                            <div class="unusual-activity-value">
                                <strong>${alert.current}</strong> ${changeStr} ${prevStr}
                            </div>
                            <div class="unusual-activity-signal">
                                ${alert.signal}
                            </div>
                        </div>
                    `;
                });
            });

            if (!hasAlerts) {
                return '';
            }

            // Detect sentiment and get emoji
            const sentiment = detectActivitySentiment(unusualActivity);

            // Get timestamp if available and create badge
            const updatedAt = tab.unusualActivity?.updatedAt || tab.unusualActivity?.synced_at;
            const statusClass = updatedAt ? getDataFreshness(updatedAt) : '';
            const badgeHTML = updatedAt ? `<span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>` : '';

            return `
                <div class="unusual-activity-monitor">
                    <h3 class="unusual-activity-header">
                        ${sentiment.emoji} UNUSUAL OPTIONS ACTIVITY
                        ${badgeHTML}
                    </h3>
                    ${alertsHTML}
                </div>
            `.trim();
        }

        function isAfterMidDay() {
            const now = new Date();
            // Convert to EST/EDT
            const estTimeString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            const estTime = new Date(estTimeString);
            const hours = estTime.getHours();
            const minutes = estTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Midday is 12:00 PM EST (720 minutes)
            return timeInMinutes >= 720;
        }

        function normalizeCloseProbability(cp) {
          if (!cp || !cp.probabilities) {
            return { probabilities: { higher: 0, flat: 0, lower: 0 }, keyLevels: {}, factors: [] };
          }
          return {
            probabilities: {
              higher: cp.probabilities.higher ?? 0,
              flat: cp.probabilities.flat ?? 0,
              lower: cp.probabilities.lower ?? 0
            },
            keyLevels: cp.keyLevels || {},
            factors: cp.factors || []
          };
        }

        function renderCloseProbability(probabilityData) {
            const section = document.createElement('div');
            section.className = 'close-probability-section';
            section.style.marginTop = '25px';
            section.style.padding = '20px';
            section.style.background = 'rgba(139, 92, 246, 0.1)';
            section.style.border = '1px solid rgba(139, 92, 246, 0.3)';
            section.style.borderRadius = '12px';

            const title = document.createElement('h3');
            title.style.color = '#8b5cf6';
            title.style.fontSize = '1.1em';
            title.style.marginBottom = '15px';
            title.style.display = 'flex';
            title.style.alignItems = 'center';
            title.style.justifyContent = 'space-between';

            const titleText = document.createElement('span');
            titleText.textContent = `📊 ${probabilityData.ticker} Close Probability`;

            const updateTime = document.createElement('span');
            const statusClass = getDataFreshness(probabilityData.lastUpdate);
            updateTime.className = `date-badge ${statusClass}`;
            updateTime.style.marginLeft = '10px';

            title.appendChild(titleText);
            title.appendChild(updateTime);
            section.appendChild(title);

            // Current price info
            const currentPrice = document.createElement('div');
            currentPrice.style.marginBottom = '15px';
            currentPrice.style.padding = '12px';
            currentPrice.style.background = 'rgba(139, 92, 246, 0.1)';
            currentPrice.style.borderRadius = '8px';
            currentPrice.innerHTML = `
                <div style="color: #e0e6f0; font-size: 0.9em;">Current: <strong style="font-size: 1.2em;">${probabilityData.current}</strong></div>
                <div style="color: #9ca3af; font-size: 0.85em; margin-top: 4px;">${probabilityData.changeFromOpen} from open</div>
            `;
            section.appendChild(currentPrice);

            // Probability bars
            const probTitle = document.createElement('div');
            probTitle.style.color = '#e0e6f0';
            probTitle.style.fontWeight = '600';
            probTitle.style.marginBottom = '10px';
            probTitle.style.fontSize = '0.95em';
            probTitle.textContent = 'Probability Distribution:';
            section.appendChild(probTitle);

            // Higher probability
            const higherDiv = document.createElement('div');
            higherDiv.style.marginBottom = '8px';
            const higherLabel = document.createElement('div');
            higherLabel.style.display = 'flex';
            higherLabel.style.justifyContent = 'space-between';
            higherLabel.style.marginBottom = '4px';
            higherLabel.innerHTML = `
                <span style="color: #10b981; font-size: 0.9em;">🟢 Higher Close (>${probabilityData.current})</span>
                <span style="color: #10b981; font-weight: 600;">${probabilityData.probabilities.higher}%</span>
            `;
            const higherBar = document.createElement('div');
            higherBar.style.height = '24px';
            higherBar.style.background = 'rgba(16, 185, 129, 0.2)';
            higherBar.style.borderRadius = '4px';
            higherBar.style.overflow = 'hidden';
            const higherFill = document.createElement('div');
            higherFill.style.height = '100%';
            higherFill.style.width = `${probabilityData.probabilities.higher}%`;
            higherFill.style.background = '#10b981';
            higherFill.style.transition = 'width 0.5s ease';
            higherBar.appendChild(higherFill);
            higherDiv.appendChild(higherLabel);
            higherDiv.appendChild(higherBar);
            section.appendChild(higherDiv);

            // Flat probability
            const flatDiv = document.createElement('div');
            flatDiv.style.marginBottom = '8px';
            const flatLabel = document.createElement('div');
            flatLabel.style.display = 'flex';
            flatLabel.style.justifyContent = 'space-between';
            flatLabel.style.marginBottom = '4px';
            flatLabel.innerHTML = `
                <span style="color: #9ca3af; font-size: 0.9em;">⚪ Flat (±0.1%)</span>
                <span style="color: #9ca3af; font-weight: 600;">${probabilityData.probabilities.flat}%</span>
            `;
            const flatBar = document.createElement('div');
            flatBar.style.height = '24px';
            flatBar.style.background = 'rgba(156, 163, 175, 0.2)';
            flatBar.style.borderRadius = '4px';
            flatBar.style.overflow = 'hidden';
            const flatFill = document.createElement('div');
            flatFill.style.height = '100%';
            flatFill.style.width = `${probabilityData.probabilities.flat}%`;
            flatFill.style.background = '#9ca3af';
            flatFill.style.transition = 'width 0.5s ease';
            flatBar.appendChild(flatFill);
            flatDiv.appendChild(flatLabel);
            flatDiv.appendChild(flatBar);
            section.appendChild(flatDiv);

            // Lower probability
            const lowerDiv = document.createElement('div');
            lowerDiv.style.marginBottom = '15px';
            const lowerLabel = document.createElement('div');
            lowerLabel.style.display = 'flex';
            lowerLabel.style.justifyContent = 'space-between';
            lowerLabel.style.marginBottom = '4px';
            lowerLabel.innerHTML = `
                <span style="color: #ef4444; font-size: 0.9em;">🔴 Lower Close (<${probabilityData.current})</span>
                <span style="color: #ef4444; font-weight: 600;">${probabilityData.probabilities.lower}%</span>
            `;
            const lowerBar = document.createElement('div');
            lowerBar.style.height = '24px';
            lowerBar.style.background = 'rgba(239, 68, 68, 0.2)';
            lowerBar.style.borderRadius = '4px';
            lowerBar.style.overflow = 'hidden';
            const lowerFill = document.createElement('div');
            lowerFill.style.height = '100%';
            lowerFill.style.width = `${probabilityData.probabilities.lower}%`;
            lowerFill.style.background = '#ef4444';
            lowerFill.style.transition = 'width 0.5s ease';
            lowerBar.appendChild(lowerFill);
            lowerDiv.appendChild(lowerLabel);
            lowerDiv.appendChild(lowerBar);
            section.appendChild(lowerDiv);

            // Key factors
            if (probabilityData.factors && probabilityData.factors.length) {
                const factorsTitle = document.createElement('div');
                factorsTitle.style.color = '#e0e6f0';
                factorsTitle.style.fontWeight = '600';
                factorsTitle.style.marginBottom = '8px';
                factorsTitle.style.marginTop = '15px';
                factorsTitle.style.fontSize = '0.95em';
                factorsTitle.textContent = 'Key Factors:';
                section.appendChild(factorsTitle);

                probabilityData.factors.forEach(factor => {
                    const factorDiv = document.createElement('div');
                    factorDiv.style.display = 'flex';
                    factorDiv.style.alignItems = 'center';
                    factorDiv.style.gap = '8px';
                    factorDiv.style.padding = '6px 0';
                    factorDiv.style.fontSize = '0.9em';
                    factorDiv.style.lineHeight = '1.5';

                    const icon = document.createElement('span');
                    icon.style.fontSize = '1.1em';
                    if (factor.impact === 'bullish') {
                        icon.textContent = '✓';
                        icon.style.color = '#10b981';
                    } else if (factor.impact === 'bearish') {
                        icon.textContent = '✗';
                        icon.style.color = '#ef4444';
                    } else {
                        icon.textContent = '⚠️';
                        icon.style.color = '#f59e0b';
                    }

                    const text = document.createElement('span');
                    text.style.color = '#d1d5db';
                    text.textContent = factor.text;

                    factorDiv.appendChild(icon);
                    factorDiv.appendChild(text);
                    section.appendChild(factorDiv);
                });
            }



            // Composite signal
            const composite = document.createElement('div');
            composite.style.marginTop = '15px';
            composite.style.padding = '12px';
            composite.style.background = 'rgba(139, 92, 246, 0.15)';
            composite.style.borderRadius = '8px';
            composite.style.display = 'flex';
            composite.style.justifyContent = 'space-between';
            composite.style.alignItems = 'center';
            composite.innerHTML = `
                <div>
                    <div style="color: #e0e6f0; font-size: 0.9em; margin-bottom: 4px;">Composite Signal:</div>
                    <div style="color: ${probabilityData.compositeSignal.color}; font-weight: 700; font-size: 1.1em;">${probabilityData.compositeSignal.label} (${probabilityData.compositeSignal.score}/100)</div>
                </div>
                <div style="text-align: right;">
                    <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 4px;">Confidence:</div>
                    <div style="color: #8b5cf6; font-weight: 600;">${probabilityData.confidence}</div>
                </div>
            `;
            section.appendChild(composite);

            return section;
        }

        function renderTradingLevelsDashboard(optionsData, metrics, ticker = 'SPY') {
            // Use optionsData as source of truth - it comes from master-plan.md which is updated by workflow
            const currentPrice = optionsData.currentPrice || '—';
            const maxPain = optionsData.maxPain || 'N/A';
            const vix = metrics?.find(m => m.label === 'VIX')?.value?.match(/[\d.]+/)?.[0] || '—';

            const currentPriceNum = parseFloat(currentPrice);
            const resistanceLevels = [];
            const supportLevels = [];

            if (optionsData.keyLevels) {
                optionsData.keyLevels.forEach(level => {
                    const strikeNum = parseFloat(level.strike);
                    if (strikeNum > currentPriceNum) {
                        resistanceLevels.push(level);
                    } else {
                        supportLevels.push(level);
                    }
                });
            }

            const statusClass = getDataFreshness(optionsData.lastUpdated);
            return `
                <div class="trading-levels-dashboard">
                    <div class="levels-header">
                        <h3 class="section-title">📊 Trading Levels - ${ticker}</h3>
                        <div class="current-metrics">
                            <span class="metric">Current: <strong>$${currentPrice}</strong></span>
                            <span class="metric">Max Pain: <strong>${maxPain}</strong></span>
                            <span class="metric">VIX: <strong>${vix}</strong></span>
                            <span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>
                        </div>
                    </div>

                    <div class="options-quick-metrics">
                        <div class="quick-metric">
                            <div class="metric-label">Put/Call Ratio</div>
                            <div class="metric-value">${optionsData.putCallRatio || 'N/A'}</div>
                        </div>
                        <div class="quick-metric">
                            <div class="metric-label">IV Percentile</div>
                            <div class="metric-value">${optionsData.ivPercentile || 'N/A'}</div>
                        </div>
                        <div class="quick-metric">
                            <div class="metric-label">Total OI</div>
                            <div class="metric-value">${optionsData.totalOI || 'N/A'}</div>
                        </div>
                    </div>

                    ${resistanceLevels.length > 0 ? `
                    <div class="levels-section">
                        <h4 class="levels-section-title">⬆️ RESISTANCE LEVELS</h4>
                        <div class="levels-container">
                            ${resistanceLevels.map(level => renderLevelCard(level, 'resistance')).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${supportLevels.length > 0 ? `
                    <div class="levels-section">
                        <h4 class="levels-section-title">⬇️ SUPPORT LEVELS</h4>
                        <div class="levels-container">
                            ${supportLevels.map(level => renderLevelCard(level, 'support')).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="market-context-section">
                        <h4 class="section-subtitle">📈 Market Context</h4>
                        <div class="context-grid">
                            <div class="context-item">
                                <span class="context-label">Source:</span>
                                <span class="context-value">${optionsData.source || 'yfinance'}</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Expiration:</span>
                                <span class="context-value">${optionsData.expiration || 'N/A'}</span>
                            </div>
                        </div>
                        ${renderMaxPainAnalysis(currentPriceNum, parseFloat(maxPain.replace('$', '')), optionsData.putCallRatio)}
                    </div>
                </div>
            `;
        }

        function renderLevelCard(level, type) {
            const importance = getLevelImportance(level.type);
            return `
                <div class="level-card" style="border-left: 3px solid ${importance.color};">
                    <div class="level-header">
                        <span class="level-importance" style="color: ${importance.color};">${importance.emoji} ${level.type.toUpperCase()}</span>
                        <span class="level-strike">$${level.strike}</span>
                    </div>
                    <div class="level-stats">
                        <span>OI: ${level.oi}</span>
                    </div>
                    <div class="level-context">
                        ${getLevelContext(level.type, type)}
                    </div>
                </div>
            `;
        }

        function getLevelImportance(type) {
            const map = {
                'Max Pain': { emoji: '🎯', color: '#8b5cf6' },
                'Call Wall': { emoji: '🔴', color: '#ef4444' },
                'Put Wall': { emoji: '🟢', color: '#10b981' },
                'High Gamma': { emoji: '⚡', color: '#f59e0b' },
                'Put Interest': { emoji: '🛡️', color: '#3b82f6' }
            };
            return map[type] || { emoji: '📍', color: '#9ca3af' };
        }

        function getLevelContext(type, direction) {
            const contexts = {
                'Max Pain': 'Magnetic pull for EOD close',
                'Call Wall': direction === 'resistance' ? 'Dealers sell into strength' : 'Breakout triggers squeeze',
                'Put Wall': direction === 'support' ? 'Dealers buy dips' : 'Breakdown accelerates',
                'High Gamma': 'Explosive price action zone',
                'Put Interest': 'Support magnet'
            };
            return contexts[type] || 'Key level';
        }

        function renderMaxPainAnalysis(currentPrice, maxPain, putCallRatio) {
            if (isNaN(currentPrice) || isNaN(maxPain)) {
                return '';
            }

            const distance = currentPrice - maxPain;
            const distancePct = ((distance / maxPain) * 100).toFixed(1);
            let analysis = '';
            let biasColor = '#9ca3af';
            let biasIcon = '⚖️';

            if (Math.abs(distance) < 2) {
                analysis = `Price near max pain - balanced positioning.`;
                biasColor = '#8b5cf6';
            } else if (distance > 2) {
                analysis = `Price $${distance.toFixed(2)} above max pain (+${distancePct}%). Dealers selling into strength.`;
                biasIcon = '📉';
                biasColor = '#ef4444';
            } else {
                analysis = `Price $${Math.abs(distance).toFixed(2)} below max pain (${distancePct}%). Dealers buying dips.`;
                biasIcon = '📈';
                biasColor = '#10b981';
            }

            return `
                <div class="max-pain-analysis" style="margin-top: 15px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid ${biasColor};">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 1.2em;">${biasIcon}</span>
                        <strong style="color: ${biasColor};">Intraday Bias</strong>
                    </div>
                    <div style="color: #d1d5db; font-size: 0.95em;">
                        ${analysis}
                    </div>
                </div>
            `;
        }

        function renderEndOfDayRecap(recapData) {
            const section = document.createElement('div');
            section.className = 'eod-recap-section';
            section.style.marginTop = '30px';
            section.style.borderTop = '2px solid rgba(99, 102, 241, 0.3)';
            section.style.paddingTop = '25px';
            section.style.gridColumn = '1 / -1'; // Span all columns

            // Header with collapsible toggle
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '15px';

            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = `📊 End of Day Recap - ${recapData.date || 'Previous Day'}`;
            title.style.margin = '0';

            // Check if EOD data is stale (>1 day old)
            const timestamp = document.createElement('div');
            timestamp.style.fontSize = '0.85em';
            timestamp.style.marginLeft = '12px';
            let isStale = false;

            if (recapData.ranAt) {
                const eodTime = new Date(recapData.ranAt);
                const now = new Date();
                const hoursSinceEOD = (now - eodTime) / (1000 * 60 * 60);
                isStale = hoursSinceEOD > 24;

                if (isStale) {
                    timestamp.style.color = '#ef4444';
                    timestamp.style.fontWeight = '600';
                    timestamp.innerHTML = `⚠️ Stale data from ${recapData.date} - run 'wingman, eod wrap' to update`;
                } else {
                    timestamp.style.color = '#9ca3af';
                    timestamp.textContent = recapData.ranAt;
                }
            }

            // Collapsible content
            const content = document.createElement('div');
            content.id = 'eod-recap-content';
            content.style.display = 'none'; // Collapsed by default

            const toggleButton = document.createElement('button');
            toggleButton.id = 'eod-toggle-btn';
            toggleButton.style.background = 'rgba(99, 102, 241, 0.2)';
            toggleButton.style.border = '1px solid rgba(99, 102, 241, 0.4)';
            toggleButton.style.color = '#6366f1';
            toggleButton.style.padding = '6px 12px';
            toggleButton.style.borderRadius = '6px';
            toggleButton.style.cursor = 'pointer';
            toggleButton.style.fontSize = '0.9em';
            toggleButton.textContent = '▼ Show';
            toggleButton.onclick = function() {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                this.textContent = isHidden ? '▲ Hide' : '▼ Show';
            };

            header.appendChild(title);
            header.appendChild(timestamp);
            header.appendChild(toggleButton);
            section.appendChild(header);

            // Summary paragraph
            if (recapData.summary) {
                const summaryDiv = document.createElement('div');
                summaryDiv.style.background = 'rgba(99, 102, 241, 0.1)';
                summaryDiv.style.border = '1px solid rgba(99, 102, 241, 0.2)';
                summaryDiv.style.borderRadius = '8px';
                summaryDiv.style.padding = '15px';
                summaryDiv.style.marginBottom = '15px';
                summaryDiv.style.color = '#e0e6f0';
                summaryDiv.style.lineHeight = '1.6';
                summaryDiv.textContent = recapData.summary;
                content.appendChild(summaryDiv);
            }

            // Key Outcomes
            if (recapData.keyOutcomes && recapData.keyOutcomes.length) {
                const outcomesSection = document.createElement('div');
                outcomesSection.style.marginBottom = '15px';

                const outcomesTitle = document.createElement('h4');
                outcomesTitle.style.color = '#6366f1';
                outcomesTitle.style.fontSize = '1em';
                outcomesTitle.style.marginBottom = '8px';
                outcomesTitle.textContent = '🎯 Key Outcomes';
                outcomesSection.appendChild(outcomesTitle);

                const outcomesList = document.createElement('ul');
                outcomesList.style.color = '#e0e6f0';
                outcomesList.style.lineHeight = '1.7';
                outcomesList.style.marginLeft = '20px';

                recapData.keyOutcomes.forEach(outcome => {
                    const li = document.createElement('li');
                    li.textContent = outcome;
                    li.style.marginBottom = '6px';
                    outcomesList.appendChild(li);
                });

                outcomesSection.appendChild(outcomesList);
                content.appendChild(outcomesSection);
            }

            // Signals Snapshot
            if (recapData.signals) {
                const signalsSection = document.createElement('div');
                signalsSection.style.marginBottom = '15px';
                signalsSection.style.background = 'rgba(16, 185, 129, 0.1)';
                signalsSection.style.border = '1px solid rgba(16, 185, 129, 0.2)';
                signalsSection.style.borderRadius = '8px';
                signalsSection.style.padding = '12px';

                const signalsTitle = document.createElement('h4');
                signalsTitle.style.color = '#10b981';
                signalsTitle.style.fontSize = '1em';
                signalsTitle.style.marginBottom = '8px';
                signalsTitle.textContent = '📈 Signals Snapshot';
                signalsSection.appendChild(signalsTitle);

                const signalsText = document.createElement('div');
                signalsText.style.color = '#e0e6f0';
                signalsText.style.lineHeight = '1.6';
                signalsText.innerHTML = `
                    <strong>Composite:</strong> ${recapData.signals.composite || 'N/A'}/100 (${recapData.signals.tier || 'N/A'})<br>
                    <strong>Drivers:</strong> ${(recapData.signals.drivers || []).join(', ')}<br>
                    <strong>X Sentiment:</strong> ${recapData.signals.xSentiment || 'N/A'}
                `;
                signalsSection.appendChild(signalsText);
                content.appendChild(signalsSection);
            }

            // 1. Signal Score Trend (5-7 day chart)
            if (recapData.trendAnalysis && recapData.trendAnalysis.signalScoreTrend) {
                const trendSection = document.createElement('div');
                trendSection.style.marginBottom = '15px';
                trendSection.style.background = 'rgba(99, 102, 241, 0.1)';
                trendSection.style.border = '1px solid rgba(99, 102, 241, 0.2)';
                trendSection.style.borderRadius = '8px';
                trendSection.style.padding = '12px';

                const trendTitle = document.createElement('h4');
                trendTitle.style.color = '#6366f1';
                trendTitle.style.fontSize = '1em';
                trendTitle.style.marginBottom = '8px';
                trendTitle.textContent = '📊 Signal Score Trend (7-Day)';
                trendSection.appendChild(trendTitle);

                const trend = recapData.trendAnalysis.signalScoreTrend;

                // Mini chart display
                const chartContainer = document.createElement('div');
                chartContainer.style.display = 'flex';
                chartContainer.style.alignItems = 'flex-end';
                chartContainer.style.height = '60px';
                chartContainer.style.gap = '4px';
                chartContainer.style.marginBottom = '10px';

                if (trend.scores && trend.scores.length) {
                    const maxScore = Math.max(...trend.scores);
                    trend.scores.forEach((score, idx) => {
                        const bar = document.createElement('div');
                        bar.style.flex = '1';
                        bar.style.background = score >= 70 ? '#10b981' : score >= 50 ? '#6366f1' : '#f59e0b';
                        bar.style.height = `${(score / 100) * 60}px`;
                        bar.style.borderRadius = '4px 4px 0 0';
                        bar.style.position = 'relative';
                        bar.title = `Day ${idx + 1}: ${score}`;
                        chartContainer.appendChild(bar);
                    });
                }
                trendSection.appendChild(chartContainer);

                // Trend summary
                const trendSummary = document.createElement('div');
                trendSummary.style.color = '#e0e6f0';
                trendSummary.style.fontSize = '0.9em';
                trendSummary.style.lineHeight = '1.6';
                trendSummary.innerHTML = `
                    <strong>Trend:</strong> ${trend.direction || 'N/A'} (${trend.change || 'N/A'} points over 7 days)<br>
                    ${trend.tierTransitions ? `<strong>Tier Changes:</strong> ${trend.tierTransitions}<br>` : ''}
                    <strong>Analysis:</strong> ${trend.summary || 'No trend data available'}
                `;
                trendSection.appendChild(trendSummary);
                content.appendChild(trendSection);
            }

            // 3. Volatility Pattern Detection
            if (recapData.trendAnalysis && recapData.trendAnalysis.volatilityPattern) {
                const volSection = document.createElement('div');
                volSection.style.marginBottom = '15px';
                volSection.style.background = 'rgba(245, 158, 11, 0.1)';
                volSection.style.border = '1px solid rgba(245, 158, 11, 0.2)';
                volSection.style.borderRadius = '8px';
                volSection.style.padding = '12px';

                const volTitle = document.createElement('h4');
                volTitle.style.color = '#f59e0b';
                volTitle.style.fontSize = '1em';
                volTitle.style.marginBottom = '8px';
                volTitle.textContent = '⚡ Volatility Pattern';
                volSection.appendChild(volTitle);

                const vol = recapData.trendAnalysis.volatilityPattern;

                const volContent = document.createElement('div');
                volContent.style.color = '#e0e6f0';
                volContent.style.fontSize = '0.9em';
                volContent.style.lineHeight = '1.6';
                volContent.innerHTML = `
                    <strong>VIX Change:</strong> ${vol.vixChange || 'N/A'} (${vol.vixChangePercent || 'N/A'})<br>
                    <strong>Pattern:</strong> ${vol.pattern || 'Normal'} ${vol.isUnusual ? '⚠️ <span style="color: #ef4444;">UNUSUAL SPIKE</span>' : ''}<br>
                    <strong>Status:</strong> ${vol.status || 'N/A'}<br>
                    <strong>Context:</strong> ${vol.context || 'No pattern detected'}
                `;
                volSection.appendChild(volContent);
                content.appendChild(volSection);
            }

            // 4. Breadth Divergence Tracker
            if (recapData.trendAnalysis && recapData.trendAnalysis.breadthDivergence) {
                const breadthSection = document.createElement('div');
                breadthSection.style.marginBottom = '15px';
                breadthSection.style.background = 'rgba(239, 68, 68, 0.1)';
                breadthSection.style.border = '1px solid rgba(239, 68, 68, 0.2)';
                breadthSection.style.borderRadius = '8px';
                breadthSection.style.padding = '12px';

                const breadthTitle = document.createElement('h4');
                breadthTitle.style.color = '#ef4444';
                breadthTitle.style.fontSize = '1em';
                breadthTitle.style.marginBottom = '8px';
                breadthTitle.textContent = '📉 Breadth Divergence';
                breadthSection.appendChild(breadthTitle);

                const breadth = recapData.trendAnalysis.breadthDivergence;

                const breadthContent = document.createElement('div');
                breadthContent.style.color = '#e0e6f0';
                breadthContent.style.fontSize = '0.9em';
                breadthContent.style.lineHeight = '1.6';
                breadthContent.innerHTML = `
                    <strong>Status:</strong> ${breadth.isDiverging ? '<span style="color: #ef4444;">⚠️ DIVERGING</span>' : '<span style="color: #10b981;">✓ ALIGNED</span>'}<br>
                    <strong>Consecutive Days:</strong> ${breadth.consecutiveDays || 0} day(s)<br>
                    <strong>Historical Context:</strong> ${breadth.historicalContext || 'N/A'}<br>
                    <strong>Implication:</strong> ${breadth.implication || 'Monitor for potential reversal or continuation'}
                `;
                breadthSection.appendChild(breadthContent);
                content.appendChild(breadthSection);
            }

            // 5. Narrative Momentum
            if (recapData.trendAnalysis && recapData.trendAnalysis.narrativeMomentum) {
                const narrativeSection = document.createElement('div');
                narrativeSection.style.marginBottom = '15px';
                narrativeSection.style.background = 'rgba(139, 92, 246, 0.1)';
                narrativeSection.style.border = '1px solid rgba(139, 92, 246, 0.2)';
                narrativeSection.style.borderRadius = '8px';
                narrativeSection.style.padding = '12px';

                const narrativeTitle = document.createElement('h4');
                narrativeTitle.style.color = '#8b5cf6';
                narrativeTitle.style.fontSize = '1em';
                narrativeTitle.style.marginBottom = '8px';
                narrativeTitle.textContent = '🔥 Narrative Momentum';
                narrativeSection.appendChild(narrativeTitle);

                const narratives = recapData.trendAnalysis.narrativeMomentum;

                // Hot narratives
                if (narratives.hot && narratives.hot.length) {
                    const hotDiv = document.createElement('div');
                    hotDiv.style.marginBottom = '10px';
                    hotDiv.innerHTML = '<strong style="color: #10b981;">📈 Gaining Steam:</strong>';
                    const hotList = document.createElement('ul');
                    hotList.style.marginLeft = '20px';
                    hotList.style.marginTop = '5px';
                    hotList.style.color = '#e0e6f0';
                    narratives.hot.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${item.narrative}</strong> - ${item.trend} (${item.days} days)`;
                        hotList.appendChild(li);
                    });
                    hotDiv.appendChild(hotList);
                    narrativeSection.appendChild(hotDiv);
                }

                // Cooling narratives
                if (narratives.cooling && narratives.cooling.length) {
                    const coolingDiv = document.createElement('div');
                    coolingDiv.innerHTML = '<strong style="color: #f59e0b;">📉 Losing Steam:</strong>';
                    const coolingList = document.createElement('ul');
                    coolingList.style.marginLeft = '20px';
                    coolingList.style.marginTop = '5px';
                    coolingList.style.color = '#e0e6f0';
                    narratives.cooling.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${item.narrative}</strong> - ${item.trend} (${item.days} days)`;
                        coolingList.appendChild(li);
                    });
                    coolingDiv.appendChild(coolingList);
                    narrativeSection.appendChild(coolingDiv);
                }

                content.appendChild(narrativeSection);
            }

            // Actions Completed & Deferred
            if (recapData.actions) {
                const actionsSection = document.createElement('div');
                actionsSection.style.marginBottom = '15px';

                const actionsTitle = document.createElement('h4');
                actionsTitle.style.color = '#6366f1';
                actionsTitle.style.fontSize = '1em';
                actionsTitle.style.marginBottom = '8px';
                actionsTitle.textContent = '✅ Actions';
                actionsSection.appendChild(actionsTitle);

                if (recapData.actions.completed && recapData.actions.completed.length) {
                    const completedLabel = document.createElement('div');
                    completedLabel.style.color = '#10b981';
                    completedLabel.style.fontWeight = '600';
                    completedLabel.style.marginTop = '8px';
                    completedLabel.textContent = 'Completed:';
                    actionsSection.appendChild(completedLabel);

                    const completedList = document.createElement('ul');
                    completedList.style.color = '#e0e6f0';
                    completedList.style.lineHeight = '1.7';
                    completedList.style.marginLeft = '20px';
                    completedList.style.marginBottom = '8px';

                    recapData.actions.completed.forEach(action => {
                        const li = document.createElement('li');
                        li.textContent = action;
                        li.style.marginBottom = '4px';
                        completedList.appendChild(li);
                    });

                    actionsSection.appendChild(completedList);
                }

                if (recapData.actions.deferred && recapData.actions.deferred.length) {
                    const deferredLabel = document.createElement('div');
                    deferredLabel.style.color = '#f59e0b';
                    deferredLabel.style.fontWeight = '600';
                    deferredLabel.style.marginTop = '8px';
                    deferredLabel.textContent = 'Deferred:';
                    actionsSection.appendChild(deferredLabel);

                    const deferredList = document.createElement('ul');
                    deferredList.style.color = '#e0e6f0';
                    deferredList.style.lineHeight = '1.7';
                    deferredList.style.marginLeft = '20px';

                    recapData.actions.deferred.forEach(action => {
                        const li = document.createElement('li');
                        li.textContent = action;
                        li.style.marginBottom = '4px';
                        deferredList.appendChild(li);
                    });

                    actionsSection.appendChild(deferredList);
                }

                content.appendChild(actionsSection);
            }

            // Notes
            if (recapData.notes) {
                const notesDiv = document.createElement('div');
                notesDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                notesDiv.style.border = '1px solid rgba(245, 158, 11, 0.2)';
                notesDiv.style.borderRadius = '8px';
                notesDiv.style.padding = '12px';
                notesDiv.style.color = '#e0e6f0';
                notesDiv.style.lineHeight = '1.6';
                notesDiv.innerHTML = `<strong style="color: #f59e0b;">💡 Notes:</strong> ${recapData.notes}`;
                content.appendChild(notesDiv);
            }

            section.appendChild(content);
            return section;
        }

        function toggleTask(checkbox) {
            checkbox.classList.toggle('checked');
            const taskText = checkbox.nextElementSibling;
            if (checkbox.classList.contains('checked')) {
                taskText.style.textDecoration = 'line-through';
                taskText.style.opacity = '0.6';
            } else {
                taskText.style.textDecoration = 'none';
                taskText.style.opacity = '1';
            }
        }

        function renderEconomicCalendar(calendar, compact = false, updatedAt = null) {
            if (!calendar) return document.createElement('div');

            const container = document.createElement('div');
            container.className = 'economic-calendar';

            // Header
            const header = document.createElement('div');
            header.className = 'calendar-header';
            let titleHTML = '<span style="font-size: 1.5em;">📅</span><div class="calendar-title">Economic Calendar';
            if (updatedAt) {
                const statusClass = getDataFreshness(updatedAt);
                titleHTML += ` <span class="date-badge ${statusClass}" style="margin-left: 10px; display: inline-block;"></span>`;
            }
            titleHTML += '</div>';
            header.innerHTML = titleHTML;
            container.appendChild(header);

            // Summary
            if (calendar.summary) {
                const summary = document.createElement('div');
                summary.className = 'calendar-summary';
                summary.textContent = calendar.summary;
                container.appendChild(summary);
            }

            // Key Dates - MOVED TO TOP
            if (calendar.keyDates && calendar.keyDates.length > 0) {
                const keyDatesSection = document.createElement('div');
                keyDatesSection.className = 'calendar-section';

                const keyDatesHeader = document.createElement('div');
                keyDatesHeader.className = 'calendar-section-header';
                keyDatesHeader.innerHTML = '🎯 KEY DATES THIS MONTH';
                keyDatesSection.appendChild(keyDatesHeader);

                calendar.keyDates.forEach(keyDate => {
                    const card = document.createElement('div');
                    card.className = 'key-date-card';

                    const header = document.createElement('div');
                    header.className = 'key-date-header';
                    header.innerHTML = `<div class="key-date-date">${keyDate.date}</div>`;
                    card.appendChild(header);

                    const events = document.createElement('div');
                    events.className = 'key-date-events';
                    events.textContent = keyDate.events.join(' • ');
                    card.appendChild(events);

                    if (keyDate.note) {
                        const note = document.createElement('div');
                        note.className = 'key-date-note';
                        note.textContent = keyDate.note;
                        card.appendChild(note);
                    }

                    keyDatesSection.appendChild(card);
                });

                container.appendChild(keyDatesSection);
            }

            // Today's Events (only show in full view, not in compact mode)
            if (!compact && calendar.today && calendar.today.length > 0) {
                const todaySection = document.createElement('div');
                todaySection.className = 'calendar-section';

                const todayHeader = document.createElement('div');
                todayHeader.className = 'calendar-section-header';
                todayHeader.innerHTML = '🔴 TODAY';
                todaySection.appendChild(todayHeader);

                const todayEvents = document.createElement('div');
                todayEvents.className = 'calendar-events';

                calendar.today.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event impact-${event.impact}`;

                    eventDiv.innerHTML = `
                        <div class="event-time">${event.time}</div>
                        <div class="event-name">${event.event}</div>
                        <div class="event-impact ${event.impact}">${event.impact}</div>
                    `;

                    todayEvents.appendChild(eventDiv);
                });

                todaySection.appendChild(todayEvents);
                container.appendChild(todaySection);
            }

            // This Week's Events (only show in full view, not in compact mode)
            if (!compact && calendar.thisWeek && calendar.thisWeek.length > 0) {
                const weekSection = document.createElement('div');
                weekSection.className = 'calendar-section';

                const weekHeader = document.createElement('div');
                weekHeader.className = 'calendar-section-header';
                weekHeader.innerHTML = '📊 THIS WEEK';
                weekSection.appendChild(weekHeader);

                const weekEvents = document.createElement('div');
                weekEvents.className = 'calendar-events';

                calendar.thisWeek.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event impact-${event.impact}`;

                    eventDiv.innerHTML = `
                        <div class="event-time">${event.date} ${event.time}</div>
                        <div class="event-name">${event.event}</div>
                        <div class="event-impact ${event.impact}">${event.impact}</div>
                    `;

                    weekEvents.appendChild(eventDiv);
                });

                weekSection.appendChild(weekEvents);
                container.appendChild(weekSection);
            }

            // Next Week's Events (only show in full view, not in compact mode)
            if (!compact && calendar.nextWeek && calendar.nextWeek.length > 0) {
                const nextWeekSection = document.createElement('div');
                nextWeekSection.className = 'calendar-section';

                const nextWeekHeader = document.createElement('div');
                nextWeekHeader.className = 'calendar-section-header';
                nextWeekHeader.innerHTML = '📅 NEXT WEEK';
                nextWeekSection.appendChild(nextWeekHeader);

                const nextWeekEvents = document.createElement('div');
                nextWeekEvents.className = 'calendar-events';

                calendar.nextWeek.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event impact-${event.impact}`;

                    eventDiv.innerHTML = `
                        <div class="event-time">${event.date} ${event.time}</div>
                        <div class="event-name">${event.event}</div>
                        <div class="event-impact ${event.impact}">${event.impact}</div>
                    `;

                    nextWeekEvents.appendChild(eventDiv);
                });

                nextWeekSection.appendChild(nextWeekEvents);
                container.appendChild(nextWeekSection);
            }

            return container;
        }



        function getSentimentVisual(sentiment) {
            const raw = (sentiment || '').toString().trim();
            const normalized = raw.toLowerCase();
            const base = {
                emoji: '🤖',
                toneClass: 'ai-tone-neutral',
                chipClass: 'sentiment-neutral'
            };

            if (!normalized) {
                return base;
            }

            if (normalized.includes('bear')) {
                return { emoji: '🛑', toneClass: 'ai-tone-bearish', chipClass: 'sentiment-bearish' };
            }

            if (normalized.includes('bull')) {
                return { emoji: '🚀', toneClass: 'ai-tone-bullish', chipClass: 'sentiment-bullish' };
            }

            if (normalized.includes('cautious') || normalized.includes('mixed') || normalized.includes('patience')) {
                return { emoji: '🌓', toneClass: 'ai-tone-cautiously-bullish', chipClass: 'sentiment-cautiously-bullish' };
            }

            if (normalized.includes('neutral')) {
                return { emoji: '⚖️', toneClass: 'ai-tone-neutral', chipClass: 'sentiment-neutral' };
            }

            return base;
        }

        /**
         * Render News & Catalysts summary with structured sections
         * Handles: NEWS THEMES, KEY CATALYSTS (CONTRARIAN SIGNALS removed - redundant with X Sentiment tab)
         */
        function renderNewsCatalystsSummary(summaryText) {
            // Split by section headers (only NEWS THEMES and KEY CATALYSTS)
            const themesMatch = summaryText.match(/NEWS THEMES:(.*?)(?=KEY CATALYSTS:|$)/s);
            const catalystsMatch = summaryText.match(/KEY CATALYSTS:(.*?)$/s);

            let html = '<div class="summary-structured">';

            // Render NEWS THEMES section
            if (themesMatch) {
                html += renderNewsSummarySection('📰', 'NEWS THEMES', themesMatch[1].trim(), '#6366f1');
            }

            // Render KEY CATALYSTS section
            if (catalystsMatch) {
                html += renderNewsSummarySection('🚀', 'KEY CATALYSTS', catalystsMatch[1].trim(), '#f59e0b');
            }

            html += '</div>';

            // If no sections matched, fall back to original display
            if (!themesMatch && !catalystsMatch) {
                return `<div class="ai-section-body">${summaryText}</div>`;
            }

            return html;
        }

        /**
         * Render individual News & Catalysts section
         * Simpler layout than Markets Intelligence - focuses on key points
         */
        function renderNewsSummarySection(emoji, title, content, accentColor) {
            // Parse content into key points (split by periods and common delimiters)
            const sentences = content
                .split(/\.\s+/)
                .map(s => s.trim())
                .filter(s => s.length > 10); // Filter out tiny fragments

            let html = `
                <div class="summary-section" style="background: rgba(31, 41, 55, 0.4); border: 1px solid ${accentColor}40; border-radius: 12px; padding: 20px; margin-bottom: 18px;">
                    <div class="summary-section-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid ${accentColor}30;">
                        <span style="font-size: 1.4em;">${emoji}</span>
                        <span style="font-weight: 600; color: ${accentColor}; font-size: 1.05em; text-transform: uppercase; letter-spacing: 0.5px;">${title}</span>
                    </div>
                    <div class="news-points" style="display: flex; flex-direction: column; gap: 10px;">
            `;

            // Render each sentence as a point
            sentences.forEach((sentence, idx) => {
                // Add visual emphasis to first point
                const isFirst = idx === 0;
                const bgOpacity = isFirst ? '0.12' : '0.08';
                const fontWeight = isFirst ? '500' : 'normal';

                html += `
                    <div style="padding: 10px 14px; background: ${accentColor}${bgOpacity}; border-left: 3px solid ${accentColor}; border-radius: 6px; font-size: 0.92em; line-height: 1.6; color: #e0e6f0; font-weight: ${fontWeight};">
                        ${highlightNumbers(sentence)}${sentence.endsWith('.') ? '' : '.'}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        /**
         * Parse and render structured summary for better readability
         * Converts dense paragraphs into scannable sections with visual hierarchy
         * Detects format and routes to appropriate renderer
         */
        function renderStructuredSummary(summaryText) {
            if (!summaryText || typeof summaryText !== 'string') {
                return `<div class="ai-section-body">${summaryText || ''}</div>`;
            }

            // Detect format: News & Catalysts vs Markets Intelligence
            if (summaryText.includes('NEWS THEMES:') || summaryText.includes('KEY CATALYSTS:')) {
                return renderNewsCatalystsSummary(summaryText);
            }

            // Markets Intelligence format (MACRO, CRYPTO, TECH, CONSENSUS)
            const sections = [];

            // Split by section headers
            const macroMatch = summaryText.match(/MACRO ENVIRONMENT:(.*?)(?=CRYPTO MARKETS:|TECH SECTOR:|CONSENSUS ACTION:|$)/s);
            const cryptoMatch = summaryText.match(/CRYPTO MARKETS:(.*?)(?=TECH SECTOR:|CONSENSUS ACTION:|$)/s);
            const techMatch = summaryText.match(/TECH SECTOR:(.*?)(?=CONSENSUS ACTION:|$)/s);
            const consensusMatch = summaryText.match(/CONSENSUS ACTION:(.*?)$/s);

            let html = '<div class="summary-structured">';

            // Render MACRO section
            if (macroMatch) {
                html += renderSummarySection('📊', 'MACRO ENVIRONMENT', macroMatch[1].trim(), '#6366f1');
            }

            // Render CRYPTO section
            if (cryptoMatch) {
                html += renderSummarySection('₿', 'CRYPTO MARKETS', cryptoMatch[1].trim(), '#8b5cf6');
            }

            // Render TECH section
            if (techMatch) {
                html += renderSummarySection('🚀', 'TECH SECTOR', techMatch[1].trim(), '#3b82f6');
            }

            // Render CONSENSUS section
            if (consensusMatch) {
                const consensusText = consensusMatch[1].trim();
                html += `
                    <div class="summary-consensus" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 18px; margin-top: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 1.3em;">⚡</span>
                            <span style="font-weight: 600; color: #10b981; font-size: 1.05em; text-transform: uppercase; letter-spacing: 0.5px;">CONSENSUS ACTION</span>
                        </div>
                        <div style="color: #e0e6f0; line-height: 1.7; font-size: 0.98em;">
                            ${consensusText.split('.').filter(s => s.trim()).map(sentence =>
                                `<div style="margin: 6px 0; padding-left: 8px; border-left: 3px solid #10b981;">• ${sentence.trim()}</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            // If no sections matched, fall back to original display
            if (!macroMatch && !cryptoMatch && !techMatch && !consensusMatch) {
                return `<div class="ai-section-body">${summaryText}</div>`;
            }

            return html;
        }

        /**
         * Render individual summary section with bullish/bearish factors
         */
        function renderSummarySection(emoji, title, content, accentColor) {
            // Extract first line (context/subtitle)
            const lines = content.split(/\n+/);
            const firstLine = lines[0]?.trim() || '';
            const restContent = lines.slice(1).join(' ').trim();

            // Extract BULLISH factors
            const bullishMatch = restContent.match(/BULLISH:(.*?)(?=BEARISH:|STRATEGY:|$)/s);
            const bullishFactors = bullishMatch ? extractFactors(bullishMatch[1]) : [];

            // Extract BEARISH factors
            const bearishMatch = restContent.match(/BEARISH:(.*?)(?=STRATEGY:|$)/s);
            const bearishFactors = bearishMatch ? extractFactors(bearishMatch[1]) : [];

            // Extract STRATEGY
            const strategyMatch = restContent.match(/STRATEGY:(.*?)$/s);
            const strategy = strategyMatch ? strategyMatch[1].trim() : '';

            // Extract key metrics (prices, percentages) from first line
            const metrics = extractKeyMetrics(firstLine + ' ' + restContent);

            let html = `
                <div class="summary-section" style="background: rgba(31, 41, 55, 0.4); border: 1px solid ${accentColor}40; border-radius: 12px; padding: 20px; margin-bottom: 18px;">
                    <div class="summary-section-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid ${accentColor}30;">
                        <span style="font-size: 1.4em;">${emoji}</span>
                        <span style="font-weight: 600; color: ${accentColor}; font-size: 1.05em; text-transform: uppercase; letter-spacing: 0.5px;">${title}</span>
                    </div>
            `;

            // Context line
            if (firstLine) {
                html += `<div style="color: #9ca3af; font-style: italic; margin-bottom: 15px; font-size: 0.95em;">${firstLine}</div>`;
            }

            // Key metrics row
            if (metrics.length > 0) {
                html += `<div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px;">`;
                metrics.forEach(metric => {
                    html += `
                        <div class="key-metric" style="background: rgba(99, 102, 241, 0.12); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 6px; padding: 6px 12px; font-size: 0.9em;">
                            <span style="color: #6366f1; font-weight: 700;">${metric}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Bullish/Bearish factors in 2-column layout
            if (bullishFactors.length > 0 || bearishFactors.length > 0) {
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">`;

                // Bullish column
                html += `
                    <div class="bullish-factors">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
                            <span style="font-size: 0.9em;">🟢</span>
                            <span style="font-weight: 600; color: #10b981; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.3px;">Bullish</span>
                        </div>
                        ${bullishFactors.map(factor => `
                            <div style="margin: 6px 0; padding: 8px 12px; background: rgba(16, 185, 129, 0.08); border-left: 3px solid #10b981; border-radius: 4px; font-size: 0.9em; line-height: 1.5; color: #d1d5db;">
                                ${highlightNumbers(factor)}
                            </div>
                        `).join('')}
                    </div>
                `;

                // Bearish column
                html += `
                    <div class="bearish-factors">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
                            <span style="font-size: 0.9em;">🔴</span>
                            <span style="font-weight: 600; color: #ef4444; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.3px;">Bearish</span>
                        </div>
                        ${bearishFactors.map(factor => `
                            <div style="margin: 6px 0; padding: 8px 12px; background: rgba(239, 68, 68, 0.08); border-left: 3px solid #ef4444; border-radius: 4px; font-size: 0.9em; line-height: 1.5; color: #d1d5db;">
                                ${highlightNumbers(factor)}
                            </div>
                        `).join('')}
                    </div>
                `;

                html += `</div>`;
            }

            // Strategy box
            if (strategy) {
                html += `
                    <div class="strategy-box" style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; padding: 12px 15px; display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 1.1em;">📍</span>
                        <div>
                            <div style="font-weight: 600; color: #6366f1; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 5px;">Strategy</div>
                            <div style="color: #e0e6f0; font-size: 0.95em; line-height: 1.6;">${highlightNumbers(strategy)}</div>
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        /**
         * Extract bullet point factors from text
         */
        function extractFactors(text) {
            // Split by commas, semicolons, or "and"
            return text.split(/[,;]|(?:\s+and\s+)/)
                .map(f => f.trim())
                .filter(f => f.length > 5 && !f.startsWith('BEARISH') && !f.startsWith('STRATEGY'));
        }

        /**
         * Extract key metrics (prices, percentages) from text
         */
        function extractKeyMetrics(text) {
            const metrics = [];

            // BTC price
            const btcMatch = text.match(/BTC\s+\$?([\d,]+)/i);
            if (btcMatch) metrics.push(`BTC $${btcMatch[1]}`);

            // Fear & Greed
            const fgMatch = text.match(/Fear\s*&\s*Greed\s+(\d+)/i);
            if (fgMatch) metrics.push(`F&G ${fgMatch[1]}`);

            // Percentages (like +21%, 4%)
            const percMatches = [...text.matchAll(/(\+?\d+)%/g)].slice(0, 3);
            percMatches.forEach(m => {
                const context = text.substring(Math.max(0, m.index - 20), m.index).trim().split(' ').pop();
                if (context && context.length > 2) {
                    metrics.push(`${context} ${m[1]}%`);
                }
            });

            return metrics.slice(0, 4); // Limit to 4 metrics
        }

        /**
         * Parse RSS summary text into structured data by source
         * Extracts articles from each provider (MarketWatch, CoinDesk, CNBC, Seeking Alpha)
         */
        function parseRSSArticles(rss_summary) {
            if (!rss_summary || typeof rss_summary !== 'string') {
                return [];
            }

            const sources = [];
            const sourceEmojis = {
                'MarketWatch': '📊',
                'CoinDesk': '₿',
                'CNBC': '📺',
                'Seeking Alpha': '💼'
            };

            // Split by source headers (e.g., "**MarketWatch** (10 articles):")
            const sourcePattern = /\*\*([^\*]+)\*\* \((\d+) articles?\):(.*?)(?=\*\*[^\*]+\*\* \(\d+|$)/gs;
            let match;

            while ((match = sourcePattern.exec(rss_summary)) !== null) {
                const sourceName = match[1].trim();
                const articleCount = parseInt(match[2]);
                const content = match[3].trim();

                // Extract articles (lines starting with • Top Stories / • Marketplace)
                const articlePattern = /• [^\n]+\n[^\n•]+/g;
                const articles = [];
                let articleMatch;

                while ((articleMatch = articlePattern.exec(content)) !== null) {
                    let articleText = articleMatch[0]
                        .replace(/• (Top Stories|Marketplace|Top News & Analysis)\s*/g, '')
                        .replace(/\n/g, ' ')
                        .trim();

                    if (articleText && articleText.length > 10) {
                        // Parse format: "headline|URL" if URL exists
                        // Store as object with title and url properties
                        let article = { title: articleText, url: null };

                        if (articleText.includes('|')) {
                            const parts = articleText.split('|');
                            article.title = parts[0].trim();
                            article.url = parts.slice(1).join('|').trim(); // URL might contain pipes
                        }

                        articles.push(article);
                    }
                }

                // Check for "... and X more" pattern
                const moreMatch = content.match(/\.\.\. and (\d+) more/);
                const hiddenCount = moreMatch ? parseInt(moreMatch[1]) : 0;

                sources.push({
                    name: sourceName,
                    emoji: sourceEmojis[sourceName] || '📰',
                    count: articleCount,
                    articles: articles.slice(0, 5), // Show max 5 articles
                    hiddenCount: hiddenCount || Math.max(0, articleCount - articles.length)
                });
            }

            return sources;
        }

        /**
         * Get source website URL by source name
         */
        function getSourceURL(sourceName) {
            const sourceURLs = {
                'MarketWatch': 'https://www.marketwatch.com',
                'CoinDesk': 'https://www.coindesk.com',
                'CNBC': 'https://www.cnbc.com',
                'Seeking Alpha': 'https://seekingalpha.com'
            };
            return sourceURLs[sourceName] || '#';
        }

        /**
         * Render RSS summary as a clean 2x2 grid of source cards
         */
        function renderRSSSummary(rss_summary) {
            const sources = parseRSSArticles(rss_summary);

            if (sources.length === 0) {
                return `<div style="color: #9ca3af; font-style: italic; padding: 20px;">No RSS articles available</div>`;
            }

            let html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
            `;

            sources.forEach(source => {
                const displayCount = source.articles.length;
                const totalCount = source.count;

                html += `
                    <div style="background: rgba(31, 41, 55, 0.5); border: 1px solid #374151; border-radius: 10px; padding: 18px; transition: all 0.2s ease;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid #374151;">
                            <span style="font-size: 1.3em;">${source.emoji}</span>
                            <span style="font-weight: 600; color: #f3f4f6; font-size: 1.05em;">${source.name}</span>
                            <span style="margin-left: auto; background: #374151; color: #9ca3af; padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 500;">${totalCount} articles</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                `;

                // Show top articles with enhancements (tickers, emojis, highlighted numbers)
                // Each article links to actual URL if available, otherwise to source homepage
                const sourceURL = getSourceURL(source.name);

                source.articles.forEach((article, idx) => {
                    // Handle both string (legacy) and object (new) formats
                    const articleTitle = typeof article === 'object' ? article.title : article;
                    const articleURL = typeof article === 'object' && article.url ? article.url : sourceURL;

                    html += `
                        <a href="${articleURL}" target="_blank" rel="noopener noreferrer"
                           style="text-decoration: none; display: block; color: inherit;">
                            <div style="padding: 8px 10px; background: rgba(99, 102, 241, 0.06); border-left: 2px solid #6366f1; border-radius: 4px; font-size: 0.88em; line-height: 1.5; color: #d1d5db; transition: all 0.2s; cursor: pointer;"
                                 onmouseover="this.style.background='rgba(99, 102, 241, 0.12)'; this.style.borderLeft='2px solid #8b5cf6';"
                                 onmouseout="this.style.background='rgba(99, 102, 241, 0.06)'; this.style.borderLeft='2px solid #6366f1';">
                                • ${enhanceProviderInsight(articleTitle)}
                            </div>
                        </a>
                    `;
                });

                // Show "and X more" as clickable link
                if (source.hiddenCount > 0) {
                    html += `
                        <a href="${sourceURL}" target="_blank" rel="noopener noreferrer"
                           style="color: #6b7280; font-size: 0.85em; font-style: italic; padding: 5px 10px; text-decoration: none; display: block; transition: color 0.2s; cursor: pointer;"
                           onmouseover="this.style.color='#6366f1'"
                           onmouseout="this.style.color='#6b7280'">
                            ... and ${source.hiddenCount} more →
                        </a>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            return html;
        }

        /**
         * Extract ticker symbols from text
         * Looks for 2-5 uppercase letters that are likely tickers
         */
        function extractTickers(text) {
            if (!text) return [];

            // Match ticker patterns: standalone uppercase 2-5 letters, often in parentheses
            const tickerPattern = /\b([A-Z]{2,5})\b|\(([A-Z]{2,5})\)/g;
            const tickers = new Set();
            let match;

            while ((match = tickerPattern.exec(text)) !== null) {
                const ticker = match[1] || match[2];
                // Filter out common false positives
                if (ticker && !['AND', 'THE', 'FOR', 'WITH', 'FROM', 'THIS', 'THAT', 'ETF', 'USD', 'CEO', 'IPO'].includes(ticker)) {
                    tickers.add(ticker);
                }
            }

            return Array.from(tickers);
        }

        /**
         * Render ticker as clickable pill that opens TradingView
         */
        function renderTickerPill(ticker) {
            const url = `https://www.tradingview.com/chart/?symbol=${ticker}`;
            return `
                <a href="${url}" target="_blank" rel="noopener noreferrer"
                   style="display: inline-flex; align-items: center; gap: 3px; background: rgba(99, 102, 241, 0.15);
                          border: 1px solid rgba(99, 102, 241, 0.4); color: #6366f1; padding: 2px 8px;
                          border-radius: 10px; font-size: 0.8em; font-weight: 600; text-decoration: none;
                          transition: all 0.2s; cursor: pointer; font-family: monospace;">
                    <span>${ticker}</span>
                    <span style="font-size: 0.7em;">↗</span>
                </a>
            `;
        }

        /**
         * Enhance provider insight text with tickers, numbers, and emojis
         */
        function enhanceProviderInsight(text) {
            if (!text) return '';

            // Extract tickers first
            const tickers = extractTickers(text);

            // Add context emojis based on keywords
            let enhanced = text;

            // Add emojis for key terms
            enhanced = enhanced
                .replace(/\b(spillover|surge|rallies?|soar(ing)?|jump(ed)?)\b/gi, '🔥 $1')
                .replace(/\b(warning|failure|risk|decline|drop|fall)\b/gi, '⚠️ $1')
                .replace(/\b(accumulation|treasury|reserves|buying)\b/gi, '💎 $1')
                .replace(/\b(shift|structure|divergence|trend)\b/gi, '📊 $1')
                .replace(/\b(target|resistance|support|level)\b/gi, '🎯 $1');

            // Highlight numbers
            enhanced = highlightNumbers(enhanced);

            // Add ticker pills at the end if any found
            if (tickers.length > 0) {
                enhanced += '<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">';
                tickers.forEach(ticker => {
                    enhanced += renderTickerPill(ticker);
                });
                enhanced += '</div>';
            }

            return enhanced;
        }

        /**
         * Get color for tag based on category
         */
        function getTagColor(tag) {
            const tagLower = tag.toLowerCase();
            const colorMap = {
                'macro': '#6366f1',      // blue
                'fed': '#8b5cf6',        // purple
                'inflation': '#ef4444',  // red
                'volatility': '#f59e0b', // orange
                'breadth': '#10b981',    // green
                'technical': '#3b82f6',  // light blue
                'options': '#ec4899',    // pink
                'crypto': '#8b5cf6',     // purple
                'bitcoin': '#f59e0b',    // orange
                'earnings': '#10b981',   // green
                'warning': '#ef4444',    // red
                'thrust': '#10b981',     // green
                'recovery': '#10b981',   // green
                'tariffs': '#f59e0b'     // orange
            };

            return colorMap[tagLower] || '#6b7280'; // default gray
        }

        /**
         * Highlight key terms and numbers in catalyst blurbs
         */
        function highlightKeyTerms(text) {
            if (!text) return '';

            // Create a temporary placeholder to protect already-highlighted content
            let processed = text;

            // First, highlight signal tiers (most specific)
            processed = processed
                .replace(/\b(WEAK|VERY_WEAK|AVOID)\b/g, '<span style="color: #ef4444; font-weight: 600;">$1</span>')
                .replace(/\b(MODERATE)\b/g, '<span style="color: #f59e0b; font-weight: 600;">$1</span>')
                .replace(/\b(STRONG|VERY_STRONG)\b/g, '<span style="color: #10b981; font-weight: 600;">$1</span>');

            // Highlight critical terms (case insensitive, avoid re-highlighting)
            processed = processed
                .replace(/\b(critical|extreme|historical|unprecedented)\b/gi, (match) => {
                    // Don't replace if already inside a span tag
                    return `<span style="color: #ef4444; font-weight: 600;">${match}</span>`;
                })
                .replace(/\b(recovery|setup|opportunity|catalyst)\b/gi, (match) => {
                    return `<span style="color: #10b981; font-weight: 500;">${match}</span>`;
                });

            // Highlight numbers (excluding hex color codes)
            processed = processed
                // Dollar amounts
                .replace(/(?<!#|style="color: #)(\$[\d,]+\.?\d*[KMB]?)/g, '<span style="color: #10b981; font-weight: 600;">$1</span>')
                // Percentages
                .replace(/(?<!#|color: #)(\d+\.?\d*%)/g, '<span style="color: #3b82f6; font-weight: 600;">$1</span>');

            return processed;
        }

        /**
         * Highlight numbers and key terms in text
         */
        function highlightNumbers(text) {
            return text
                .replace(/(\$[\d,]+\.?\d*[KMB]?)/g, '<span style="color: #10b981; font-weight: 600;">$1</span>')
                .replace(/(\d+\.?\d*%)/g, '<span style="color: #3b82f6; font-weight: 600;">$1</span>')
                .replace(/(\d+\/\d+)/g, '<span style="color: #6366f1; font-weight: 600; font-family: monospace;">$1</span>');
        }

        function renderAIInterpretation(interpretation) {
            if (!interpretation) return '';

            const sentimentText = (interpretation.sentiment || 'Neutral').toString().trim();
            const confidenceText = (interpretation.confidence || 'Medium').toString().trim();
            const sentimentMeta = getSentimentVisual(sentimentText);
            const sentimentClass = sentimentMeta.chipClass || `sentiment-${sentimentText.toLowerCase().replace(/\s+/g, '-')}`;
            const confidenceClass = `confidence-${confidenceText.toLowerCase()}`;
            const toneClass = sentimentMeta.toneClass;
            const statusClass = getDataFreshness(interpretation.updatedAt);
            const updatedAtValue = interpretation.updatedAt ? interpretation.updatedAt : 'N/A';

            const keyInsightSection = interpretation.keyInsight
                ? `
                    <div class="ai-section ai-section-insight">
                        <div class="ai-section-title"><span>💡</span><span>Key Insight</span></div>
                        <div class="ai-section-body">${interpretation.keyInsight}</div>
                    </div>
                `
                : '';

            const summarySection = interpretation.summary
                ? `
                    <div class="ai-section ai-section-summary">
                        <div class="ai-section-title"><span>🧠</span><span>Summary Pulse</span></div>
                        ${renderStructuredSummary(interpretation.summary)}
                    </div>
                `
                : '';

            const actionSection = interpretation.action
                ? `
                    <div class="ai-section ai-section-action">
                        <div class="ai-section-title"><span>🎯</span><span>Actionable Focus</span></div>
                        <div class="ai-section-body">${interpretation.action}</div>
                    </div>
                `
                : '';

            return `
                <div class="ai-interpretation ${toneClass}">
                    <div class="ai-header">
                        <div class="ai-icon">${sentimentMeta.emoji}</div>
                        <div class="ai-header-text">
                            <div class="ai-header-title">AI Narrative Briefing</div>
                            <div class="ai-updated">
                                <span>🕒</span>
                                <span class="ai-updated-label">Status</span>
                                <span class="date-badge ${statusClass}" style="display: inline-flex; margin-left: 5px;"></span>
                            </div>
                        </div>
                        <div class="ai-stats">
                            <span class="ai-chip ai-chip-sentiment ${sentimentClass}">
                                <span>${sentimentMeta.emoji}</span>
                                <span>${sentimentText}</span>
                            </span>
                            <span class="ai-chip ai-chip-confidence ${confidenceClass}">
                                <span>🛡️</span>
                                <span>Confidence: ${confidenceText}</span>
                            </span>
                        </div>
                    </div>
                    <div class="ai-body">
                        ${keyInsightSection}
                        ${summarySection}
                        ${actionSection}
                    </div>
                </div>
            `;
        }


        function getProviderEmoji(providerName) {
            const emojiMap = {
                '42 Macro': '📊',
                'Fundstrat Capital': '📈',
                'Raoul Pal': '🌐',
                'Bankless': '🏦',
                'Unchained': '🔗',
                'Trader Mayne': '📉',
                'Franklin Templeton': '🏛️',
                'Whalemap': '🐋',
                'All-In Podcast': '🎙️',
                'Ripster , Tenet Trade Group': '💹',
                'CNBC': '📺',
                'CoinDesk': '📰',
                'MarketWatch': '📊',
                'Seeking Alpha': '💼',
                'Investing.com': '💰',
                'TradingView SPX': '📈',
                'TradingView BTC': '₿',
                'TradingView QQQ': '💻',
                'TradingView SOL': '☀️',
                'Volatility Metrics': '📊',
                'CoinGlass': '🔍',
                'Fear and Greed Index': '😱',
                'Market Breadth': '📊',
                'Gold': '🥇',
                'X Social Macro Signals': '🐦',
                'X Institutional Flows': '💼',
                'X Altcoin Rotation Signals': '🔄',
                'X Narrative Exhaustion': '⚠️',
                'X Crowd-Sourced Levels': '👥',
                'X Hype Cycle as Vol Predictor': '🎢'
            };

            return emojiMap[providerName] || '📌';
        }

        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>

<script>
(function () {
  function tryAddHeader() {
    const sec = document.querySelector('.options-intelligence-section');
    if (!sec) return false;
    if (sec.querySelector('.section-header-row')) return true; // already done

    // Title: reuse if it exists, otherwise create it
    let titleEl = sec.querySelector('.section-title');
    if (!titleEl) {
      titleEl = document.createElement('h3');
      titleEl.className = 'section-title';
      titleEl.textContent = 'Options Intelligence';
    }

    // Timestamp: from plan if available, else browser time
    let refreshedAt = new Date().toLocaleString();
    try {
      const plan = window.__PLAN_JSON__;
      const ts =
        plan &&
        plan.technicals &&
        plan.technicals.optionsData &&
        plan.technicals.optionsData.SPY &&
        plan.technicals.optionsData.SPY.lastUpdated;
      if (ts) refreshedAt = ts;
    } catch (err) { /* ignore */ }

    // Badge + header row
    const badge = document.createElement('span');
    const statusClass = getDataFreshness(refreshedAt);
    badge.className = `date-badge ${statusClass}`;
    badge.style.marginLeft = '10px';

    const headerRow = document.createElement('div');
    headerRow.className = 'section-header-row';
    headerRow.appendChild(titleEl);
    headerRow.appendChild(badge);

    // Insert at top of the section
    sec.prepend(headerRow);
    return true;
  }

  // ========================================================================
  // MARKETS INTELLIGENCE VISUAL ENHANCEMENTS
  // ========================================================================

  /**
   * Render donut chart segments - GLOBAL UTILITY FUNCTION
   * Used by Portfolio tab
   */
  window.renderDonutSegments = function(segments, cx, cy, radius, strokeWidth) {
    let svg = '';
    let currentAngle = 0;
    const circumference = 2 * Math.PI * radius;

    segments.forEach((seg, idx) => {
      const segmentAngle = (seg.value / 100) * 360;
      const segmentLength = (seg.value / 100) * circumference;
      const offset = circumference - segmentLength;

      svg += `
        <circle cx="${cx}" cy="${cy}" r="${radius}"
                fill="none"
                stroke="${seg.color}"
                stroke-width="${strokeWidth}"
                stroke-dasharray="${segmentLength} ${circumference}"
                stroke-dashoffset="${-currentAngle * (circumference / 360)}"
                style="animation: fillSegment 1s ease forwards; animation-delay: ${idx * 0.2}s; opacity: 0; filter: drop-shadow(0 0 3px ${seg.color});" />
      `;

      currentAngle += segmentAngle;
    });

    return svg;
  }

  /**
   * Render Analyst Consensus as HTML for Markets Intelligence tab
   */
  function renderConsensusAsHTML(providerConsensus, updatedAt = null) {
    const themes = providerConsensus?.themes || providerConsensus;
    if (!themes || (Array.isArray(themes) && !themes.length)) {
      return '';
    }

    const statusClass = updatedAt ? getDataFreshness(updatedAt) : '';
    const badgeHTML = updatedAt ? `<span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>` : '';

    let html = `
      <div style="flex: 1; min-width: 300px; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 10px; padding: 20px;">
        <h3 style="color: #6366f1; margin: 0 0 15px 0; font-size: 1.05em; display: flex; align-items: center;">
          🎯 Analyst Consensus ${badgeHTML}
        </h3>
    `;

    const themeArray = Array.isArray(themes) ? themes : [];
    themeArray.forEach((item, idx) => {
      const sentiment = item.sentiment || 'NEUTRAL';
      const sentimentColor = sentiment.includes('BULLISH') ? '#10b981' :
                            sentiment.includes('BEARISH') ? '#ef4444' : '#f59e0b';

      html += `
        <div style="margin-bottom: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
          <div style="display: flex; align-items: center; margin-bottom: 6px;">
            <span style="background: ${sentimentColor}20; color: ${sentimentColor}; padding: 2px 6px; border-radius: 3px; font-size: 0.65em; font-weight: 600; text-transform: uppercase; margin-right: 10px;">${sentiment.replace('_', ' ')}</span>
            <span style="font-weight: 600; color: #e0e6f0;">${item.theme || item.topic || 'Topic'}</span>
          </div>
          <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.5;">${item.description || ''}</div>
        </div>
      `;
    });

    html += '</div>';
    return html;
  }

  /**
   * Render Risk & Divergence Monitor as HTML for Markets Intelligence tab
   */
  function renderRiskAsHTML(riskItems, divergenceAlerts, updatedAt = null) {
    if ((!riskItems || !riskItems.length) && (!divergenceAlerts || !divergenceAlerts.length)) {
      return '';
    }

    const statusClass = updatedAt ? getDataFreshness(updatedAt) : '';
    const badgeHTML = updatedAt ? `<span class="date-badge ${statusClass}" style="margin-left: 10px;"></span>` : '';

    let html = `
      <div style="flex: 1; min-width: 300px; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 10px; padding: 20px;">
        <h3 style="color: #ef4444; margin: 0 0 15px 0; font-size: 1.05em; display: flex; align-items: center;">
          🚨 Risk & Divergence Monitor ${badgeHTML}
        </h3>
    `;

    // Categorize divergence alerts
    const criticalDivergences = divergenceAlerts.filter(d => d.tier === 'CRITICAL');
    const highDivergences = divergenceAlerts.filter(d => d.tier === 'HIGH');
    const mediumDivergences = divergenceAlerts.filter(d => d.tier === 'MEDIUM');

    // CRITICAL
    if (criticalDivergences.length > 0) {
      html += '<div style="margin-bottom: 12px;"><div style="color: #ef4444; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">🚨 CRITICAL DIVERGENCES</div>';
      criticalDivergences.forEach(alert => {
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px;">
            <div style="color: #fecaca; font-size: 0.85em; font-weight: 600;">${alert.theme || alert.title}</div>
            <div style="color: #d1d5db; font-size: 0.8em; margin-top: 4px;">${alert.description || ''}</div>
          </div>
        `;
      });
      html += '</div>';
    }

    // HIGH
    if (highDivergences.length > 0) {
      html += '<div style="margin-bottom: 12px;"><div style="color: #f59e0b; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">⚠️ HIGH DIVERGENCES</div>';
      highDivergences.forEach(alert => {
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; border-radius: 4px;">
            <div style="color: #fcd34d; font-size: 0.85em; font-weight: 600;">${alert.theme || alert.title}</div>
            <div style="color: #d1d5db; font-size: 0.8em; margin-top: 4px;">${alert.description || ''}</div>
          </div>
        `;
      });
      html += '</div>';
    }

    // Technical & Structural Risks
    if (riskItems.length > 0) {
      html += '<div style="margin-bottom: 0;"><div style="color: #6366f1; font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">📊 TECHNICAL & STRUCTURAL RISKS</div>';
      riskItems.forEach(risk => {
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1; border-radius: 4px;">
            <div style="color: #a5b4fc; font-size: 0.85em; font-weight: 600;">${risk.name || risk.title}</div>
            <div style="color: #d1d5db; font-size: 0.8em; margin-top: 4px;">${risk.description || ''}</div>
          </div>
        `;
      });
      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  /**
   * Render Economic Calendar with TODAY visible, everything else collapsible
   * Accepts calendar object with structure: {summary, today[], thisWeek[], nextWeek[], keyDates[]}
   */
  function renderEconomicTimelineCollapsible(calendar) {
    const id = 'econ-upcoming-' + Date.now();
    const isExpanded = localStorage.getItem(id + '-expanded') === 'true';

    let html = `
      <div style="background: rgba(31, 41, 55, 0.6); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 10px; padding: 18px; margin: 20px 0;">
        <h3 style="color: #6366f1; margin: 0 0 15px 0; font-size: 1.1em;">📅 Economic Calendar</h3>
    `;

    // Check if calendar data exists
    if (!calendar || (typeof calendar !== 'object')) {
      html += '<div style="color: #9ca3af; font-size: 0.9em;">No calendar data available</div>';
      html += '</div>';
      return html;
    }

    // Show KEY DATES first (at the very top)
    if (calendar.keyDates && calendar.keyDates.length > 0) {
      html += '<div style="margin-bottom: 15px;"><div style="color: #6366f1; font-weight: 600; margin-bottom: 8px;">🎯 KEY DATES</div>';
      calendar.keyDates.forEach(keyDate => {
        html += `
          <div style="padding: 8px; margin-bottom: 6px; background: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1; border-radius: 4px;">
            <div style="color: #e0e6f0; font-size: 0.85em; font-weight: 500;">${keyDate.date || ''}</div>
            <div style="color: #9ca3af; font-size: 0.75em; margin-top: 3px;">${(keyDate.events || []).join(' • ')}</div>
          </div>
        `;
      });
      html += '</div>';
    }

    // Show TODAY items (always visible)
    if (calendar.today && calendar.today.length > 0) {
      html += '<div style="margin-bottom: 15px;"><div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">🔴 TODAY</div>';
      calendar.today.forEach(event => {
        const impactColor = event.impact === 'HIGH' ? '#ef4444' : '#f59e0b';
        const impactBg = event.impact === 'HIGH' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)';
        html += `
          <div style="padding: 8px; margin-bottom: 6px; background: ${impactBg}; border-left: 3px solid ${impactColor}; border-radius: 4px;">
            <div style="color: #e0e6f0; font-size: 0.85em; font-weight: 500;">${event.event || ''}</div>
            <div style="color: #9ca3af; font-size: 0.75em; margin-top: 3px;">${event.time || ''} • <span style="color: ${impactColor}; font-weight: 600;">${event.impact || ''}</span></div>
          </div>
        `;
      });
      html += '</div>';
    } else {
      html += '<div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">No events today</div>';
    }

    // Check if there are any upcoming events
    const hasUpcoming =
      (calendar.thisWeek && calendar.thisWeek.length > 0) ||
      (calendar.nextWeek && calendar.nextWeek.length > 0) ||
      (calendar.keyDates && calendar.keyDates.length > 0);

    if (hasUpcoming) {
      html += `
        <div style="border-top: 1px solid rgba(99, 102, 241, 0.1); padding-top: 15px;">
          <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;" onclick="
            const content = document.getElementById('${id}-content');
            const toggle = document.getElementById('${id}-toggle');
            const expanded = content.style.display !== 'none';
            content.style.display = expanded ? 'none' : 'block';
            toggle.textContent = expanded ? '▶' : '▼';
            localStorage.setItem('${id}-expanded', expanded ? 'false' : 'true');
          " style="margin-bottom: 12px;">
            <span style="color: #6366f1; font-weight: 600;">Upcoming Events</span>
            <span id="${id}-toggle" style="color: #6366f1; font-size: 1.2em; transition: transform 0.2s;">${isExpanded ? '▼' : '▶'}</span>
          </div>
          <div id="${id}-content" style="display: ${isExpanded ? 'block' : 'none'};">
      `;

      // Render THIS WEEK events
      if (calendar.thisWeek && calendar.thisWeek.length > 0) {
        html += '<div style="margin-bottom: 12px;"><div style="color: #6366f1; font-size: 0.85em; font-weight: 600; margin-bottom: 6px;">📊 THIS WEEK</div>';
        calendar.thisWeek.forEach(event => {
          const impactColor = event.impact === 'HIGH' ? '#ef4444' : '#f59e0b';
          const impactBg = event.impact === 'HIGH' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)';
          html += `
            <div style="padding: 6px; margin-bottom: 4px; background: ${impactBg}; border-left: 2px solid ${impactColor}; border-radius: 3px;">
              <div style="color: #e0e6f0; font-size: 0.8em;">${event.event || ''}</div>
              <div style="color: #9ca3af; font-size: 0.7em; margin-top: 2px;">${event.date || ''} ${event.time || ''} • <span style="color: ${impactColor}; font-weight: 600;">${event.impact || ''}</span></div>
            </div>
          `;
        });
        html += '</div>';
      }

      // Render NEXT WEEK events
      if (calendar.nextWeek && calendar.nextWeek.length > 0) {
        html += '<div style="margin-bottom: 12px;"><div style="color: #6366f1; font-size: 0.85em; font-weight: 600; margin-bottom: 6px;">📅 NEXT WEEK</div>';
        calendar.nextWeek.forEach(event => {
          const impactColor = event.impact === 'HIGH' ? '#ef4444' : '#f59e0b';
          const impactBg = event.impact === 'HIGH' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)';
          html += `
            <div style="padding: 6px; margin-bottom: 4px; background: ${impactBg}; border-left: 2px solid ${impactColor}; border-radius: 3px;">
              <div style="color: #e0e6f0; font-size: 0.8em;">${event.event || ''}</div>
              <div style="color: #9ca3af; font-size: 0.7em; margin-top: 2px;">${event.date || ''} ${event.time || ''} • <span style="color: ${impactColor}; font-weight: 600;">${event.impact || ''}</span></div>
            </div>
          `;
        });
        html += '</div>';
      }

      html += '</div></div>';
    }

    html += '</div>';
    return html;
  }

  /**
   * Main orchestrator for Markets Intelligence tab visualization
   */
  window.renderMarketsIntelligence = function(marketsTab, allTabs) {
    if (!marketsTab || !marketsTab.sections) return '';

    let html = '<div class="markets-intelligence-dashboard" style="padding: 15px;">';

    // Mirror Daily Planner intro with AI Narrative briefing if available
    if (marketsTab.aiInterpretation) {
      html += renderAIInterpretation(marketsTab.aiInterpretation);
    }

    // ANALYST CONSENSUS + RISK & DIVERGENCE (Side-by-side at top)
    html += '<div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">';

    // Left: Analyst Consensus
    const dashboard = window.__PLAN_JSON__?.dashboard || {};
    if (dashboard.providerConsensus) {
      html += renderConsensusAsHTML(dashboard.providerConsensus, dashboard.providerConsensusUpdated);
    }

    // Right: Risk & Divergence Monitor
    if (dashboard.riskItems || dashboard.divergenceAlerts) {
      html += renderRiskAsHTML(dashboard.riskItems || [], dashboard.divergenceAlerts || [], dashboard.riskItemsUpdated);
    }

    html += '</div>';

    // Economic Calendar (positioned after Consensus/Risk, before dropdown sections)
    html += '<div style="margin: 20px 0;">';
    const macroSection = marketsTab.sections.find(s => s.name === 'Macro Environment');
    if (macroSection?.economicCalendar) {
      html += renderEconomicTimelineCollapsible(macroSection.economicCalendar);
    }
    html += '</div>';

    // Enhanced Sections (Collapsible with visual headers)
    html += renderEnhancedSections(marketsTab.sections, {});

    html += '</div>';
    return html;
  }

  /**
   * Render price levels ladder
   */
  function renderPriceLevelsSection(marketData) {
    const { crypto } = marketData;
    const currentPrice = crypto.price || 111600;
    const support = crypto.support || [107000, 109000];
    const resistance = crypto.resistance || [115000];

    let html = `
      <div class="price-levels-card glass-card" style="background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); padding: 18px; border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2);">
        <h3 style="color: #6366f1; margin-bottom: 15px; display: flex; align-items: center; font-size: 1.1em;">
          <span style="font-size: 1.3em; margin-right: 8px;">₿</span>
          BTC Key Levels
        </h3>
        <div class="price-ladder" style="position: relative; padding: 10px 0;">
    `;

    const levels = [
      ...resistance.map(p => ({ price: p, type: 'resistance', label: 'Resistance' })),
      { price: currentPrice, type: 'current', label: 'Current Price' },
      ...support.map(p => ({ price: p, type: 'support', label: 'Critical Support' }))
    ].sort((a, b) => b.price - a.price);

    levels.forEach((level, idx) => {
      const color = level.type === 'resistance' ? '#ef4444' :
                    level.type === 'support' ? '#10b981' : '#6366f1';
      const isCurrent = level.type === 'current';

      html += `
        <div style="display: flex; align-items: center; margin: 12px 0; animation: slideInRight ${0.4 + idx * 0.1}s ease forwards; opacity: 0;">
          <div style="width: 100px; font-size: 0.9em; color: ${color}; font-weight: 600;">
            $${(level.price / 1000).toFixed(0)}k
          </div>
          <div style="flex: 1; height: ${isCurrent ? '8px' : '4px'}; background: ${color}; border-radius: 4px; position: relative; ${isCurrent ? 'animation: pulseGlow 2s ease infinite;' : ''}">
            ${isCurrent ? '<div style="position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: ' + color + '; border-radius: 50%; box-shadow: 0 0 10px ' + color + ';"></div>' : ''}
          </div>
          <div style="width: 120px; font-size: 0.8em; color: #9ca3af; text-align: right; padding-left: 10px;">
            ${level.label}
          </div>
        </div>
      `;
    });

    html += `
        </div>
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(75, 85, 99, 0.3); font-size: 0.85em; color: #9ca3af;">
          <div>Support Zone: $${(support[0] / 1000).toFixed(0)}k - $${(support[support.length - 1] / 1000).toFixed(0)}k</div>
          <div style="margin-top: 5px;">Stop Loss: <span style="color: #ef4444;">$105k</span></div>
        </div>
      </div>
    `;

    return html;
  }

  /**
   * Render allocation donut chart
   */
  function renderAllocationSection(marketData) {
    const { allocation, signalScore } = marketData;
    const segments = [
      { label: 'Mega-cap Tech', value: allocation.tech, color: '#3b82f6', tickers: 'AAPL, MSFT, META, NVDA' },
      { label: 'Crypto Contrarian', value: allocation.crypto, color: '#8b5cf6', tickers: 'BTC/ETH @ $107-115k' },
      { label: 'Cash/Defensive', value: allocation.cash, color: '#10b981', tickers: 'Ready for FOMC' }
    ];

    let html = `
      <div class="allocation-card glass-card" style="background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); padding: 18px; border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2);">
        <h3 style="color: #6366f1; margin-bottom: 15px; font-size: 1.1em;">📊 Recommended Allocation</h3>
        <div style="position: relative; width: 140px; height: 140px; margin: 0 auto 15px;">
          <svg width="140" height="140" viewBox="0 0 140 140" style="transform: rotate(-90deg);">
            ${renderDonutSegments(segments, 70, 70, 50, 25)}
          </svg>
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div style="font-size: 1.8em; font-weight: bold; background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${signalScore}</div>
            <div style="font-size: 0.75em; color: #9ca3af;">SIGNAL</div>
          </div>
        </div>
        <div class="allocation-legend">
    `;

    segments.forEach(seg => {
      html += `
        <div style="display: flex; align-items: center; margin: 10px 0; animation: fadeIn 0.6s ease forwards;">
          <div style="width: 12px; height: 12px; background: ${seg.color}; border-radius: 2px; margin-right: 10px;"></div>
          <div style="flex: 1;">
            <div style="font-size: 0.9em; color: #e0e6f0; font-weight: 500;">${seg.value}% ${seg.label}</div>
            <div style="font-size: 0.75em; color: #9ca3af;">${seg.tickers}</div>
          </div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    return html;
  }

  // renderDonutSegments is now defined globally above (line 6712)

  /**
   * Render enhanced economic timeline
   */
  function renderEconomicTimelineEnhanced(calendar) {
    let html = `
      <div class="economic-timeline-card glass-card" style="background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); padding: 18px; border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2); margin: 20px 0;">
        <h3 style="color: #6366f1; margin-bottom: 15px; font-size: 1.1em;">📅 Economic Calendar</h3>
    `;

    // Render economic calendar content (reuse existing function but with enhanced styling)
    const calendarElement = renderEconomicCalendar(calendar);
    html += calendarElement.outerHTML;

    html += '</div>';
    return html;
  }

  /**
   * Render bullish vs bearish factor comparison
   */
  function renderFactorComparison(marketData) {
    const { macro } = marketData;
    const bullishWeight = (macro.bullish || []).reduce((sum, f) => sum + f.weight, 0);
    const bearishWeight = (macro.bearish || []).reduce((sum, f) => sum + f.weight, 0);
    const total = bullishWeight + bearishWeight;
    const bullishPercent = total > 0 ? Math.round((bullishWeight / total) * 100) : 50;
    const bearishPercent = 100 - bullishPercent;

    let html = `
      <div class="factor-comparison-card glass-card" style="background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); padding: 18px; border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2); margin: 20px 0;">
        <h3 style="color: #6366f1; margin-bottom: 15px; font-size: 1.1em;">⚖️ Bullish vs Bearish Factors</h3>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
          <div style="font-size: 0.9em; color: #10b981; font-weight: 600; width: 80px;">BULLISH</div>
          <div style="flex: 1; display: flex; height: 32px; border-radius: 6px; overflow: hidden; background: rgba(75, 85, 99, 0.3);">
            <div style="width: ${bullishPercent}%; background: linear-gradient(90deg, #10b981, #34d399); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9em; transition: width 1s ease;">${bullishPercent}%</div>
            <div style="width: ${bearishPercent}%; background: linear-gradient(90deg, #fbbf24, #ef4444); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9em; transition: width 1s ease;">${bearishPercent}%</div>
          </div>
          <div style="font-size: 0.9em; color: #ef4444; font-weight: 600; width: 80px; text-align: right;">BEARISH</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
    `;

    // Bullish factors
    html += '<div><div style="font-size: 0.9em; color: #10b981; font-weight: 600; margin-bottom: 10px;">✓ Bullish Signals</div>';
    (macro.bullish || []).forEach(factor => {
      html += `
        <div style="margin: 8px 0; padding: 8px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 4px; font-size: 0.85em;">
          <div style="color: #e0e6f0; font-weight: 500;">${factor.name}</div>
          <div style="color: #9ca3af; font-size: 0.9em;">${factor.value}</div>
        </div>
      `;
    });
    html += '</div>';

    // Bearish factors
    html += '<div><div style="font-size: 0.9em; color: #ef4444; font-weight: 600; margin-bottom: 10px;">⚠ Bearish Signals</div>';
    (macro.bearish || []).forEach(factor => {
      html += `
        <div style="margin: 8px 0; padding: 8px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px; font-size: 0.85em;">
          <div style="color: #e0e6f0; font-weight: 500;">${factor.name}</div>
          <div style="color: #9ca3af; font-size: 0.9em;">${factor.value}</div>
        </div>
      `;
    });
    html += '</div>';

    html += '</div></div>';
    return html;
  }

  /**
   * Render enhanced collapsible sections
   */
  function renderEnhancedSections(sections, marketData) {
    let html = '<div class="enhanced-sections" style="margin-top: 20px;">';

    sections.forEach((section, idx) => {
      const sectionId = section.name.replace(/\s+/g, '-').toLowerCase();
      const icon = section.name.includes('Macro') ? '📊' :
                   section.name.includes('Crypto') ? '₿' : '🚀';

      html += `
        <div class="section-enhanced glass-card" style="background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); padding: 0; border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2); margin-bottom: 15px; animation: fadeInUp ${0.4 + idx * 0.1}s ease forwards;">
          <div class="section-header-enhanced" onclick="toggleSection('${sectionId}')" style="padding: 15px; cursor: pointer; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 10px 10px 0 0; transition: all 0.3s ease; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 1.5em;">${icon}</span>
              <div>
                <h3 style="color: #e0e6f0; margin: 0; font-size: 1.2em;">${section.name}</h3>
              </div>
            </div>
            <div id="${sectionId}-arrow" style="font-size: 1.5em; color: #6366f1; transition: transform 0.3s ease;">▼</div>
          </div>
          <div id="${sectionId}-content" class="section-content" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease;">
            <div style="padding: 20px;">
      `;

      // Render providers
      if (section.providers && Array.isArray(section.providers)) {
        html += '<div class="provider-insights">';
        section.providers.forEach(provider => {
          html += `
            <div class="provider-card">
              <div class="provider-name">${provider.name || ''}</div>
              ${(provider.insights || []).map(insight => `<div class="key-insight">${insight}</div>`).join('')}
            </div>
          `;
        });
        html += '</div>';
      }

      // Economic calendar for Macro section
      if (section.economicCalendar) {
        const calendarElement = renderEconomicCalendar(section.economicCalendar);
        html += calendarElement.outerHTML;
      }

      html += '</div></div></div>';
    });

    html += '</div>';

    return html;
  }

  // ========================================================================
  // INITIALIZATION
  // ========================================================================

  function ready() {
    if (tryAddHeader()) return;
    const obs = new MutationObserver(function () {
      if (tryAddHeader()) obs.disconnect();
    });
    obs.observe(document.body, { childList: true, subtree: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ready);
  } else {
    ready();
  }

})();

// ========================================================================
// GLOBAL HELPER FUNCTIONS (for dynamic HTML onclick handlers)
// ========================================================================

/**
 * Toggle collapsible section in Markets Intelligence tab
 */
function toggleSection(sectionId) {
  const content = document.getElementById(sectionId + '-content');
  const arrow = document.getElementById(sectionId + '-arrow');
  if (content.style.maxHeight === '0px' || !content.style.maxHeight) {
    content.style.maxHeight = content.scrollHeight + 'px';
    arrow.style.transform = 'rotate(180deg)';
  } else {
    content.style.maxHeight = '0px';
    arrow.style.transform = 'rotate(0deg)';
  }
}

</script>



<!-- BEGIN: Loose JSON parser shim to tolerate trailing commas/comments -->
<script>
(function() {
  const originalParse = JSON.parse;
  function sanitizeLooseJson(text) {
    try {
      // Remove BOM if present
      text = text.replace(/^\uFEFF/, '');
      // Remove /* block comments */ and // line comments
      text = text.replace(/\/\*[\s\S]*?\*\//g, '')
                 .replace(/(^|\s)\/\/.*$/mg, '');
      // Remove trailing commas before } or ]
      text = text.replace(/,\s*(\}|\])/g, '$1');
      // Normalize smart quotes to plain quotes (defensive)
      text = text.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
      return text;
    } catch (e) {
      return text;
    }
  }

  JSON.parse = function(text, reviver) {
    try {
      return originalParse(text, reviver);
    } catch (e1) {
      try {
        const cleaned = sanitizeLooseJson(text);
        return originalParse(cleaned, reviver);
      } catch (e2) {
        // Surface a clearer error in the dashboard banner if available
        const banner = document.getElementById('dashboard-error');
        if (banner) {
          banner.textContent = 'Plan parsing failed. Likely trailing comma or malformed JSON in master-plan.md → tabs/macro/providers. Please remove trailing commas or fix brackets.';
          banner.style.display = 'block';
        }
        throw e2;
      }
    }
  };
})();
</script>
<!-- END: Loose JSON parser shim -->
</body>
</html>

